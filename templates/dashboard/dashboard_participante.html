{% extends "base.html" %}
{% block title %}Dashboard - Participante{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
  rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#3b82f6", // Clean Blue
          secondary: "#10b981", // Success Green
          "background-light": "#f8fafc",
          "background-dark": "#0f172a",
          "card-light": "#ffffff",
          "card-dark": "#1e293b",
        },
        fontFamily: {
          display: ["Inter", "sans-serif"],
        },
        borderRadius: {
          DEFAULT: "12px",
        },
      },
    },
  };
</script>
<style>
  body {
    font-family: 'Inter', sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<div class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen pb-24">
  <header class="px-5 pt-8 pb-4">
    <div class="flex justify-between items-start mb-6">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">
          Olá, <span class="text-primary">{{ usuario.nome.split()[0] }}</span>
        </h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">
          Encontre sua próxima atividade hoje.
        </p>
      </div>
      <button
        class="w-10 h-10 rounded-full bg-white dark:bg-card-dark shadow-sm flex items-center justify-center border border-slate-200 dark:border-slate-700 relative">
        <span class="material-icons-round text-slate-600 dark:text-slate-300">notifications</span>
        <!-- Lógica de notificação simplificada -->
        <span id="badge-notificacoes"
          class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-card-dark"
          style="display: none;"></span>
      </button>
    </div>

    <!-- Card de Inscrição Ativa (Exemplo - Pegando a última inscrição) -->
    {% if usuario.inscricoes %}
    {% set ultima_inscricao = usuario.inscricoes[-1] %}
    <div
      class="bg-white dark:bg-card-dark p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mb-6 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-primary">
        <span class="material-icons-round">assignment_ind</span>
      </div>
      <div>
        <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Inscrição Recente</p>
        <p class="font-semibold text-sm">{{ ultima_inscricao.oficina.titulo if ultima_inscricao.oficina else 'Inscrição
          no Evento' }}</p>
      </div>
      {% if ultima_inscricao.oficina %}
      <a href="{{ url_for('comprovante_routes.baixar_comprovante', oficina_id=ultima_inscricao.oficina_id) }}"
        class="ml-auto text-primary text-xs font-bold uppercase tracking-wider">Ver</a>
      {% else %}
      <a href="{{ url_for('agendamento_routes.meus_agendamentos_participante') }}"
        class="ml-auto text-primary text-xs font-bold uppercase tracking-wider">Ver</a>
      {% endif %}
    </div>
    {% endif %}

    <!-- Filtros de Categoria -->
    <div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar">
      <button onclick="filtrarCategoria('todas')"
        class="categoria-btn active whitespace-nowrap px-5 py-2.5 rounded-full bg-primary text-white text-sm font-semibold shadow-md shadow-primary/20"
        data-categoria="todas">
        Todos
      </button>

      {% set categorias = [] %}
      {% for atividade in oficinas if atividade.categoria %}
      {% if atividade.categoria not in categorias %}
      {% if categorias.append(atividade.categoria) %}{% endif %}
      {% endif %}
      {% endfor %}

      {% for categoria in categorias %}
      <button onclick="filtrarCategoria('{{ categoria }}')"
        class="categoria-btn whitespace-nowrap px-5 py-2.5 rounded-full bg-white dark:bg-card-dark text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 text-sm font-medium"
        data-categoria="{{ categoria }}">
        {{ categoria }}
      </button>
      {% endfor %}
    </div>
  </header>

  <main class="px-5 space-y-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-bold">Workshops Disponíveis</h2>
      <span class="text-xs font-medium px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded-md" id="contador-atividades">{{
        oficinas|length }} encontrados</span>
    </div>

    {% for atividade in oficinas %}
    <div
      class="atividade-card bg-white dark:bg-card-dark rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm overflow-hidden group"
      data-categoria="{{ atividade.categoria or 'todas' }}">
      <div class="p-4 flex gap-4">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            {% if atividade.categoria %}
            <span
              class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 text-[10px] font-bold rounded uppercase">{{
              atividade.categoria }}</span>
            {% endif %}
            <span class="text-[10px] font-medium text-slate-400">• {{ atividade.tipo_inscricao|capitalize if
              atividade.tipo_inscricao else 'Oficina' }}</span>
          </div>
          <h3 class="font-bold text-slate-800 dark:text-white leading-snug mb-3">{{ atividade.titulo }}</h3>
          <div class="grid grid-cols-2 gap-y-2">
            {% if atividade.dias %}
            {% set primeira_data = atividade.dias[0] %}
            <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
              <span class="material-icons-round text-sm">calendar_today</span>
              <span class="text-xs">{{ primeira_data.data.strftime('%d %b, %Y') }}</span>
            </div>
            <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
              <span class="material-icons-round text-sm">schedule</span>
              <span class="text-xs">
                {{ primeira_data.horario_inicio if primeira_data.horario_inicio is string else
                primeira_data.horario_inicio.strftime('%H:%M') }}
                -
                {{ primeira_data.horario_fim if primeira_data.horario_fim is string else
                primeira_data.horario_fim.strftime('%H:%M') }}
              </span>
            </div>
            {% endif %}

            <!-- Lógica de Vagas -->
            <div class="flex items-center gap-2 text-secondary font-medium col-span-2 mt-1">
              <span class="material-icons-round text-sm">group</span>
              <span class="text-xs">
                {% if atividade.vagas_restantes is not none %}
                {{ atividade.vagas_restantes }} vagas restantes
                {% else %}
                Inscrições Abertas
                {% endif %}
              </span>
            </div>
          </div>

          <!-- Detalhes Expansíveis -->
          <div id="detalhes-{{ atividade.id }}"
            class="hidden mt-4 pt-4 border-t border-slate-100 dark:border-slate-800 text-sm text-slate-600 dark:text-slate-400">
            <p class="mb-2">{{ atividade.descricao }}</p>
            {% if atividade.ministrantes %}
            <p class="font-semibold">Ministrantes: <span class="font-normal">{{ atividade.ministrantes|join(', ')
                }}</span></p>
            {% endif %}
          </div>

        </div>
        <div
          class="flex flex-col justify-between border-l border-slate-100 dark:border-slate-800 pl-4 items-center gap-2">
          <button onclick="toggleDetalhes('{{ atividade.id }}')"
            class="text-slate-400 hover:text-primary transition-colors" title="Ver detalhes">
            <span class="material-icons-round">expand_more</span>
          </button>

          {% if atividade.inscrito %}
          <button onclick="toggleInscricao('{{ atividade.id }}', 'cancelar')"
            class="bg-red-100 text-red-600 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-red-200 transition-all active:scale-95"
            title="Cancelar Inscrição">
            <span class="material-icons-round">remove_circle_outline</span>
          </button>
          {% elif atividade.disponivel_para_inscricao %}
          <button onclick="toggleInscricao('{{ atividade.id }}', 'inscrever')"
            class="bg-secondary hover:bg-emerald-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-secondary/20 transition-all active:scale-95"
            title="Inscrever-se">
            <span class="material-icons-round">add_circle_outline</span>
          </button>
          {% else %}
          <button onclick="mostrarMotivoIndisponibilidade('{{ atividade.motivo_indisponibilidade }}')"
            class="bg-gray-100 text-gray-400 hover:bg-gray-200 w-12 h-12 rounded-2xl flex items-center justify-center transition-all"
            title="Indisponível">
            <span class="material-icons-round">block</span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Mensagem quando não há atividades -->
    <div id="no-activities-msg" class="hidden text-center py-10 text-slate-500">
      <span class="material-icons-round text-4xl mb-2">event_busy</span>
      <p>Nenhuma atividade encontrada nesta categoria.</p>
    </div>

  </main>

  <nav
    class="fixed bottom-0 left-0 right-0 bg-white dark:bg-card-dark border-t border-slate-200 dark:border-slate-800 px-6 py-3 flex justify-between items-center z-50">
    <button class="flex flex-col items-center gap-1 text-primary">
      <span class="material-icons-round">explore</span>
      <span class="text-[10px] font-bold">Explorar</span>
    </button>
    <a href="{{ url_for('participante_routes.minhas_inscricoes') }}"
      class="flex flex-col items-center gap-1 text-slate-400 dark:text-slate-500">
      <span class="material-icons-round">bookmark_border</span>
      <span class="text-[10px] font-medium">Inscrições</span>
    </a>
    <a href="{{ url_for('participante_routes.meus_certificados') }}"
      class="flex flex-col items-center gap-1 text-slate-400 dark:text-slate-500">
      <span class="material-icons-round">receipt_long</span>
      <span class="text-[10px] font-medium">Comprovantes</span>
    </a>
    <a href="{{ url_for('participante_routes.meu_perfil') }}"
      class="flex flex-col items-center gap-1 text-slate-400 dark:text-slate-500">
      <span class="material-icons-round">person_outline</span>
      <span class="text-[10px] font-medium">Perfil</span>
    </a>
  </nav>

  <div class="fixed bottom-24 right-5">
    <a href="{{ url_for('agendamento_routes.meus_agendamentos_participante') }}"
      class="bg-primary text-white flex items-center gap-2 px-4 py-3 rounded-2xl shadow-xl shadow-primary/30 active:scale-95 transition-transform no-underline hover:text-white">
      <span class="material-icons-round">calendar_month</span>
      <span class="font-bold text-sm">Meus Agendamentos</span>
    </a>
  </div>
</div>

<script>
  function filtrarCategoria(categoria) {
    // Atualizar estado dos botões
    document.querySelectorAll('.categoria-btn').forEach(btn => {
      if (btn.dataset.categoria === categoria) {
        btn.className = 'categoria-btn active whitespace-nowrap px-5 py-2.5 rounded-full bg-primary text-white text-sm font-semibold shadow-md shadow-primary/20';
      } else {
        btn.className = 'categoria-btn whitespace-nowrap px-5 py-2.5 rounded-full bg-white dark:bg-card-dark text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 text-sm font-medium';
      }
    });

    // Filtrar cards
    let visibleCount = 0;
    document.querySelectorAll('.atividade-card').forEach(card => {
      if (categoria === 'todas' || card.dataset.categoria === categoria) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Atualizar contador e mensagem de vazio
    document.getElementById('contador-atividades').textContent = `${visibleCount} encontrados`;

    const noMsg = document.getElementById('no-activities-msg');
    if (visibleCount === 0) {
      noMsg.classList.remove('hidden');
    } else {
      noMsg.classList.add('hidden');
    }
  }
  function toggleDetalhes(id) {
    const el = document.getElementById(`detalhes-${id}`);
    if (el.classList.contains('hidden')) {
      el.classList.remove('hidden');
    } else {
      el.classList.add('hidden');
    }
  }

  function mostrarMotivoIndisponibilidade(motivo) {
    Swal.fire({
      icon: 'info',
      title: 'Não é possível realizar a inscrição',
      text: motivo || 'Esta atividade não está disponível para inscrição no momento.',
      confirmButtonColor: '#3b82f6',
      confirmButtonText: 'Entendi',
      background: '#ffffff',
      color: '#1e293b',
      customClass: {
        popup: 'rounded-2xl',
        confirmButton: 'rounded-xl px-6 py-2'
      }
    });
  }

  function toggleInscricao(oficinaId, acao) {
    const url = acao === 'inscrever'
      ? "{{ url_for('participante_routes.inscrever', oficina_id=0) }}".replace('0', oficinaId)
      : "{{ url_for('participante_routes.cancelar_inscricao', oficina_id=0) }}".replace('0', oficinaId);
    const csrfToken = document.querySelector('meta[name=\"csrf-token\"]')?.getAttribute('content') || '';

    // Mostrar loading
    Swal.fire({
      title: 'Processando...',
      didOpen: () => {
        Swal.showLoading();
      },
      background: '#ffffff',
      color: '#1e293b',
      showConfirmButton: false,
      allowOutsideClick: false,
      customClass: {
        popup: 'rounded-2xl'
      }
    });

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Sucesso!',
            text: data.message || (acao === 'inscrever' ? 'Inscrição realizada!' : 'Inscrição cancelada!'),
            confirmButtonColor: '#10b981',
            confirmButtonText: 'OK',
            background: '#ffffff',
            color: '#1e293b',
            customClass: {
              popup: 'rounded-2xl',
              confirmButton: 'rounded-xl px-6 py-2'
            }
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: data.message || 'Erro ao processar solicitação',
            confirmButtonColor: '#f59e0b',
            confirmButtonText: 'OK',
            background: '#ffffff',
            color: '#1e293b',
            customClass: {
              popup: 'rounded-2xl',
              confirmButton: 'rounded-xl px-6 py-2'
            }
          });
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: 'Erro ao comunicar com o servidor',
          confirmButtonColor: '#ef4444',
          confirmButtonText: 'OK',
          background: '#ffffff',
          color: '#1e293b',
          customClass: {
            popup: 'rounded-2xl',
            confirmButton: 'rounded-xl px-6 py-2'
          }
        });
      });
  }
</script>
{% endblock %}
