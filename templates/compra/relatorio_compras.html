{% extends "base.html" %}

{% block title %}Relat√≥rios de Compras{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">üìä Relat√≥rios de Compras</h2>
                    <p class="text-muted mb-0">An√°lise e relat√≥rios detalhados das compras realizadas</p>
                </div>
                <div>
                    <button type="button" class="btn btn-success me-2" onclick="exportarRelatorio()">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <button type="button" class="btn btn-danger me-2" onclick="exportarPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                    <a href="{{ url_for('compra_routes.gerenciar_compras') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Avan√ßados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Filtros de Relat√≥rio</h5>
                </div>
                <div class="card-body">
                    <form method="GET" id="filtroRelatorioForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="periodo" class="form-label">Per√≠odo</label>
                                <select name="periodo" id="periodo" class="form-select">
                                    <option value="personalizado" {% if request.args.get('periodo') == 'personalizado' %}selected{% endif %}>Personalizado</option>
                                    <option value="hoje" {% if request.args.get('periodo') == 'hoje' %}selected{% endif %}>Hoje</option>
                                    <option value="semana" {% if request.args.get('periodo') == 'semana' %}selected{% endif %}>Esta Semana</option>
                                    <option value="mes" {% if request.args.get('periodo') == 'mes' %}selected{% endif %}>Este M√™s</option>
                                    <option value="trimestre" {% if request.args.get('periodo') == 'trimestre' %}selected{% endif %}>Este Trimestre</option>
                                    <option value="ano" {% if request.args.get('periodo') == 'ano' %}selected{% endif %}>Este Ano</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="data-inicio-container">
                                <label for="data_inicio" class="form-label">Data In√≠cio</label>
                                <input type="date" name="data_inicio" id="data_inicio" class="form-control" 
                                       value="{{ request.args.get('data_inicio', '') }}">
                            </div>
                            <div class="col-md-3" id="data-fim-container">
                                <label for="data_fim" class="form-label">Data Fim</label>
                                <input type="date" name="data_fim" id="data_fim" class="form-control" 
                                       value="{{ request.args.get('data_fim', '') }}">
                            </div>
                            <div class="col-md-3">
                                <label for="polo_id" class="form-label">Polo</label>
                                <select name="polo_id" id="polo_id" class="form-select">
                                    <option value="">Todos os Polos</option>
                                    {% for polo in polos %}
                                    <option value="{{ polo.id }}" {% if request.args.get('polo_id') == polo.id|string %}selected{% endif %}>
                                        {{ polo.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select name="status" id="status" class="form-select">
                                    <option value="">Todos os Status</option>
                                    <option value="pendente" {% if request.args.get('status') == 'pendente' %}selected{% endif %}>Pendente</option>
                                    <option value="aprovada" {% if request.args.get('status') == 'aprovada' %}selected{% endif %}>Aprovada</option>
                                    <option value="rejeitada" {% if request.args.get('status') == 'rejeitada' %}selected{% endif %}>Rejeitada</option>
                                    <option value="finalizada" {% if request.args.get('status') == 'finalizada' %}selected{% endif %}>Finalizada</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="tipo_gasto" class="form-label">Tipo de Gasto</label>
                                <select name="tipo_gasto" id="tipo_gasto" class="form-select">
                                    <option value="">Todos os Tipos</option>
                                    <option value="custeio" {% if request.args.get('tipo_gasto') == 'custeio' %}selected{% endif %}>Custeio</option>
                                    <option value="capital" {% if request.args.get('tipo_gasto') == 'capital' %}selected{% endif %}>Capital</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="categoria_material" class="form-label">Categoria de Material</label>
                                <select name="categoria_material" id="categoria_material" class="form-select">
                                    <option value="">Todas as Categorias</option>
                                    {% for categoria in categorias_materiais %}
                                    <option value="{{ categoria }}" {% if request.args.get('categoria_material') == categoria %}selected{% endif %}>
                                        {{ categoria }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="tipo_documento" class="form-label">Tipo de Documento</label>
                                <select name="tipo_documento" id="tipo_documento" class="form-select">
                                    <option value="">Todos os Tipos</option>
                                    <option value="nota_fiscal" {% if request.args.get('tipo_documento') == 'nota_fiscal' %}selected{% endif %}>Nota Fiscal</option>
                                    <option value="cupom_fiscal" {% if request.args.get('tipo_documento') == 'cupom_fiscal' %}selected{% endif %}>Cupom Fiscal</option>
                                    <option value="recibo" {% if request.args.get('tipo_documento') == 'recibo' %}selected{% endif %}>Recibo</option>
                                    <option value="boleto" {% if request.args.get('tipo_documento') == 'boleto' %}selected{% endif %}>Boleto</option>
                                    <option value="outros" {% if request.args.get('tipo_documento') == 'outros' %}selected{% endif %}>Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <label for="fornecedor" class="form-label">Fornecedor</label>
                                <input type="text" name="fornecedor" id="fornecedor" class="form-control" 
                                       placeholder="Nome do fornecedor" 
                                       value="{{ request.args.get('fornecedor', '') }}">
                            </div>
                            <div class="col-md-3">
                                <label for="valor_min" class="form-label">Valor M√≠nimo</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" name="valor_min" id="valor_min" class="form-control" 
                                           step="0.01" min="0" placeholder="0,00" 
                                           value="{{ request.args.get('valor_min', '') }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="valor_max" class="form-label">Valor M√°ximo</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" name="valor_max" id="valor_max" class="form-control" 
                                           step="0.01" min="0" placeholder="0,00" 
                                           value="{{ request.args.get('valor_max', '') }}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="numero_documento" class="form-label">N√∫mero do Documento</label>
                                <input type="text" name="numero_documento" id="numero_documento" class="form-control" 
                                       placeholder="N√∫mero do documento" 
                                       value="{{ request.args.get('numero_documento', '') }}">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="ordenacao" class="form-label">Ordenar por</label>
                                <select name="ordenacao" id="ordenacao" class="form-select">
                                    <option value="data_desc" {% if request.args.get('ordenacao') == 'data_desc' %}selected{% endif %}>Data (Mais Recente)</option>
                                    <option value="data_asc" {% if request.args.get('ordenacao') == 'data_asc' %}selected{% endif %}>Data (Mais Antiga)</option>
                                    <option value="valor_desc" {% if request.args.get('ordenacao') == 'valor_desc' %}selected{% endif %}>Valor (Maior)</option>
                                    <option value="valor_asc" {% if request.args.get('ordenacao') == 'valor_asc' %}selected{% endif %}>Valor (Menor)</option>
                                    <option value="fornecedor" {% if request.args.get('ordenacao') == 'fornecedor' %}selected{% endif %}>Fornecedor (A-Z)</option>
                                    <option value="polo" {% if request.args.get('ordenacao') == 'polo' %}selected{% endif %}>Polo (A-Z)</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search"></i> Gerar Relat√≥rio
                                </button>
                                <a href="{{ url_for('compra_routes.relatorio_compras') }}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Limpar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo Estat√≠stico -->
    {% if compras %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ estatisticas.total_compras }}</h4>
                            <p class="mb-0">Total de Compras</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">R$ {{ estatisticas.valor_total|number_format(2, ',', '.') }}</h4>
                            <p class="mb-0">Valor Total</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">R$ {{ estatisticas.valor_medio|number_format(2, ',', '.') }}</h4>
                            <p class="mb-0">Valor M√©dio</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calculator fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ estatisticas.total_fornecedores }}</h4>
                            <p class="mb-0">Fornecedores</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-store fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Compras por M√™s</h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoComprasMes" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Compras por Polo</h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoComprasPolo" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Resultados -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Relat√≥rio Detalhado</h5>
                    <span class="badge bg-primary">{{ compras|length }} registros</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabelaRelatorio">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Polo</th>
                                    <th>Fornecedor</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Documentos</th>
                                    <th>Presta√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for compra in compras %}
                                <tr>
                                    <td>{{ compra.data_compra.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ compra.polo.nome }}</td>
                                    <td>{{ compra.fornecedor }}</td>
                                    <td>{{ compra.descricao[:50] }}{% if compra.descricao|length > 50 %}...{% endif %}</td>
                                    <td>R$ {{ compra.valor_total|number_format(2, ',', '.') }}</td>
                                    <td>
                                        {% if compra.status == 'pendente' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif compra.status == 'aprovada' %}
                                            <span class="badge bg-success">Aprovada</span>
                                        {% elif compra.status == 'rejeitada' %}
                                            <span class="badge bg-danger">Rejeitada</span>
                                        {% elif compra.status == 'finalizada' %}
                                            <span class="badge bg-info">Finalizada</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ compra.documentos|length }}</span>
                                    </td>
                                    <td>
                                        {% if compra.prestacao_contas %}
                                            {% if compra.prestacao_contas.status == 'aprovada' %}
                                                <span class="badge bg-success">Aprovada</span>
                                            {% elif compra.prestacao_contas.status == 'rejeitada' %}
                                                <span class="badge bg-danger">Rejeitada</span>
                                            {% else %}
                                                <span class="badge bg-warning">Pendente</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">N√£o Enviada</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum dado encontrado</h5>
                    <p class="text-muted">Ajuste os filtros para gerar o relat√≥rio ou verifique se h√° compras cadastradas no per√≠odo selecionado.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Controle de exibi√ß√£o dos campos de data
document.getElementById('periodo').addEventListener('change', function() {
    const periodo = this.value;
    const dataInicioContainer = document.getElementById('data-inicio-container');
    const dataFimContainer = document.getElementById('data-fim-container');
    
    if (periodo === 'personalizado') {
        dataInicioContainer.style.display = 'block';
        dataFimContainer.style.display = 'block';
    } else {
        dataInicioContainer.style.display = 'none';
        dataFimContainer.style.display = 'none';
    }
});

// Fun√ß√£o para aplicar filtros
function aplicarFiltros() {
    const form = document.getElementById('filtroRelatorioForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    // Adicionar apenas par√¢metros com valores
    for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
            params.append(key, value);
        }
    }
    
    // Redirecionar com os par√¢metros
    window.location.href = '{{ url_for("compra_routes.relatorios_compras") }}?' + params.toString();
}

// Fun√ß√£o para limpar filtros
function limparFiltros() {
    window.location.href = '{{ url_for("compra_routes.relatorios_compras") }}';
}

// Inicializar controle de per√≠odo
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('periodo').dispatchEvent(new Event('change'));
    
    {% if compras %}
    // Gr√°fico de compras por m√™s
    const ctxMes = document.getElementById('graficoComprasMes').getContext('2d');
    new Chart(ctxMes, {
        type: 'line',
        data: {
            labels: {{ graficos.meses|tojson }},
            datasets: [{
                label: 'Valor das Compras',
                data: {{ graficos.valores_mes|tojson }},
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            }
        }
    });

    // Gr√°fico de compras por polo
    const ctxPolo = document.getElementById('graficoComprasPolo').getContext('2d');
    new Chart(ctxPolo, {
        type: 'doughnut',
        data: {
            labels: {{ graficos.polos|tojson }},
            datasets: [{
                data: {{ graficos.valores_polo|tojson }},
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': R$ ' + context.parsed.toLocaleString('pt-BR');
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});

function exportarRelatorio() {
    const params = new URLSearchParams(window.location.search);
    params.set('formato', 'excel');
    window.open(`{{ url_for('compra_routes.exportar_relatorio') }}?${params.toString()}`);
}

function exportarPDF() {
    const params = new URLSearchParams(window.location.search);
    params.set('formato', 'pdf');
    window.open(`{{ url_for('compra_routes.exportar_relatorio') }}?${params.toString()}`);
}
</script>
{% endblock %}