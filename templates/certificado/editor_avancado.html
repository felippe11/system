<!DOCTYPE html>
<html class="light" lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>AppFiber - Editor de Certificados Profissional</title>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#2563eb",
            "background-light": "#f8fafc",
            "background-dark": "#0f172a",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "0.5rem",
          },
        },
      },
    };
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .canvas-bg {
      background-image:
        linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .dark .canvas-bg {
      background-image:
        linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
    }

    .certificate-shadow {
      box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body
  class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex flex-col overflow-hidden">
  <header
    class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 flex items-center justify-between px-6 z-20">
    <div class="flex items-center gap-8">
      <div class="flex items-center gap-1 font-bold text-2xl tracking-tight">
        <span class="text-slate-900 dark:text-white">App</span><span class="text-primary">Fiber</span>
      </div>
      <nav class="hidden md:flex items-center gap-1">
        <a href="{{ url_for('dashboard_routes.dashboard_cliente') }}"
          class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg flex items-center gap-2 transition-colors">
          <span class="material-icons-round text-lg">dashboard</span>
          Dashboard
        </a>
        <a href="{{ url_for('dashboard_routes.dashboard_cliente') }}"
          class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg flex items-center gap-2 transition-colors">
          <span class="material-icons-round text-lg">calendar_today</span>
          Meus Eventos
        </a>
      </nav>
    </div>
    <div class="flex items-center gap-3">
      <button
        class="px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
        Revisores
      </button>
      <div class="h-8 w-[1px] bg-slate-200 dark:bg-slate-800 mx-2"></div>
      <a href="{{ url_for('auth_routes.logout') }}"
        class="text-slate-500 hover:text-red-500 flex items-center gap-2 text-sm font-medium transition-colors">
        <span class="material-icons-round text-lg">logout</span>
        Sair
      </a>
    </div>
  </header>
  <section
    class="h-14 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-4 flex items-center justify-between z-10">
    <div class="flex items-center gap-2">
      <span class="text-lg">üé®</span>
      <h1 class="font-semibold text-slate-800 dark:text-slate-200">Editor de Certificados</h1>
      <span class="text-slate-400 mx-2">/</span>
      <span class="text-sm text-slate-500">{% if template %}{{ template.titulo }}{% else %}Novo Template{% endif
        %}</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg p-1 mr-4">
        <button
          class="p-1.5 hover:bg-white dark:hover:bg-slate-700 rounded shadow-sm text-slate-600 dark:text-slate-400 transition-all">
          <span class="material-icons-round">undo</span>
        </button>
        <button
          class="p-1.5 hover:bg-white dark:hover:bg-slate-700 rounded shadow-sm text-slate-600 dark:text-slate-400 transition-all">
          <span class="material-icons-round">redo</span>
        </button>
      </div>
      <button
        class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
        <span class="material-icons-round text-lg">visibility</span>
        Pr√©-visualizar
      </button>
      <button
        class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
        <span class="material-icons-round text-lg">play_circle</span>
        Preview ao Vivo
      </button>
      <button
        class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
        <span class="material-icons-round text-lg">download</span>
        Exportar
      </button>
      <button onclick="salvarTemplate()"
        class="flex items-center gap-2 px-4 py-1.5 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm">
        <span class="material-icons-round text-lg">save</span>
        Salvar
      </button>
    </div>
  </section>
  <main class="flex-1 flex overflow-hidden">
    <aside class="w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col">
      <div class="flex-1 overflow-y-auto p-4 space-y-6">
        <div class="relative">
          <span class="material-icons-round absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
          <input
            class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-sm focus:ring-2 focus:ring-primary"
            placeholder="Buscar elementos..." type="text" />
        </div>
        <section>
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-1">Texto</h3>
          <div class="space-y-2">
            <button draggable="true" ondragstart="handleDragStart(event)" data-type="text" data-subtype="title"
              class="w-full text-left px-3 py-3 border border-slate-100 dark:border-slate-800 hover:border-primary dark:hover:border-primary rounded-lg group transition-all cursor-move">
              <div class="font-bold text-lg dark:text-white">T√≠tulo</div>
              <div class="text-xs text-slate-400 group-hover:text-primary transition-colors">Adicionar cabe√ßalho</div>
            </button>
            <button draggable="true" ondragstart="handleDragStart(event)" data-type="text" data-subtype="subtitle"
              class="w-full text-left px-3 py-3 border border-slate-100 dark:border-slate-800 hover:border-primary dark:hover:border-primary rounded-lg group transition-all cursor-move">
              <div class="font-semibold text-base dark:text-white">Subt√≠tulo</div>
              <div class="text-xs text-slate-400 group-hover:text-primary transition-colors">Adicionar subt√≠tulo</div>
            </button>
            <button draggable="true" ondragstart="handleDragStart(event)" data-type="text" data-subtype="paragraph"
              class="w-full text-left px-3 py-2 border border-slate-100 dark:border-slate-800 hover:border-primary dark:hover:border-primary rounded-lg group transition-all cursor-move">
              <div class="text-sm dark:text-white">Par√°grafo</div>
              <div class="text-xs text-slate-400 group-hover:text-primary transition-colors">Corpo do texto</div>
            </button>
          </div>
        </section>
        <div class="grid grid-cols-2 gap-2">
          <button
            class="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
            <span class="material-icons-round text-primary mb-1">category</span>
            <span class="text-xs font-medium">Elementos</span>
          </button>
          <button
            class="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
            <span class="material-icons-round text-primary mb-1">dashboard_customize</span>
            <span class="text-xs font-medium">Templates</span>
          </button>
          <button
            class="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
            <span class="material-icons-round text-primary mb-1">cloud_upload</span>
            <span class="text-xs font-medium">Uploads</span>
          </button>
          <button draggable="true" ondragstart="handleDragStart(event)" data-type="qrcode"
            class="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-move">
            <span class="material-icons-round text-primary mb-1">qr_code_2</span>
            <span class="text-xs font-medium">QR Code</span>
          </button>
          <button draggable="true" ondragstart="handleDragStart(event)" data-type="image"
            class="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-move">
            <span class="material-icons-round text-primary mb-1">image</span>
            <span class="text-xs font-medium">M√≠dia</span>
          </button>
          <button draggable="true" ondragstart="handleDragStart(event)" data-type="signature"
            class="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-move">
            <span class="material-icons-round text-primary mb-1">gesture</span>
            <span class="text-xs font-medium">Assinatura</span>
          </button>
        </div>
        <section class="mt-8 border-t border-slate-100 dark:border-slate-800 pt-4">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-1">Camadas</h3>
          <div class="space-y-1">
            <div
              class="flex items-center gap-2 p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg text-xs cursor-pointer">
              <span class="material-icons-round text-sm text-slate-400">title</span>
              <span>Nome do Participante</span>
            </div>
            <div
              class="flex items-center gap-2 p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg text-xs cursor-pointer">
              <span class="material-icons-round text-sm text-slate-400">text_snippet</span>
              <span>Texto de Conclus√£o</span>
            </div>
            <div
              class="flex items-center gap-2 p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg text-xs cursor-pointer">
              <span class="material-icons-round text-sm text-slate-400">image</span>
              <span>Logotipo Empresa</span>
            </div>
          </div>
        </section>
      </div>
    </aside>
    <section
      class="flex-1 canvas-bg relative flex flex-col items-center justify-center overflow-auto p-12 bg-slate-50 dark:bg-slate-950">
      <div
        class="absolute bottom-6 right-6 flex items-center bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-full shadow-lg p-1 z-10">
        <button class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full">
          <span class="material-icons-round text-lg">remove</span>
        </button>
        <span class="px-3 text-sm font-medium">85%</span>
        <button class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full">
          <span class="material-icons-round text-lg">add</span>
        </button>
        <div class="w-[1px] h-4 bg-slate-200 dark:bg-slate-800 mx-1"></div>
        <button class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full">
          <span class="material-icons-round text-lg">fullscreen</span>
        </button>
      </div>
      <div id="editor-canvas"
        class="relative aspect-[1.414/1] w-full max-w-4xl bg-white certificate-shadow rounded-sm overflow-hidden border-4 border-slate-200 dark:border-slate-700">
        <div class="absolute inset-0 border-[0.5px] border-dashed border-blue-400/20 pointer-events-none"></div>
        <div class="absolute left-1/2 inset-y-0 border-l-[0.5px] border-dashed border-blue-400/20 pointer-events-none">
        </div>
        <div class="absolute top-1/2 inset-x-0 border-t-[0.5px] border-dashed border-blue-400/20 pointer-events-none">
        </div>
        <div
          class="absolute inset-12 border-2 border-slate-100 flex flex-col items-center text-center p-8 bg-slate-50/10">
          <div class="mb-12">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
              <span class="material-icons-round text-3xl text-primary">verified</span>
            </div>
            <h2 class="text-4xl font-serif text-slate-800 uppercase tracking-[0.2em] mb-2">Certificado</h2>
            <div class="w-24 h-1 bg-primary mx-auto"></div>
          </div>
          <p class="text-slate-500 font-medium italic mb-8">Este certificado √© concedido a</p>
          <div class="relative group cursor-move">
            <div class="absolute -inset-2 border-2 border-primary rounded-sm opacity-100">
              <div class="absolute -top-1.5 -left-1.5 w-3 h-3 bg-white border-2 border-primary"></div>
              <div class="absolute -top-1.5 -right-1.5 w-3 h-3 bg-white border-2 border-primary"></div>
              <div class="absolute -bottom-1.5 -left-1.5 w-3 h-3 bg-white border-2 border-primary"></div>
              <div class="absolute -bottom-1.5 -right-1.5 w-3 h-3 bg-white border-2 border-primary"></div>
              <div
                class="absolute -top-10 left-1/2 -translate-x-1/2 bg-primary text-white text-[10px] px-2 py-1 rounded whitespace-nowrap shadow-md">
                Inter ‚Ä¢ Bold ‚Ä¢ 48px</div>
            </div>
            <h1 class="text-5xl font-bold text-slate-900 leading-tight">NOME DO PARTICIPANTE</h1>
          </div>
          <p class="mt-12 text-slate-600 max-w-lg">
            Por completar com sucesso o programa de forma√ß√£o em Design de Interface e Experi√™ncia do Usu√°rio com carga
            hor√°ria de 40 horas.
          </p>
          <div class="mt-auto flex justify-between w-full pt-12">
            <div class="text-center">
              <div class="w-40 border-b border-slate-400 mb-2"></div>
              <p class="text-[10px] font-bold text-slate-400 uppercase">Coordenador do Evento</p>
            </div>
            <div class="text-center">
              <div class="w-40 border-b border-slate-400 mb-2"></div>
              <p class="text-[10px] font-bold text-slate-400 uppercase">Representante AppFiber</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    <aside class="w-72 bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 p-4 space-y-6">
      <div>
        <h3 class="text-sm font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2">
          <span class="material-icons-round text-primary text-lg">format_size</span>
          Estilo de Texto
        </h3>
        <div class="space-y-4">
          <div>
            <label class="text-xs font-semibold text-slate-500 uppercase mb-1.5 block">Fonte</label>
            <select id="prop-font-family" onchange="updateSelectedElementStyle('fontFamily', this.value)"
              class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-sm focus:ring-primary py-2.5">
              <option>Inter</option>
              <option>Playfair Display</option>
              <option>Montserrat</option>
              <option>Lora</option>
            </select>
          </div>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="text-xs font-semibold text-slate-500 uppercase mb-1.5 block">Tamanho</label>
              <input id="prop-font-size" oninput="updateSelectedElementStyle('fontSize', this.value + 'px')"
                class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-sm focus:ring-primary py-2.5"
                type="number" value="48" />
            </div>
            <div class="flex-1">
              <label class="text-xs font-semibold text-slate-500 uppercase mb-1.5 block">Cor</label>
              <div
                class="flex items-center gap-2 w-full bg-slate-50 dark:bg-slate-800 border-none rounded-lg p-1 px-2.5 relative">
                <input type="color" id="prop-text-color" oninput="updateSelectedElementStyle('color', this.value)"
                  class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" />
                <div id="prop-text-color-preview"
                  class="w-6 h-6 rounded-full bg-slate-900 border-2 border-white dark:border-slate-700 shadow-sm pointer-events-none">
                </div>
                <span class="text-xs font-mono">#0F172A</span>
              </div>
            </div>
          </div>
          <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
            <button onclick="toggleStyle('fontWeight', 'bold')" id="btn-bold"
              class="flex-1 p-2 hover:bg-white dark:hover:bg-slate-700 rounded shadow-sm text-slate-700 dark:text-slate-200">
              <span class="material-icons-round text-lg">format_bold</span>
            </button>
            <button onclick="toggleStyle('fontStyle', 'italic')" id="btn-italic"
              class="flex-1 p-2 hover:bg-white dark:hover:bg-slate-700 rounded shadow-sm text-slate-700 dark:text-slate-200">
              <span class="material-icons-round text-lg">format_italic</span>
            </button>
            <button onclick="toggleStyle('textDecoration', 'underline')" id="btn-underline"
              class="flex-1 p-2 hover:bg-white dark:hover:bg-slate-700 rounded shadow-sm text-slate-700 dark:text-slate-200">
              <span class="material-icons-round text-lg">format_underlined</span>
            </button>
          </div>
          <div>
            <label class="text-xs font-semibold text-slate-500 uppercase mb-1.5 block">Alinhamento</label>
            <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
              <button onclick="updateSelectedElementStyle('textAlign', 'left')" id="btn-align-left"
                class="flex-1 p-2 hover:bg-white dark:hover:bg-slate-700 rounded shadow-sm text-slate-400">
                <span class="material-icons-round text-lg">format_align_left</span>
              </button>
              <button onclick="updateSelectedElementStyle('textAlign', 'center')" id="btn-align-center"
                class="flex-1 p-2 bg-white dark:bg-slate-700 rounded shadow-sm text-primary">
                <span class="material-icons-round text-lg">format_align_center</span>
              </button>
              <button onclick="updateSelectedElementStyle('textAlign', 'right')" id="btn-align-right"
                class="flex-1 p-2 hover:bg-white dark:hover:bg-slate-700 rounded shadow-sm text-slate-400">
                <span class="material-icons-round text-lg">format_align_right</span>
              </button>
            </div>
          </div>
          <div class="pt-4 border-t border-slate-100 dark:border-slate-800">
            <label class="text-xs font-semibold text-slate-500 uppercase mb-3 block">Espa√ßamento</label>
            <div class="space-y-4">
              <div>
                <div class="flex justify-between text-[10px] mb-1">
                  <span class="text-slate-400">ENTRE LETRAS</span>
                  <span id="prop-letter-spacing-val">0px</span>
                </div>
                <input id="prop-letter-spacing" step="0.5" min="-2" max="10"
                  oninput="updateSelectedElementStyle('letterSpacing', this.value + 'px')" class="w-full accent-primary"
                  type="range" />
              </div>
              <div>
                <div class="flex justify-between text-[10px] mb-1">
                  <span class="text-slate-400">ENTRE LINHAS</span>
                  <span id="prop-line-height-val">1.2</span>
                </div>
                <input id="prop-line-height" step="0.1" min="0.8" max="3"
                  oninput="updateSelectedElementStyle('lineHeight', this.value)" class="w-full accent-primary"
                  type="range" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-auto pt-6">
        <button
          class="w-full py-2.5 border border-dashed border-slate-300 dark:border-slate-700 text-slate-500 text-xs font-semibold rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
          Configura√ß√µes Avan√ßadas
        </button>
      </div>
    </aside>
  </main>
  <button
    class="fixed bottom-6 right-80 w-12 h-12 bg-primary text-white rounded-xl shadow-xl hover:scale-105 transition-transform flex items-center justify-center z-50">
    <span class="material-icons-round">pan_tool_alt</span>
  </button>

  <script>
    // --- Global State ---
    let selectedElement = null;
    let isDraggingCanvasElement = false;
    let dragOffset = { x: 0, y: 0 };
    const canvas = document.getElementById('editor-canvas');

    // --- Sidebar Drag & Drop (HTML5 API) ---
    function handleDragStart(e) {
      e.dataTransfer.setData('type', e.target.dataset.type);
      e.dataTransfer.setData('subtype', e.target.dataset.subtype);
      e.dataTransfer.effectAllowed = 'copy';
    }

    // Configure Canvas Drop Zone
    canvas.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      canvas.classList.add('border-primary'); // Visual feedback
    });

    canvas.addEventListener('dragleave', (e) => {
      canvas.classList.remove('border-primary');
    });

    canvas.addEventListener('drop', (e) => {
      e.preventDefault();
      canvas.classList.remove('border-primary');
      const type = e.dataTransfer.getData('type');
      const subtype = e.dataTransfer.getData('subtype');

      // Calculate drop position relative to canvas
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      addElement(type, subtype, x, y);
    });

    // --- Canvas Element Creation ---
    function addElement(type, subtype, x, y) {
      const el = document.createElement('div');
      el.style.position = 'absolute';
      el.style.left = (x) + 'px';
      el.style.top = (y) + 'px';
      el.className = 'group cursor-move hover:outline hover:outline-1 hover:outline-primary/50 select-none';

      // Basic Content based on type
      if (type === 'text') {
        if (subtype === 'title') {
          el.innerHTML = '<h1 class="text-4xl font-bold text-slate-900 leading-tight">Novo T√≠tulo</h1>';
        } else if (subtype === 'subtitle') {
          el.innerHTML = '<h2 class="text-2xl font-serif text-slate-800 uppercase tracking-widest">Novo Subt√≠tulo</h2>';
        } else {
          el.innerHTML = '<p class="text-base text-slate-600">Novo par√°grafo de texto.</p>';
        }
      } else if (type === 'image') {
        el.innerHTML = '<div class="w-32 h-32 bg-slate-100 dark:bg-slate-800 border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center rounded-lg"><span class="material-icons-round text-3xl text-slate-400 mb-2">add_photo_alternate</span><span class="text-[10px] text-slate-500 font-medium">Upload Imagem</span></div>';
      } else if (type === 'qrcode') {
        el.innerHTML = '<div class="w-24 h-24 bg-white p-2 shadow-sm rounded-lg"><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=AppFiber" class="w-full h-full object-contain" alt="QR Code"></div>';
      } else if (type === 'signature') {
        el.innerHTML = '<div class="min-w-[160px] flex flex-col items-center"><div class="h-12 w-full flex items-end justify-center mb-2"><img src="https://upload.wikimedia.org/wikipedia/commons/e/ec/Signature_sample.svg" class="h-full object-contain opacity-70"></div><div class="w-full border-b border-sites-900 dark:border-slate-400 mb-1"></div><p class="text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Assinatura</p></div>';
      }

      // Add interactivity
      el.addEventListener('mousedown', (e) => startDragElement(e, el));
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        selectElement(el);
      });
      el.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        if (type === 'text') enableTextEditing(el);
      });

      canvas.appendChild(el);
      selectElement(el);
    }

    // --- Element Moving (Mouse Events) ---
    function startDragElement(e, el) {
      if (el.isContentEditable) return; // Don't drag while editing text

      isDraggingCanvasElement = true;
      const rect = el.getBoundingClientRect();
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;

      // Select if not already selected
      if (selectedElement !== el) {
        selectElement(el);
      }

      // Global move/up listeners
      document.addEventListener('mousemove', moveElement);
      document.addEventListener('mouseup', stopDragElement);
    }

    function moveElement(e) {
      if (!isDraggingCanvasElement || !selectedElement) return;
      e.preventDefault();

      const canvasRect = canvas.getBoundingClientRect();
      let x = e.clientX - canvasRect.left - dragOffset.x;
      let y = e.clientY - canvasRect.top - dragOffset.y;

      // Optional: Snap or constrain (omitted for freedom)
      // Save percentage positions for responsiveness? keeping pixels for now as per MVP request.

      selectedElement.style.left = x + 'px';
      selectedElement.style.top = y + 'px';
    }

    function stopDragElement() {
      isDraggingCanvasElement = false;
      document.removeEventListener('mousemove', moveElement);
      document.removeEventListener('mouseup', stopDragElement);
    }

    // --- Selection Logic ---
    function selectElement(el) {
      // Deselect previous
      if (selectedElement) {
        selectedElement.classList.remove('outline', 'outline-2', 'outline-primary');
        // Remove previous highlight border div if it exists (the one with the dots)
        const oldFrame = selectedElement.querySelector('.selection-frame');
        if (oldFrame) oldFrame.remove();
      }

      selectedElement = el;

      // Visual selection on the element
      // We can use a simpler outline for now, or append the fancy frame div
      el.classList.add('outline', 'outline-2', 'outline-primary');

      // Update Sidebar Properties
      syncSidebarWithElement(el);
    }

    // Click outside to deselect
    canvas.addEventListener('mousedown', (e) => {
      if (e.target === canvas) {
        if (selectedElement) {
          selectedElement.classList.remove('outline', 'outline-2', 'outline-primary');
          const oldFrame = selectedElement.querySelector('.selection-frame');
          if (oldFrame) oldFrame.remove();
          selectedElement = null;
        }
      }
    });

    // --- Property Binding ---
    function syncSidebarWithElement(el) {
      const computed = window.getComputedStyle(el.firstElementChild || el);

      // Helper to safe set value
      const setVal = (id, val) => {
        const input = document.getElementById(id);
        if (input) input.value = val;
      };

      // We assume the inner element holds the style (h1, h2, p)
      const target = el.firstElementChild || el;

      // Font Family (simplified matching)
      const font = computed.fontFamily.replace(/['"]/g, '').split(',')[0].trim();
      setVal('prop-font-family', font);

      // Size
      setVal('prop-font-size', parseInt(computed.fontSize));

      // Color (rgb to hex)
      const rgb = computed.color.match(/\d+/g);
      if (rgb) {
        const hex = "#" + ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1).toUpperCase();
        setVal('prop-text-color', hex);
      }

      // Letter Spacing
      let ls = computed.letterSpacing;
      if (ls === 'normal') ls = 0;
      else ls = parseFloat(ls);
      setVal('prop-letter-spacing', ls);
      document.getElementById('prop-letter-spacing-val').innerText = ls + 'px';

      // Line Height
      let lh = computed.lineHeight;
      if (lh === 'normal') lh = 1.2;
      else {
        // Computed comes often as px, we want unitless ratio roughly
        lh = (parseFloat(lh) / parseFloat(computed.fontSize)).toFixed(1);
      }
      setVal('prop-line-height', lh);
      document.getElementById('prop-line-height-val').innerText = lh;

      // Button States (Bold, Italic, etc)
      updateToggleButton('btn-bold', computed.fontWeight === '700' || computed.fontWeight === 'bold');
      updateToggleButton('btn-italic', computed.fontStyle === 'italic');
      updateToggleButton('btn-underline', computed.textDecorationLine.includes('underline'));

      // Alignment
      updateAlignButtons(computed.textAlign);
    }

    function updateToggleButton(id, isActive) {
      const btn = document.getElementById(id);
      if (isActive) {
        btn.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-primary');
        btn.classList.remove('hover:bg-white', 'text-slate-700');
      } else {
        btn.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-primary');
        btn.classList.add('hover:bg-white');
      }
    }

    function updateAlignButtons(align) {
      ['left', 'center', 'right'].forEach(a => {
        const btn = document.getElementById('btn-align-' + a);
        if (a === align || (align === 'start' && a === 'left')) {
          btn.classList.add('bg-white', 'dark:bg-slate-700', 'text-primary', 'shadow-sm');
          btn.classList.remove('text-slate-400', 'hover:bg-white');
        } else {
          btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-primary', 'shadow-sm');
          btn.classList.add('text-slate-400', 'hover:bg-white');
        }
      });
    }


    function updateSelectedElementStyle(prop, value) {
      if (!selectedElement) return;
      const target = selectedElement.firstElementChild || selectedElement;

      target.style[prop] = value;

      // Special updates for labels
      if (prop === 'letterSpacing') document.getElementById('prop-letter-spacing-val').innerText = value;
      if (prop === 'lineHeight') document.getElementById('prop-line-height-val').innerText = value;

      // Visual feedback on buttons
      if (prop === 'textAlign') updateAlignButtons(value);
    }

    function toggleStyle(prop, value) {
      if (!selectedElement) return;
      const target = selectedElement.firstElementChild || selectedElement;

      // Check current
      const current = target.style[prop];
      // This is a simple toggle. Real world needs to read computed if style not set inline.
      // For MVP we just toggle based on what we set or assume default 'normal'

      if (prop === 'fontWeight') {
        target.style.fontWeight = (target.style.fontWeight === 'bold') ? 'normal' : 'bold';
        updateToggleButton('btn-bold', target.style.fontWeight === 'bold');
      }
      else if (prop === 'fontStyle') {
        target.style.fontStyle = (target.style.fontStyle === 'italic') ? 'normal' : 'italic';
        updateToggleButton('btn-italic', target.style.fontStyle === 'italic');
      }
      else if (prop === 'textDecoration') {
        target.style.textDecoration = (target.style.textDecoration === 'underline') ? 'none' : 'underline';
        updateToggleButton('btn-underline', target.style.textDecoration === 'underline');
      }
    }

    // --- Text Editing ---
    function enableTextEditing(el) {
      const target = el.firstElementChild || el;
      target.contentEditable = true;
      target.focus();
      el.classList.add('cursor-text');
      el.classList.remove('cursor-move');

      // Select all text
      document.execCommand('selectAll', false, null);

      const disableEdit = () => {
        target.contentEditable = false;
        el.classList.remove('cursor-text');
        el.classList.add('cursor-move');
        target.removeEventListener('blur', disableEdit);
        window.getSelection().removeAllRanges();
      };

      target.addEventListener('blur', disableEdit);

      // Enter key to finish (prevent newline if desired, or allow)
      target.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          target.blur();
        }
      });
    }


    // --- Saving & Keybinds ---
    async function salvarTemplate() {
      // Remove selection frame before saving
      if (selectedElement) {
        selectedElement.classList.remove('outline', 'outline-2', 'outline-primary');
        selectedElement = null; // deselect
      }

      const titulo = "Novo Template " + new Date().toLocaleTimeString();
      const html = document.getElementById('editor-canvas').innerHTML;

      const urlParams = new URLSearchParams(window.location.search);
      const templateId = urlParams.get('template_id');

      const payload = {
        titulo: titulo,
        orientacao: 'landscape',
        html: html,
        elements: [],
        template_id: templateId
      };

      try {
        const response = await fetch("{{ url_for('certificado_routes.salvar_template_avancado') }}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}"
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
          alert('Template salvo com sucesso!');
          if (!templateId && result.template_id) {
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('template_id', result.template_id);
            window.history.pushState({}, '', newUrl);
          }
        } else {
          alert('Erro ao salvar: ' + result.message);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar template.');
      }
    }

    // Initialize existing static elements to be interactive
    // This finds the "NOME DO PARTICIPANTE" example and others
    document.addEventListener('DOMContentLoaded', () => {
      const existing = canvas.querySelectorAll('.cursor-move');
      existing.forEach(el => {
        el.addEventListener('mousedown', (e) => startDragElement(e, el));
        el.addEventListener('click', (e) => { e.stopPropagation(); selectElement(el); });
        // Ensure it has absolute positioning to be movable if not already
        // The example one has relative+absolute children, might need adjustment or replaced by true absolute

        // For the demo static element "NOME DO PARTICIPANTE", it's absolute inside relative.
        // We'll leave it be or user can delete it. 
      });
    });

  </script>

</body>

</html>