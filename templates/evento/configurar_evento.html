{% extends "base.html" %}
{% block title %}Configurar Evento{% endblock %}

{% block content %}
<div class="container py-5">
  <input type="hidden" id="pagamento_habilitado" value="1">
  <div class="bg-primary bg-gradient rounded-3 p-4 mb-4 shadow-sm">
    <h1 class="h3 fw-bold text-white mb-0">
      <i class="bi bi-calendar-event me-2"></i>Configurar Evento
    </h1>
  </div>

  <!-- Seleção de Evento -->
  <div class="card border-0 shadow mb-4">
    <div class="card-body rounded-3 p-4 bg-light">
      <div class="mb-4">
        <label for="evento_id" class="form-label fw-semibold">Selecionar Evento</label>
        <select id="evento_id" class="form-select" onchange="carregarEvento(this.value)">
          <option value="">-- Criar Novo Evento --</option>
          {% for ev in eventos %}
            <option value="{{ ev.id }}" {% if evento and evento.id == ev.id %}selected{% endif %}>
              {{ ev.nome }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

<!-- Barra de progresso moderna com indicadores de etapa -->
<div class="progress-container mb-4">
  <div class="progress-steps-container">
    <div class="step-indicator-container">
      <div class="step-indicator active" data-step="1">
        <div class="step-number">1</div>
        <div class="step-label">Informações Básicas</div>
      </div>
      <div class="step-indicator" data-step="2">
        <div class="step-number">2</div>
        <div class="step-label">Data e Horário</div>
      </div>
      <div class="step-indicator" data-step="3">
        <div class="step-number">3</div>
        <div class="step-label">Localização</div>
      </div>
      <div class="step-indicator" data-step="4">
        <div class="step-number">4</div>
        <div class="step-label">Inscrição</div>
      </div>
      <div class="step-indicator" data-step="5">
        <div class="step-number">5</div>
        <div class="step-label">Certificado</div>
      </div>
    </div>
    <div class="progress progress-bar-modern">
      <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  </div>
</div>

  <div class="card border-0 shadow">
    <div class="card-body rounded-3 p-4 bg-light">
      <!-- Formulário -->
      <form method="POST" enctype="multipart/form-data" id="form-evento">
        <input type="hidden" name="evento_id" value="{{ evento.id if evento else '' }}">
        
        <!-- Etapa 1: Informações Básicas -->
        <div class="step" id="step-1">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-info-circle me-2"></i>Informações Básicas
            </h5>
          </div>
          
          <div class="mb-4">
            <label class="form-label fw-semibold">Nome do Evento</label>
            <input type="text" name="nome" class="form-control form-control-lg border border-secondary bg-white" value="{{ evento.nome if evento else '' }}" required>
          </div>
          <div class="mb-4">
            <label class="form-label fw-semibold">Descrição</label>
            <textarea name="descricao" class="form-control form-control-lg border border-secondary bg-white" rows="3">{{ evento.descricao if evento else '' }}</textarea>
          </div>
          
          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-primary next-step px-4" data-next="2">
              Próximo <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Etapa 2: Data e Horário (Nova etapa adicionada) -->
        <div class="step" id="step-2" style="display: none;">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-calendar me-2"></i>Data e Horário
            </h5>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-4">
              <label class="form-label fw-semibold">Data de Início</label>
              <input type="date" class="form-control border border-secondary bg-white" name="data_inicio" value="{{ evento.data_inicio.strftime('%Y-%m-%d') if evento.data_inicio else '' }}">
            </div>
            
            <div class="col-md-6 mb-4">
              <label class="form-label fw-semibold">Data de Término</label>
              <input type="date" class="form-control border border-secondary bg-white" name="data_fim" value="{{ evento.data_fim.strftime('%Y-%m-%d') if evento.data_fim else '' }}">
            </div>
            
            <div class="col-md-6 mb-4">
              <label class="form-label fw-semibold">Hora de Início</label>
              <input type="time" class="form-control border border-secondary bg-white" name="hora_inicio" value="{{ evento.hora_inicio.strftime('%H:%M') if evento.hora_inicio else '' }}">
            </div>
            
            <div class="col-md-6 mb-4">
              <label class="form-label fw-semibold">Hora de Término</label>
              <input type="time" class="form-control border border-secondary bg-white" name="hora_fim" value="{{ evento.hora_fim.strftime('%H:%M') if evento.hora_fim else '' }}">
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="1">
              <i class="bi bi-arrow-left me-2"></i> Anterior
            </button>
            <button type="button" class="btn btn-primary next-step px-4" data-next="3">
              Próximo <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Etapa 3: Localização -->
        <div class="step" id="step-3" style="display: none;">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-geo-alt me-2"></i>Localização
            </h5>
          </div>
          
          <div class="mb-4">
            <label class="form-label fw-semibold">Endereço do Evento</label>
            <div class="input-group">
              <input type="text" id="localizacao-input" name="localizacao" class="form-control border border-secondary bg-white" value="{{ evento.localizacao if evento else '' }}" autocomplete="off">
              <button type="button" class="btn btn-primary" id="btn-mostrar-mapa" data-bs-toggle="modal" data-bs-target="#mapaModal">
                <i class="bi bi-geo-alt"></i> Buscar no Mapa
              </button>
            </div>
            <div class="suggestions-container position-relative">
              <div id="suggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></div>
            </div>
          </div>
          
          <!-- Campos de coordenadas ocultos -->
          <input type="hidden" id="latitude" name="latitude" value="{{ evento.latitude if evento else '' }}">
          <input type="hidden" id="longitude" name="longitude" value="{{ evento.longitude if evento else '' }}">
          <input type="hidden" id="link_mapa" name="link_mapa" value="{{ evento.link_mapa if evento else '' }}">
          
          <div class="mb-4">
            <div class="border-bottom border-primary pb-2 mb-3">
              <h5 class="text-primary d-flex align-items-center">
                <i class="bi bi-image me-2"></i>Mídia
              </h5>
            </div>
            <label class="form-label fw-semibold">Banner do Evento</label>
            <input type="file" name="banner" class="form-control border border-secondary bg-white">
            <div class="form-text">Recomendado: Imagem no formato 1200 x 600px</div>
              {% if evento and evento.banner_url %}
                <div class="mt-3 text-center">
                  <img src="{{ evento.banner_url }}" alt="Banner" class="img-fluid rounded shadow-sm" style="max-height: 200px;">
                </div>
              {% endif %}
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="2">
              <i class="bi bi-arrow-left me-2"></i> Anterior
            </button>
            <button type="button" class="btn btn-primary next-step px-4" data-next="4">
              Próximo <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Etapa 4: Configuração de Inscrição -->
        <div class="step" id="step-4" style="display: none;">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-cash-coin me-2"></i>Configuração de Inscrição
            </h5>
          </div>

          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <div class="card h-100 hover-shadow cursor-pointer inscription-type-card" onclick="document.getElementById('inscricao_gratuita').click()">
                <div class="card-body p-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="inscricao_gratuita" id="inscricao_gratuita" value="1"
                           {% if evento is none or evento.inscricao_gratuita %}checked{% endif %}>
                    <label class="form-check-label w-100" for="inscricao_gratuita">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-ticket-fill fs-3 text-success me-2"></i>
                        <h6 class="mb-0">Inscrição Gratuita</h6>
                      </div>
                      <p class="text-muted small mb-0">Evento sem cobrança de taxa de inscrição</p>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100 hover-shadow cursor-pointer inscription-type-card" onclick="document.getElementById('inscricao_paga').click()">
                <div class="card-body p-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="inscricao_gratuita" id="inscricao_paga" value="0"
                           {% if evento and not evento.inscricao_gratuita %}checked{% endif %}>
                    <label class="form-check-label w-100" for="inscricao_paga">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-credit-card-fill fs-3 text-primary me-2"></i>
                        <h6 class="mb-0">Inscrição Paga</h6>
                      </div>
                      <p class="text-muted small mb-0">Evento com cobrança de taxa de inscrição</p>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-check form-switch mb-3" id="habilitar-lotes-container" {% if not evento or evento.inscricao_gratuita %}style="display:none;"{% endif %}>
            <input type="checkbox" class="form-check-input" id="habilitar_lotes" name="habilitar_lotes" {% if evento and evento.habilitar_lotes %}checked{% endif %}>
            <label class="form-check-label" for="habilitar_lotes">Habilitar inscrição em lotes</label>
            <small class="form-text text-muted d-block mt-1">Quando marcado, você poderá configurar diferentes lotes de inscrição com preços e períodos específicos.</small>
          </div>

          <div id="tipos-inscricao-container" class="card bg-white shadow-sm border-0 mb-4" {% if not evento or evento.inscricao_gratuita %}style="display:none;"{% endif %}>
            <div class="card-body">
              <h6 class="card-title fw-bold mb-3">Tipos de Inscrição</h6>
              <p class="text-muted small mb-3">Configure os tipos de inscrição e seus respectivos valores:</p>
              <div id="tipos-inscricao-list">
                {% if evento and evento.tipos_inscricao_evento %}
                  {% for tipo in evento.tipos_inscricao_evento %}
                  <div class="row mb-3 align-items-center tipo-inscricao-item">
                    <div class="col-md-5 col-sm-12 mb-2 mb-md-0">
                      <label class="form-label">Tipo de Inscrição:</label>
                      <input type="text" class="form-control border border-secondary bg-white" name="nome_tipo[]" value="{{ tipo.nome }}" placeholder="Nome do Tipo de Inscrição">
                      <!-- Campo oculto para preservar ID do tipo de inscrição -->
                      <input type="hidden" name="id_tipo[]" value="{{ tipo.id }}">
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2 mb-md-0 preco-container" {% if evento and evento.inscricao_gratuita %}style="display:none;"{% endif %}>
                      <label class="form-label">Preço:</label>
                      <input type="number" step="0.01" class="form-control border border-secondary bg-white" name="preco_tipo[]" value="{{ tipo.preco }}" placeholder="Preço">
                    </div>
                    <div class="col-md-2 col-sm-6 mb-2 mb-md-0">
                      <label class="form-label">Somente Submissão</label>
                      <input type="checkbox" class="form-check-input" name="submission_only[]" {% if tipo.submission_only %}checked{% endif %}>
                    </div>
                    <div class="col-md-2 col-sm-6">
                      <button type="button" class="btn btn-danger w-100 remover-tipo-inscricao"
                              data-inscricoes="{{ tipo.quantidade_inscricoes|default(0) }}"
                              data-id="{{ tipo.id }}">
                        {% if tipo.quantidade_inscricoes and tipo.quantidade_inscricoes > 0 %}
                          <i class="bi bi-lock"></i> Possui {{ tipo.quantidade_inscricoes }} inscrições
                        {% else %}
                          <i class="bi bi-trash"></i> Remover
                        {% endif %}
                      </button>
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  <!-- Caso não haja tipos de inscrição, exibe um campo vazio como padrão -->
                  <div class="row mb-3 align-items-center tipo-inscricao-item">
                    <div class="col-md-5 col-sm-12 mb-2 mb-md-0">
                      <label class="form-label">Tipo de Inscrição:</label>
                      <input type="text" class="form-control border border-secondary bg-white" name="nome_tipo[]" placeholder="Nome do Tipo de Inscrição">
                      <input type="hidden" name="id_tipo[]" value="">
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2 mb-md-0 preco-container" {% if evento and evento.inscricao_gratuita %}style="display:none;"{% endif %}>
                      <label class="form-label">Preço:</label>
                      <input type="number" step="0.01" class="form-control border border-secondary bg-white" name="preco_tipo[]" placeholder="Preço" value="{% if evento and evento.inscricao_gratuita %}0.00{% endif %}">
                    </div>
                    <div class="col-md-2 col-sm-6 mb-2 mb-md-0">
                      <label class="form-label">Somente Submissão</label>
                      <input type="checkbox" class="form-check-input" name="submission_only[]">
                    </div>
                    <div class="col-md-2 col-sm-6">
                      <button type="button" class="btn btn-danger w-100 remover-tipo-inscricao" data-inscricoes="0">
                        <i class="bi bi-trash"></i> Remover
                      </button>
                    </div>
                  </div>
                {% endif %}
              </div>
              <button type="button" id="adicionar-tipo-inscricao" class="btn btn-outline-primary mt-2">
                <i class="bi bi-plus-circle me-1"></i> Adicionar Tipo de Inscrição
              </button>
            </div>
          </div>

          <!-- lotes de inscrição -->

          <div id="lotes-section" class="mb-4" {% if not evento or not evento.habilitar_lotes %}style="display:none;"{% endif %}>
            <div class="border-bottom border-primary pb-2 mb-4">
              <h5 class="text-primary d-flex align-items-center">
                <i class="bi bi-layers me-2"></i>Lotes de Inscrição
              </h5>
            </div>
            
            <p class="text-muted small mb-3">Configure os lotes de inscrição para definir preços por período ou quantidade:</p>
            
            <div id="lotes-container">
              {% if evento and evento.lotes %}
                {% for lote in evento.lotes %}
                <div class="lote-item card mb-4 shadow-sm" data-lote-id="{{ lote.id }}">
                  {% for tipo in evento.tipos_inscricao_evento %}
                    {% for lote_tipo in lote.tipos_inscricao %}
                      {% if lote_tipo.tipo_inscricao_id == tipo.id %}
                        <div hidden data-preco-{{ tipo.id }}="{{ lote_tipo.preco }}"></div>
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                  
                  <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ lote.nome }}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger remover-lote" data-id="{{ lote.id }}" {% if lote.inscricoes|length > 0 %}disabled{% endif %}>
                      {% if lote.inscricoes|length > 0 %}
                        <i class="bi bi-lock"></i> Possui {{ lote.inscricoes|length }} inscrições
                      {% else %}
                        <i class="bi bi-trash"></i> Remover
                      {% endif %}
                    </button>
                  </div>
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
                        <label class="form-label">Nome do Lote</label>
                        <input type="text" class="form-control border border-secondary bg-white" name="lote_nome[]" value="{{ lote.nome }}" placeholder="Ex: Lote Promocional">
                        <input type="hidden" name="lote_id[]" value="{{ lote.id }}">
                      </div>
                      <div class="col-md-3 col-sm-6 mb-2 mb-md-0">
                        <label class="form-label">Ordem</label>
                        <input type="number" class="form-control border border-secondary bg-white" name="lote_ordem[]" value="{{ lote.ordem }}" min="1">
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <label class="form-label">Status</label>
                        <select class="form-select border border-secondary bg-white" name="lote_ativo[]">
                          <option value="1" {% if lote.ativo %}selected{% endif %}>Ativo</option>
                          <option value="0" {% if not lote.ativo %}selected{% endif %}>Inativo</option>
                        </select>
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-6 col-sm-12 mb-3 mb-md-0">
                        <div class="form-check mb-2">
                          <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_data[]" {% if lote.data_inicio or lote.data_fim %}checked{% endif %}>
                          <label class="form-check-label">Definir por período</label>
                        </div>
                        <div class="row lote-datas" {% if not lote.data_inicio and not lote.data_fim %}style="display:none"{% endif %}>
                          <div class="col-md-6 col-sm-6 mb-2 mb-md-0">
                            <label class="form-label">Data Início</label>
                            <input type="date" class="form-control border border-secondary bg-white" name="lote_data_inicio[]" value="{{ lote.data_inicio.strftime('%Y-%m-%d') if lote.data_inicio else '' }}">
                          </div>
                          <div class="col-md-6 col-sm-6">
                            <label class="form-label">Data Fim</label>
                            <input type="date" class="form-control border border-secondary bg-white" name="lote_data_fim[]" value="{{ lote.data_fim.strftime('%Y-%m-%d') if lote.data_fim else '' }}">
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6 col-sm-12">
                        <div class="form-check mb-2">
                          <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_qtd[]" {% if lote.qtd_maxima %}checked{% endif %}>
                          <label class="form-check-label">Definir por quantidade</label>
                        </div>
                        <div class="lote-quantidade" {% if not lote.qtd_maxima %}style="display:none"{% endif %}>
                          <label class="form-label">Quantidade máxima</label>
                          <input type="number" class="form-control border border-secondary bg-white" name="lote_qtd_maxima[]" min="1" placeholder="Limite de inscritos" value="{{ lote.qtd_maxima or '' }}">
                        </div>
                      </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">Preços por tipo de inscrição:</h6>
                    <div class="lote-precos">
                      {% for tipo in evento.tipos_inscricao_evento %}
                        {% set preco_lote = None %}
                        {% for lote_tipo in lote.tipos_inscricao %}
                          {% if lote_tipo.tipo_inscricao_id == tipo.id %}
                            {% set preco_lote = lote_tipo.preco %}
                          {% endif %}
                        {% endfor %}
                        
                        <div class="row mb-2 align-items-center">
                          <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
                            <label class="form-label">{{ tipo.nome }}</label>
                            <input type="hidden" name="lote_tipo_id_{{ lote.id }}_{{ tipo.id }}" value="{{ tipo.id }}">
                          </div>
                          <div class="col-md-6 col-sm-12 preco-container" {% if evento.inscricao_gratuita %}style="display:none;"{% endif %}>
                            <label class="form-label">Preço (R$)</label>
                            <input type="number" step="0.01" class="form-control border border-secondary bg-white" 
                                  name="lote_tipo_preco_{{ lote.id }}_{{ tipo.id }}" 
                                  placeholder="0.00" 
                                  value="{{ preco_lote if preco_lote is not none else tipo.preco }}">
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <!-- Lote padrão para novos eventos -->
                <div class="lote-item card mb-4 shadow-sm">
                  <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Lote 1</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger remover-lote">
                      <i class="bi bi-trash"></i> Remover
                    </button>
                  </div>
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
                        <label class="form-label">Nome do Lote</label>
                        <input type="text" class="form-control border border-secondary bg-white" name="lote_nome[]" placeholder="Ex: Lote Promocional">
                        <input type="hidden" name="lote_id[]" value="">
                      </div>
                      <div class="col-md-3 col-sm-6 mb-2 mb-md-0">
                        <label class="form-label">Ordem</label>
                        <input type="number" class="form-control border border-secondary bg-white" name="lote_ordem[]" value="1" min="1">
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <label class="form-label">Status</label>
                        <select class="form-select border border-secondary bg-white" name="lote_ativo[]">
                          <option value="1" selected>Ativo</option>
                          <option value="0">Inativo</option>
                        </select>
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-6 col-sm-12 mb-3 mb-md-0">
                        <div class="form-check mb-2">
                          <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_data[]" checked>
                          <label class="form-check-label">Definir por período</label>
                        </div>
                        <div class="row lote-datas">
                          <div class="col-md-6 col-sm-6 mb-2 mb-md-0">
                            <label class="form-label">Data Início</label>
                            <input type="date" class="form-control border border-secondary bg-white" name="lote_data_inicio[]">
                          </div>
                          <div class="col-md-6 col-sm-6">
                            <label class="form-label">Data Fim</label>
                            <input type="date" class="form-control border border-secondary bg-white" name="lote_data_fim[]">
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6 col-sm-12">
                        <div class="form-check mb-2">
                          <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_qtd[]">
                          <label class="form-check-label">Definir por quantidade</label>
                        </div>
                        <div class="lote-quantidade" style="display: none;">
                          <label class="form-label">Quantidade máxima</label>
                          <input type="number" class="form-control border border-secondary bg-white" name="lote_qtd_maxima[]" min="1" placeholder="Limite de inscritos">
                        </div>
                      </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">Preços por tipo de inscrição:</h6>
                    <div class="lote-precos">
                      <!-- Os campos de preços serão gerados dinamicamente com base nos tipos de inscrição -->
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
            
            <button type="button" id="adicionar-lote" class="btn btn-outline-primary mt-2">
              <i class="bi bi-plus-circle me-1"></i> Adicionar Lote
            </button>
          </div>

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="3">
              <i class="bi bi-arrow-left me-2"></i> Anterior
            </button>
            <button type="submit" class="btn btn-success px-4">
              <i class="bi bi-save me-2"></i>Salvar Evento
            </button>
          </div>
        </div>
      </form>
      {% if evento %}
      <form method="POST" action="{{ url_for('evento_routes.excluir_evento', evento_id=evento.id) }}" class="mt-3" onsubmit="return confirm('Tem certeza que deseja excluir este evento?');">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-trash me-2"></i>Excluir Evento
        </button>
      </form>
      {% endif %}
      <!-- Etapa 5: Certificado -->
      <div class="step" id="step-5" style="display: none;">
        {% if evento %}
        <form method="POST" action="{{ url_for('evento_routes.salvar_config_certificado', evento_id=evento.id) }}">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-award me-2"></i>Configuração de Certificado
            </h5>
          </div>

          <div class="mb-3">
            <label class="form-label">Check-ins mínimos</label>
            <input type="number" class="form-control border border-secondary bg-white" name="checkins_minimos" value="{{ config_certificado.checkins_minimos if config_certificado else 0 }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Participação mínima (%)</label>
            <input type="number" min="0" max="100" class="form-control border border-secondary bg-white" name="percentual_minimo" value="{{ config_certificado.percentual_minimo if config_certificado else 0 }}">
          </div>

          {% if oficinas %}
          <div class="mb-3">
            <label class="form-label">Oficinas obrigatórias</label>
            <div class="row">
              {% for ofi in oficinas %}
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="ofi{{ ofi.id }}" name="oficinas_obrigatorias" value="{{ ofi.id }}" {% if config_certificado and ofi.id in config_certificado.get_oficinas_obrigatorias_list() %}checked{% endif %}>
                  <label class="form-check-label" for="ofi{{ ofi.id }}">{{ ofi.titulo }}</label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="4">
              <i class="bi bi-arrow-left me-2"></i> Anterior
            </button>
            <button type="submit" class="btn btn-success px-4">
              <i class="bi bi-save me-2"></i>Salvar Configuração
            </button>
          </div>
        </form>
        {% else %}
        <p class="text-muted">Selecione ou salve um evento para configurar o certificado.</p>
        <div class="d-flex justify-content-start mt-4">
          <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="4">
            <i class="bi bi-arrow-left me-2"></i> Anterior
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal para o Mapa -->
<div class="modal fade" id="mapaModal" tabindex="-1" aria-labelledby="mapaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mapaModalLabel">Localizar Endereço</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3">
          <input type="text" id="modal-search-input" class="form-control" placeholder="Digite um lugar para pesquisar...">
          <button id="modal-search-btn" class="btn btn-primary" type="button">Buscar</button>
        </div>
        <div id="mapa-container" style="height: 400px;"></div>
        <div id="endereco-detalhes" class="mt-3 p-3 bg-light rounded d-none">
          <h6 class="fw-bold">Detalhes do Local:</h6>
          <p id="endereco-completo" class="mb-1"></p>
          <p class="mb-1">Latitude: <span id="info-latitude"></span></p>
          <p class="mb-1">Longitude: <span id="info-longitude"></span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-selecionar-local" data-bs-dismiss="modal">Selecionar Este Local</button>
      </div>
    </div>
  </div>
</div>

<!-- CSS para Sugestões e Estilos -->
<style>
.suggestion-item {
  padding: 8px 15px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}
.suggestion-item:hover {
  background-color: #f0f7ff;
}

/* Barra de progresso moderna */
.progress-container {
  margin: 30px 0;
}

.progress-steps-container {
  position: relative;
}

.step-indicator-container {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
}

.step-indicator {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  flex: 1;
  max-width: 20%;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #e9ecef;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  color: #6c757d;
  margin-bottom: 8px;
  transition: all 0.3s ease;
  border: 2px solid #dee2e6;
}

.step-label {
  font-size: 0.8rem;
  text-align: center;
  color: #6c757d;
  transition: color 0.3s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%;
}

.step-indicator.active .step-number {
  background-color: var(--bs-primary);
  color: white;
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
}

.step-indicator.active .step-label {
  color: var(--bs-primary);
  font-weight: bold;
}

.step-indicator.completed .step-number {
  background-color: #198754;
  color: white;
  border-color: #198754;
}

.progress-bar-modern {
  height: 8px;
  position: absolute;
  top: 20px;
  left: 0;
  right: 0;
  z-index: 0;
  margin: 0 20px;
}

/* Para dispositivos móveis */
@media (max-width: 768px) {
  .step-label {
    font-size: 0.7rem;
  }
  
  .step-number {
    width: 30px;
    height: 30px;
    font-size: 0.8rem;
  }
  
  .progress-bar-modern {
    top: 15px;
  }
}

/* Para telas muito pequenas */
@media (max-width: 576px) {
  .step-label {
    display: none;
  }
  
  .progress-bar-modern {
    margin: 0 15px;
  }
}

/* Melhorias para dispositivos móveis */
@media (max-width: 768px) {
  .container {
    padding-left: 10px;
    padding-right: 10px;
  }
  
  h5.text-primary {
    font-size: 1.1rem;
  }
  
  .card-body {
    padding: 1rem;
  }
  
  .next-step, .prev-step {
    width: 45%;
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
    font-size: 0.9rem;
  }
  
  /* Ajuste para botões no mobile */
  .remover-tipo-inscricao, .remover-lote {
    margin-top: 10px;
  }
}

/* Animações e efeitos visuais */
.step:not([style*="display: none"]) {
  animation: fadeIn 0.5s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Melhorias visuais para formulários */
.form-label {
  margin-bottom: 0.3rem;
}

.card {
  border-radius: 0.5rem;
  transition: box-shadow 0.3s ease;
}

.card:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.btn {
  border-radius: 0.35rem;
  transition: all 0.2s;
}

/* Melhorias para lotes */
.lote-item {
  border-radius: 0.5rem;
  overflow: hidden;
}

.lote-item .card-header {
  background-color: rgba(0, 123, 255, 0.1);
}
</style>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Controle de etapas
  const progressBar = document.getElementById('progress-bar');
  const steps = document.querySelectorAll('.step');
  let currentStep = 1;
  const urlStep = parseInt(new URLSearchParams(window.location.search).get('step'));
  if (urlStep && urlStep >= 1 && urlStep <= steps.length) {
    currentStep = urlStep;
  }
  steps.forEach((el, idx) => {
    el.style.display = idx + 1 === currentStep ? 'block' : 'none';
  });
  updateProgressBar(currentStep);

// Atualizar barra de progresso e indicadores
function updateProgressBar(step) {
  const totalSteps = steps.length;
  const percent = (step / totalSteps) * 100;
  
  // Atualizar a barra de progresso
  progressBar.style.width = percent + '%';
  progressBar.setAttribute('aria-valuenow', percent);
  
  // Atualizar os indicadores de etapa
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    if (index + 1 < step) {
      indicator.classList.add('completed');
      indicator.classList.remove('active');
    } else if (index + 1 === step) {
      indicator.classList.add('active');
      indicator.classList.remove('completed');
    } else {
      indicator.classList.remove('active', 'completed');
    }
  });
}

  // Navegar para próxima etapa
  document.querySelectorAll('.next-step').forEach(button => {
    button.addEventListener('click', function() {
      const nextStep = parseInt(this.getAttribute('data-next'));
      
      // Esconder etapa atual
      document.getElementById(`step-${currentStep}`).style.display = 'none';
      
      // Mostrar próxima etapa
      document.getElementById(`step-${nextStep}`).style.display = 'block';
      
      // Atualizar etapa atual
      currentStep = nextStep;
      
      // Atualizar barra de progresso
      updateProgressBar(currentStep);
      
      // Rolar para o topo do formulário
      window.scrollTo({top: 0, behavior: 'smooth'});
    });
  });

  // Navegar para etapa anterior
  document.querySelectorAll('.prev-step').forEach(button => {
    button.addEventListener('click', function() {
      const prevStep = parseInt(this.getAttribute('data-prev'));
      
      // Esconder etapa atual
      document.getElementById(`step-${currentStep}`).style.display = 'none';
      
      // Mostrar etapa anterior
      document.getElementById(`step-${prevStep}`).style.display = 'block';
      
      // Atualizar etapa atual
      currentStep = prevStep;
      
      // Atualizar barra de progresso
      updateProgressBar(currentStep);
      
      // Rolar para o topo do formulário
      window.scrollTo({top: 0, behavior: 'smooth'});
    });
  });

  // Toggle price fields visibility
  const inscricaoGratuita = document.getElementById('inscricao_gratuita');
  const inscricaoPaga = document.getElementById('inscricao_paga');
  const tiposContainer = document.getElementById('tipos-inscricao-container');
  const tiposList = document.getElementById('tipos-inscricao-list');

  // Toggle lotes visibility
  const habilitarLotes = document.getElementById('habilitar_lotes');
  const habilitarLotesContainer = document.getElementById('habilitar-lotes-container');
  const lotesSection = document.getElementById('lotes-section');

  function toggleInscricaoOptions() {
    const isPaga = inscricaoPaga && inscricaoPaga.checked;
    tiposContainer.style.display = isPaga ? 'block' : 'none';
    habilitarLotesContainer.style.display = isPaga ? 'block' : 'none';
    if (!isPaga) {
      lotesSection.style.display = 'none';
      habilitarLotes.checked = false;
    }
    updatePriceFields();
  }

  function toggleLotesVisibility() {
    lotesSection.style.display = habilitarLotes.checked ? 'block' : 'none';
  }

  toggleInscricaoOptions();
  habilitarLotes.addEventListener('change', toggleLotesVisibility);
  inscricaoGratuita.addEventListener('change', toggleInscricaoOptions);
  if (inscricaoPaga) {
    inscricaoPaga.addEventListener('change', toggleInscricaoOptions);
  }
  
  // Function to update price fields visibility and values
  function updatePriceFields() {
    const isGratuito = inscricaoGratuita.checked;
    
    // Selecionar todos os campos de preço e seus containers
    const precoFields = document.querySelectorAll('input[name="preco_tipo[]"]');
    const precoContainers = document.querySelectorAll('.preco-container');
    
    // Atualizar todos os campos de preço
    precoFields.forEach(field => {
      if (isGratuito) {
        field.value = '0.00';
      }
    });
    
    // Atualizar visibilidade de todos os containers de preço
    precoContainers.forEach(container => {
      container.style.display = isGratuito ? 'none' : 'block';
    });

    // Também atualizar os preços nos lotes
    updateLotePriceFields();
  }
  
  // Verificar estado inicial
  updatePriceFields();

  // Função para adicionar novo tipo de inscrição
  function addTipoInscricao(nome = '', preco = '') {
    const newItem = document.createElement('div');
    newItem.className = 'row mb-3 align-items-center tipo-inscricao-item';
    newItem.innerHTML = `
      <div class="col-md-5 col-sm-12 mb-2 mb-md-0">
        <label class="form-label">Tipo de Inscrição:</label>
        <input type="text" class="form-control border border-secondary bg-white" name="nome_tipo[]" placeholder="Nome do Tipo de Inscrição" value="${nome}">
        <input type="hidden" name="id_tipo[]" value="">
      </div>
      <div class="col-md-3 col-sm-6 mb-2 mb-md-0 preco-container" ${inscricaoGratuita.checked ? 'style="display:none;"' : ''}>
        <label class="form-label">Preço:</label>
        <input type="number" step="0.01" class="form-control border border-secondary bg-white" name="preco_tipo[]"
              placeholder="Preço" value="${inscricaoGratuita.checked ? '0.00' : preco}">
      </div>
      <div class="col-md-2 col-sm-6 mb-2 mb-md-0">
        <label class="form-label">Somente Submissão</label>
        <input type="checkbox" class="form-check-input" name="submission_only[]">
      </div>
      <div class="col-md-2 col-sm-6">
        <button type="button" class="btn btn-danger w-100 remover-tipo-inscricao" data-inscricoes="0">
          <i class="bi bi-trash"></i> Remover
        </button>
      </div>
    `;
    tiposList.appendChild(newItem);
    
    // Atualizar campos após adicionar um novo item
    updatePriceFields();
    
    // Atualizar os campos de preço nos lotes
    updateLotePriceFields();
  }

  // Adicionar tipo de inscrição ao clicar no botão
  document.getElementById('adicionar-tipo-inscricao').addEventListener('click', function() {
    addTipoInscricao();
  });
  
  // Se não houver nenhum tipo de inscrição, adicionar um automaticamente
  if (tiposList.querySelectorAll('.tipo-inscricao-item').length === 0) {
    if (inscricaoGratuita.checked) {
      addTipoInscricao('Inscrição Gratuita', '0.00');
    } else {
      addTipoInscricao('Inscrição Padrão', '');
    }
  }

  // Remover tipo de inscrição
  tiposList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remover-tipo-inscricao') || 
        e.target.closest('.remover-tipo-inscricao')) {
      const button = e.target.classList.contains('remover-tipo-inscricao') ? 
                     e.target : e.target.closest('.remover-tipo-inscricao');
      const row = button.closest('.tipo-inscricao-item');
      
      // Verificar se o tipo tem inscrições vinculadas
      const inscricoes = parseInt(button.getAttribute('data-inscricoes') || '0');
      
      if (inscricoes > 0) {
        // Exibir alerta se houver inscrições
        alert(`Este tipo de inscrição possui ${inscricoes} usuário(s) vinculado(s) e não pode ser removido. Você pode apenas modificar seu nome e preço.`);
        return;
      }
      
      // Verificar se não é o último tipo de inscrição
      if (tiposList.querySelectorAll('.tipo-inscricao-item').length > 1) {
        row.remove();
        // Atualizar os preços nos lotes quando um tipo for removido
        updateLotePriceFields();
      } else {
        // Se for o último, apenas exibir um alerta
        alert('Pelo menos um tipo de inscrição é necessário.');
      }
    }
  });
  
  // Gerenciamento de lotes
  const lotesContainer = document.getElementById('lotes-container');
  const btnAdicionarLote = document.getElementById('adicionar-lote');
  
  // Adicionar evento para alternar entre data e quantidade
  lotesContainer.addEventListener('change', function(e) {
    if (e.target.name && e.target.name.includes('lote_usar_data')) {
      const loteItem = e.target.closest('.lote-item');
      const datasDiv = loteItem.querySelector('.lote-datas');
      const qtdCheckbox = loteItem.querySelector('input[name^="lote_usar_qtd"]');
      
      if (e.target.checked) {
        datasDiv.style.display = 'flex';
        qtdCheckbox.checked = false;
        loteItem.querySelector('.lote-quantidade').style.display = 'none';
      } else {
        datasDiv.style.display = 'none';
      }
    }
    
    if (e.target.name && e.target.name.includes('lote_usar_qtd')) {
      const loteItem = e.target.closest('.lote-item');
      const qtdDiv = loteItem.querySelector('.lote-quantidade');
      const dataCheckbox = loteItem.querySelector('input[name^="lote_usar_data"]');
      
      if (e.target.checked) {
        qtdDiv.style.display = 'block';
        dataCheckbox.checked = false;
        loteItem.querySelector('.lote-datas').style.display = 'none';
      } else {
        qtdDiv.style.display = 'none';
      }
    }
  });
  
  // Adicionar novo lote
  btnAdicionarLote.addEventListener('click', function() {
    const lotesCount = document.querySelectorAll('.lote-item').length;
    const newLoteItem = document.createElement('div');
    newLoteItem.className = 'lote-item card mb-4 shadow-sm';
    
    newLoteItem.innerHTML = `
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Lote ${lotesCount + 1}</h6>
        <button type="button" class="btn btn-sm btn-outline-danger remover-lote">
          <i class="bi bi-trash"></i> Remover
        </button>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
            <label class="form-label">Nome do Lote</label>
            <input type="text" class="form-control border border-secondary bg-white" name="lote_nome[]" placeholder="Ex: Lote ${lotesCount + 1}">
            <input type="hidden" name="lote_id[]" value="">
          </div>
          <div class="col-md-3 col-sm-6 mb-2 mb-md-0">
            <label class="form-label">Ordem</label>
            <input type="number" class="form-control border border-secondary bg-white" name="lote_ordem[]" value="${lotesCount + 1}" min="1">
          </div>
          <div class="col-md-3 col-sm-6">
            <label class="form-label">Status</label>
            <select class="form-select border border-secondary bg-white" name="lote_ativo[]">
              <option value="1" selected>Ativo</option>
              <option value="0">Inativo</option>
            </select>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6 col-sm-12 mb-3 mb-md-0">
            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_data[]" checked>
              <label class="form-check-label">Definir por período</label>
            </div>
            <div class="row lote-datas">
              <div class="col-md-6 col-sm-6 mb-2 mb-md-0">
                <label class="form-label">Data Início</label>
                <input type="date" class="form-control border border-secondary bg-white" name="lote_data_inicio[]">
              </div>
              <div class="col-md-6 col-sm-6">
                <label class="form-label">Data Fim</label>
                <input type="date" class="form-control border border-secondary bg-white" name="lote_data_fim[]">
              </div>
            </div>
          </div>
          <div class="col-md-6 col-sm-12">
            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_qtd[]">
              <label class="form-check-label">Definir por quantidade</label>
            </div>
            <div class="lote-quantidade" style="display: none;">
              <label class="form-label">Quantidade máxima</label>
              <input type="number" class="form-control border border-secondary bg-white" name="lote_qtd_maxima[]" min="1" placeholder="Limite de inscritos">
            </div>
          </div>
        </div>
        
        <hr>
        <h6 class="mb-3">Preços por tipo de inscrição:</h6>
        <div class="lote-precos">
          <!-- Será preenchido pela função updateLotePriceFields -->
        </div>
      </div>
    `;
    
    lotesContainer.appendChild(newLoteItem);
    updateLoteHeaders();
    updateLotePriceFields();
  });
  
  // Remover lote
  lotesContainer.addEventListener('click', function(e) {
    if (e.target.classList.contains('remover-lote') || 
        e.target.closest('.remover-lote')) {
      const button = e.target.classList.contains('remover-lote') ? 
                    e.target : e.target.closest('.remover-lote');
      
      // Verificar se o botão está desabilitado
      if (button.hasAttribute('disabled')) {
        return;
      }
      
      const loteItem = button.closest('.lote-item');
      
      if (document.querySelectorAll('.lote-item').length > 1) {
        loteItem.remove();
        updateLoteHeaders();
      } else {
        alert('É necessário manter pelo menos um lote.');
      }
    }
  });
  
  // Atualizar cabeçalhos dos lotes
  function updateLoteHeaders() {
    const lotes = document.querySelectorAll('.lote-item');
    lotes.forEach((lote, index) => {
      // Só atualizar o cabeçalho se não tiver um nome personalizado
      const nomeInput = lote.querySelector('input[name="lote_nome[]"]');
      const header = lote.querySelector('h6');
      if (!nomeInput.value) {
        header.textContent = `Lote ${index + 1}`;
      }
    });
  }
  
  // Gerar campos de preço para tipos de inscrição nos lotes
  function updateLotePriceFields() {
    const lotePrecosDivs = document.querySelectorAll('.lote-precos');
    const isGratuito = inscricaoGratuita.checked;
    
    lotePrecosDivs.forEach((lotePrecos, loteIndex) => {
      // Removendo esta verificação para sempre recarregar os valores
      // if (lotePrecos.querySelectorAll('input[type="number"]').length > 0) {
      //   return; // Preserva os valores existentes
      // }
      
      let html = '';
      const tiposInscricao = document.querySelectorAll('input[name="nome_tipo[]"]');
      const tiposIds = document.querySelectorAll('input[name="id_tipo[]"]');
      
      if (tiposInscricao.length === 0) {
        html = '<p class="text-warning">Defina os tipos de inscrição primeiro.</p>';
      } else {
        tiposInscricao.forEach((tipo, index) => {
          const tipoNome = tipo.value || `Tipo ${index + 1}`;
          const tipoId = tiposIds[index].value || `new_${index}`;
          const precoDefault = isGratuito ? '0.00' : '';
          
          const loteItem = lotePrecos.closest('.lote-item');
          const loteIdInput = loteItem.querySelector('input[name="lote_id[]"]');
          const loteId = loteIdInput.value || `new_${loteIndex}`;
          
          // Verificar se há um preço definido para este tipo no data-* do lote
          let precoExistente = precoDefault;
          const precoAttr = loteItem.querySelector(`[data-preco-${tipoId}]`);
          if (precoAttr) {
            precoExistente = precoAttr.getAttribute(`data-preco-${tipoId}`);
          }
          
          html += `
            <div class="row mb-2 align-items-center">
              <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
                <label class="form-label">${tipoNome}</label>
                <input type="hidden" name="lote_tipo_id_${loteId}_${tipoId}" value="${tipoId}">
              </div>
              <div class="col-md-6 col-sm-12 preco-container" ${isGratuito ? 'style="display:none;"' : ''}>
                <label class="form-label">Preço (R$)</label>
                <input type="number" step="0.01" class="form-control border border-secondary bg-white" 
                      name="lote_tipo_preco_${loteId}_${tipoId}" 
                      placeholder="0.00" value="${precoExistente}">
              </div>
            </div>
          `;
        });
      }
      
      lotePrecos.innerHTML = html;
    });
  }

  
  // Inicializar os preços dos lotes
  updateLotePriceFields();
  
  // Adicione esta função para garantir que os preços são carregados corretamente
  setTimeout(function() {
    updateLotePriceFields();
  }, 100);
  
  // Validação para garantir pelo menos um tipo de inscrição ao enviar o formulário
  document.querySelector('form').addEventListener('submit', function(e) {
    const tiposItems = tiposList.querySelectorAll('.tipo-inscricao-item');
    
    if (tiposItems.length === 0) {
      e.preventDefault();
      alert('Você precisa definir pelo menos um tipo de inscrição.');
      return;
    }
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    let camposVazios = false;
    tiposItems.forEach(item => {
      const nomeTipo = item.querySelector('input[name="nome_tipo[]"]');
      if (!nomeTipo.value.trim()) {
        camposVazios = true;
      }
    });
    
    if (camposVazios) {
      e.preventDefault();
      alert('Todos os tipos de inscrição precisam ter um nome.');
      return;
    }
    
    // Verificar lotes apenas se estiverem habilitados
    if (habilitarLotes.checked) {
      // Verificar se há pelo menos um lote
      const loteItems = lotesContainer.querySelectorAll('.lote-item');
      
      if (loteItems.length === 0) {
        e.preventDefault();
        alert('Você precisa definir pelo menos um lote de inscrição.');
        return;
      }
      
      // Verificar se todos os lotes estão corretamente configurados
      let lotesInvalidos = false;
      loteItems.forEach(item => {
        const nomeLote = item.querySelector('input[name="lote_nome[]"]');
        const usaData = item.querySelector('input[name^="lote_usar_data"]').checked;
        const usaQtd = item.querySelector('input[name^="lote_usar_qtd"]').checked;
        
        if (!nomeLote.value.trim()) {
          lotesInvalidos = true;
        }
        
        if (usaData) {
          const dataInicio = item.querySelector('input[name="lote_data_inicio[]"]');
          const dataFim = item.querySelector('input[name="lote_data_fim[]"]');
          
          if (!dataInicio.value || !dataFim.value) {
            lotesInvalidos = true;
          }
        }
        
        if (usaQtd) {
          const qtdMaxima = item.querySelector('input[name="lote_qtd_maxima[]"]');
          
          if (!qtdMaxima.value || parseInt(qtdMaxima.value) <= 0) {
            lotesInvalidos = true;
          }
        }
        
        if (!usaData && !usaQtd) {
          lotesInvalidos = true;
        }
      });
      
      if (lotesInvalidos) {
        e.preventDefault();
        alert('Todos os lotes precisam ter um nome e um critério de definição (período ou quantidade) completo.');
        return;
      }
    }
    
    // Verificar se todos os tipos de inscrição com usuários vinculados continuam no formulário
    const idCampos = document.querySelectorAll('input[name="id_tipo[]"]');
    let idsPreservados = [];
    
    idCampos.forEach(campo => {
      if (campo.value) {
        idsPreservados.push(campo.value);
      }
    });
    
    // Adicionar campo especial para marcar IDs a serem preservados no servidor
    const preservarIdsInput = document.createElement('input');
    preservarIdsInput.type = 'hidden';
    preservarIdsInput.name = 'preservar_ids_tipo';
    preservarIdsInput.value = idsPreservados.join(',');
    this.appendChild(preservarIdsInput);
    
    // Adicionar campo para lotes preservados
    const idLotes = document.querySelectorAll('input[name="lote_id[]"]');
    let idsLotesPreservados = [];
    
    idLotes.forEach(campo => {
      if (campo.value) {
        idsLotesPreservados.push(campo.value);
      }
    });
    
    const preservarLotesInput = document.createElement('input');
    preservarLotesInput.type = 'hidden';
    preservarLotesInput.name = 'preservar_ids_lote';
    preservarLotesInput.value = idsLotesPreservados.join(',');
    this.appendChild(preservarLotesInput);
  });
});
</script>

  <script>
  function carregarEvento(eventoId) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentStep = urlParams.get('step');
    let targetUrl = "{{ url_for('evento_routes.configurar_evento') }}";
    if (eventoId) {
      targetUrl += `?evento_id=${eventoId}`;
      if (currentStep) {
        targetUrl += `&step=${currentStep}`;
      }
    } else if (currentStep) {
      targetUrl += `?step=${currentStep}`;
    }
    window.location.href = targetUrl;
  }

  // Código para controle de etapas quando não há pagamento habilitado
  document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('inscricao_gratuita')) {
      // Controle de etapas básico
      const progressBar = document.getElementById('progress-bar');
      const steps = document.querySelectorAll('.step');
      let currentStep = 1;
      const urlStep = parseInt(new URLSearchParams(window.location.search).get('step'));
      if (urlStep && urlStep >= 1 && urlStep <= steps.length) {
        currentStep = urlStep;
      }
      steps.forEach((el, idx) => {
        el.style.display = idx + 1 === currentStep ? 'block' : 'none';
      });
      updateProgressBar(currentStep);

      // Atualizar barra de progresso
      function updateProgressBar(step) {
        const totalSteps = steps.length > 0 ? steps.length : 3; // Ajustado para 3 etapas mínimas
        const percent = (step / totalSteps) * 100;
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
        progressBar.textContent = `Etapa ${step} de ${totalSteps}`;
      }

      // Navegar para próxima etapa
      document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', function() {
          const nextStep = parseInt(this.getAttribute('data-next'));
          
          // Esconder etapa atual
          document.getElementById(`step-${currentStep}`).style.display = 'none';
          
          // Mostrar próxima etapa
          document.getElementById(`step-${nextStep}`).style.display = 'block';
          
          // Atualizar etapa atual
          currentStep = nextStep;
          
          // Atualizar barra de progresso
          updateProgressBar(currentStep);
          
          // Rolar para o topo do formulário
          window.scrollTo({top: 0, behavior: 'smooth'});
        });
      });

      // Navegar para etapa anterior
      document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', function() {
          const prevStep = parseInt(this.getAttribute('data-prev'));
          
          // Esconder etapa atual
          document.getElementById(`step-${currentStep}`).style.display = 'none';
          
          // Mostrar etapa anterior
          document.getElementById(`step-${prevStep}`).style.display = 'block';
          
          // Atualizar etapa atual
          currentStep = prevStep;
          
          // Atualizar barra de progresso
          updateProgressBar(currentStep);
          
          // Rolar para o topo do formulário
          window.scrollTo({top: 0, behavior: 'smooth'});
        });
      });

      // Inicializar a barra de progresso
      updateProgressBar(1);
    }
  });
</script>

<!-- Link para o Leaflet - Mapa Gratuito -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<!-- Script do Localizador de Lugares -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Variáveis globais
    let map;
    let marker;
    let currentLocation = {
      lat: {{ evento.latitude|default(-15.77972, true) }},
      lng: {{ evento.longitude|default(-47.92972, true) }}
    };
    let suggestionTimeout;

    // Configuração de sugestões para o campo de localização
    const localizacaoInput = document.getElementById('localizacao-input');
    const suggestionsContainer = document.getElementById('suggestions');
    
    // Configurar o mapa quando o modal for aberto
    document.getElementById('mapaModal').addEventListener('shown.bs.modal', function () {
      if (!map) {
       initMap();
     }
     
     // Centralize no local salvo, se existir
     if (document.getElementById('latitude').value && document.getElementById('longitude').value) {
       const lat = parseFloat(document.getElementById('latitude').value);
       const lng = parseFloat(document.getElementById('longitude').value);
       map.setView([lat, lng], 15);
       
       if (marker) {
         marker.setLatLng([lat, lng]);
       } else {
         marker = L.marker([lat, lng]).addTo(map);
       }
       
       // Mostrar detalhes do local
       showLocationDetails(lat, lng);
     }
   });
   
   // Inicializar o mapa
  function initMap() {
    map = L.map('mapa-container').setView([currentLocation.lat, currentLocation.lng], 13);

      const stay22Layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/stay22/{z}/{x}/{y}{r}.png?api_key=5b05060b-8e26-4d1c-bcaa-306d76157824', {
        maxZoom: 20,
        attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a> &copy; OpenStreetMap contributors'
      }).addTo(map);

      stay22Layer.on('tileerror', function() {
        map.removeLayer(stay22Layer);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      });
     
     // Adicionar marker no mapa se já existir localização
     if (document.getElementById('latitude').value && document.getElementById('longitude').value) {
       const lat = parseFloat(document.getElementById('latitude').value);
       const lng = parseFloat(document.getElementById('longitude').value);
       marker = L.marker([lat, lng]).addTo(map);
     }
     
     // Permitir clicar no mapa para selecionar local
     map.on('click', function(e) {
       const lat = e.latlng.lat;
       const lng = e.latlng.lng;
       
       // Atualizar ou criar marcador
       if (marker) {
         marker.setLatLng([lat, lng]);
       } else {
         marker = L.marker([lat, lng]).addTo(map);
       }
       
       showLocationDetails(lat, lng);
     });
   }
   
   // Geocoding reverso usando Nominatim como fallback
   function reverseGeocodeWithNominatim(lat, lng) {
     console.log('Usando Nominatim para geocoding reverso:', lat, lng);
     const nominatimReverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
     console.log('URL do Nominatim reverso:', nominatimReverseUrl);
     
     return fetch(nominatimReverseUrl)
       .then(response => {
         if (!response.ok) {
           throw new Error(`Nominatim reverso HTTP ${response.status}: ${response.statusText}`);
         }
         return response.json();
       })
       .then(data => {
         console.log('Dados do Nominatim reverso:', data);
         return data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
       });
   }
   
   // Mostrar detalhes do local selecionado
   function showLocationDetails(lat, lng) {
     document.getElementById('endereco-detalhes').classList.remove('d-none');
     document.getElementById('info-latitude').textContent = lat.toFixed(6);
     document.getElementById('info-longitude').textContent = lng.toFixed(6);
     
     // Fazer geocoding reverso para obter o endereço
     console.log('Fazendo geocoding reverso para:', lat, lng);
     const reverseUrl = `https://api.stadiamaps.com/geocoding/v1/reverse?point.lat=${lat}&point.lon=${lng}&apikey=5b05060b-8e26-4d1c-bcaa-306d76157824`;
     console.log('URL do geocoding reverso:', reverseUrl);
     
      fetch(reverseUrl)
        .then(response => {
          console.log('Status do geocoding reverso:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Dados do geocoding reverso:', data);
          if (data && data.features && data.features.length > 0) {
            return data.features[0].properties.label;
          } else {
            throw new Error('Nenhum resultado encontrado');
          }
        })
        .catch(error => {
          console.warn('Erro na API Stadia Maps para geocoding reverso, tentando Nominatim:', error);
          return reverseGeocodeWithNominatim(lat, lng);
        })
        .then(address => {
          document.getElementById('endereco-completo').textContent = address;
          currentLocation = {
            lat: lat,
            lng: lng,
            address: address
          };
        })
       .catch(error => {
         console.error('Erro em ambas as APIs de geocoding reverso:', error);
         const fallbackAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
         document.getElementById('endereco-completo').textContent = fallbackAddress;
         currentLocation = {
           lat: lat,
           lng: lng,
           address: fallbackAddress
         };
       });
   }
   
   // Buscar locais usando Nominatim (OpenStreetMap) como fallback
   function searchWithNominatim(query, modalSearch = false) {
     console.log('Usando Nominatim como fallback para:', query);
     const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`;
     console.log('URL do Nominatim:', nominatimUrl);
     
     return fetch(nominatimUrl)
       .then(response => {
         if (!response.ok) {
           throw new Error(`Nominatim HTTP ${response.status}: ${response.statusText}`);
         }
         return response.json();
       })
       .then(data => {
         console.log('Dados do Nominatim:', data);
         
         // Converter formato do Nominatim para o formato esperado
         const convertedData = {
           features: data.map(item => ({
             geometry: {
               coordinates: [parseFloat(item.lon), parseFloat(item.lat)]
             },
             properties: {
               label: item.display_name
             }
           }))
         };
         
         return convertedData;
       });
   }
   
   // Buscar locais com base no texto digitado
   function searchPlaces(query, modalSearch = false) {
     const searchInput = modalSearch ? document.getElementById('modal-search-input') : localizacaoInput;
     
     if (query.length < 3) return;
     
     console.log('Iniciando busca para:', query);
     const apiUrl = `https://api.stadiamaps.com/geocoding/v1/search?text=${encodeURIComponent(query)}&apikey=5b05060b-8e26-4d1c-bcaa-306d76157824`;
     console.log('URL da API:', apiUrl);
     
      fetch(apiUrl)
        .then(response => {
          console.log('Status da resposta:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Dados recebidos:', data);
          return data;
        })
        .catch(error => {
          console.warn('Erro na API Stadia Maps, tentando Nominatim:', error);
          return searchWithNominatim(query, modalSearch);
        })
        .then(data => {
         if (modalSearch) {
           // Se for busca no modal, centraliza o primeiro resultado no mapa
           if (data.features && data.features.length > 0) {
             const feature = data.features[0];
             const coords = feature.geometry.coordinates;
             const lat = coords[1];
             const lng = coords[0];
             
             map.setView([lat, lng], 15);
             
             if (marker) {
               marker.setLatLng([lat, lng]);
             } else {
               marker = L.marker([lat, lng]).addTo(map);
             }
             
             showLocationDetails(lat, lng);
           }
         } else {
           // Se for busca no campo, mostra sugestões
           suggestionsContainer.innerHTML = '';
           
           if (data.features && data.features.length > 0) {
             data.features.forEach(feature => {
               const coords = feature.geometry.coordinates;
               const label = feature.properties.label;

               const item = document.createElement('div');
               item.className = 'suggestion-item';
               item.textContent = label;
               item.addEventListener('click', function() {
                 localizacaoInput.value = label;
                 document.getElementById('latitude').value = coords[1];
                 document.getElementById('longitude').value = coords[0];
                 document.getElementById('link_mapa').value = `https://www.google.com/maps?q=${coords[1]},${coords[0]}`;
                 suggestionsContainer.style.display = 'none';
               });

               suggestionsContainer.appendChild(item);
             });
             
             suggestionsContainer.style.display = 'block';
           } else {
             suggestionsContainer.style.display = 'none';
           }
         }
       })
       .catch(error => {
         console.error('Erro na busca:', error);
       });
   }
   
   // Event listener para o campo de localização
   localizacaoInput.addEventListener('input', function() {
     const query = this.value.trim();
     
     // Limpar timeout anterior
     if (suggestionTimeout) {
       clearTimeout(suggestionTimeout);
     }
     
     // Esperar um pouco antes de buscar para evitar muitas requisições
     suggestionTimeout = setTimeout(() => {
       if (query.length >= 3) {
         searchPlaces(query);
       } else {
         suggestionsContainer.style.display = 'none';
       }
     }, 300);
   });
   
   // Esconder sugestões ao clicar fora
   document.addEventListener('click', function(e) {
     if (e.target !== localizacaoInput && !suggestionsContainer.contains(e.target)) {
       suggestionsContainer.style.display = 'none';
     }
   });
   
   // Buscar no modal
   document.getElementById('modal-search-btn').addEventListener('click', function() {
     const query = document.getElementById('modal-search-input').value.trim();
     if (query.length >= 3) {
       searchPlaces(query, true);
     }
   });
   
   // Tecla Enter no campo de busca do modal
   document.getElementById('modal-search-input').addEventListener('keypress', function(e) {
     if (e.key === 'Enter') {
       e.preventDefault();
       document.getElementById('modal-search-btn').click();
     }
   });
   
   // Selecionar local do mapa
   document.getElementById('btn-selecionar-local').addEventListener('click', function() {
     if (currentLocation) {
       // Preencher campos com informações do local selecionado
       document.getElementById('latitude').value = currentLocation.lat;
       document.getElementById('longitude').value = currentLocation.lng;
       document.getElementById('localizacao-input').value = currentLocation.address || '';
       
       // Gerar link do Google Maps
       document.getElementById('link_mapa').value = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}`;
     }
   });
 });

 // Price masking functionality
document.addEventListener('DOMContentLoaded', function() {
  // Format number as Brazilian currency
  function formatAsCurrency(value) {
    const number = parseFloat(value);
    if (isNaN(number)) return '';
    
    return number.toLocaleString('pt-BR', {
      style: 'currency',
      currency: 'BRL',
      minimumFractionDigits: 2
    });
  }
  
  // Apply mask to price inputs
  function applyPriceMask() {
    // Select all price inputs that haven't been masked yet
    document.querySelectorAll('input[name="preco_tipo[]"]:not([data-masked]), input[name^="lote_tipo_preco_"]:not([data-masked])').forEach(input => {
      // Mark as masked
      input.setAttribute('data-masked', 'true');
      
      // Create display element for formatted value
      const display = document.createElement('div');
      display.className = 'price-mask-display';
      display.style.position = 'absolute';
      display.style.top = '0';
      display.style.left = '0';
      display.style.width = '100%';
      display.style.height = '100%';
      display.style.backgroundColor = 'white';
      display.style.display = 'flex';
      display.style.alignItems = 'center';
      display.style.paddingLeft = '12px';
      display.style.paddingRight = '12px';
      display.style.pointerEvents = 'none';
      display.style.borderRadius = 'inherit';
      display.style.fontSize = 'inherit';
      display.style.color = 'inherit';
      display.style.fontFamily = 'inherit';
      display.style.zIndex = '1';
      
      // Make input container position relative
      const container = input.parentElement;
      if (window.getComputedStyle(container).position === 'static') {
        container.style.position = 'relative';
      }
      
      // Add display element to DOM
      container.appendChild(display);
      
      // Initially update display
      if (input.value) {
        display.textContent = formatAsCurrency(input.value);
        display.style.display = 'flex';
      } else {
        display.style.display = 'none';
      }
      
      // Show/hide display on focus/blur
      input.addEventListener('focus', function() {
        display.style.display = 'none';
      });
      
      input.addEventListener('blur', function() {
        if (this.value) {
          display.textContent = formatAsCurrency(this.value);
          display.style.display = 'flex';
        } else {
          display.style.display = 'none';
        }
      });
      
      // Update display when value changes
      input.addEventListener('input', function() {
        display.style.display = 'none';
      });
    });
  }
  
  // Apply price masks initially
  applyPriceMask();
  
  // Apply masks when new price fields are added
  const observer = new MutationObserver(function(mutations) {
    let shouldUpdate = false;
    
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length) {
        shouldUpdate = true;
      }
    });
    
    if (shouldUpdate) {
      applyPriceMask();
    }
  });
  
  observer.observe(document.body, { childList: true, subtree: true });
  
  // Also apply masks when buttons are clicked that add new price fields
  ['#adicionar-tipo-inscricao', '#adicionar-lote'].forEach(function(selector) {
    const button = document.querySelector(selector);
    if (button) {
      button.addEventListener('click', function() {
        setTimeout(applyPriceMask, 100);
      });
    }
  });
  
  // Re-apply masks when the gratuity checkbox changes
  const gratuitoCheckbox = document.getElementById('inscricao_gratuita');
  if (gratuitoCheckbox) {
    gratuitoCheckbox.addEventListener('change', function() {
      setTimeout(applyPriceMask, 100);
    });
  }
});
</script>

<!-- Bootstrap JS (caso não esteja no base.html) -->
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
{% endblock %}