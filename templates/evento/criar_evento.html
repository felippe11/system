{% extends "base.html" %}
{% block title %}Criar Evento{% endblock %}

{% block content %}
<!-- Dependências -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<div class="container py-5">
  <input type="hidden" id="pagamento_habilitado" value="1">
  <!-- Cabeçalho -->
  <div class="bg-primary bg-gradient rounded-3 p-4 mb-4 shadow-sm">
    <h1 class="h3 fw-bold text-white mb-0">
      <i class="bi bi-calendar-event me-2"></i>Criar Novo Evento
    </h1>
  </div>

  <!-- Barra de progresso moderna com indicadores de etapa -->
  <div class="progress-container mb-4">
    <div class="progress-steps-container">
      <div class="step-indicator-container">
        <div class="step-indicator active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">Informações Básicas</div>
        </div>
        <div class="step-indicator" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">Data e Horário</div>
        </div>
        <div class="step-indicator" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">Localização</div>
        </div>
        <div class="step-indicator" data-step="4">
          <div class="step-number">4</div>
          <div class="step-label">Inscrição</div>
        </div>
      </div>
      <div class="progress progress-bar-modern">
        <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
  </div>

  <!-- Card principal do formulário -->
  <div class="card border-0 shadow">
    <div class="card-body rounded-3 p-4 bg-light">
      <!-- Formulário -->
      <form method="POST" enctype="multipart/form-data" id="form-evento">
        <input type="hidden" name="evento_id" value="">
        <input type="hidden" id="latitude" name="latitude" value="">
        <input type="hidden" id="longitude" name="longitude" value="">
        <input type="hidden" id="link_mapa" name="link_mapa" value="">
        
        <!-- Etapa 1: Informações Básicas -->
        <div class="step" id="step-1">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-info-circle me-2"></i>Informações Básicas
            </h5>
          </div>
          
          <div class="mb-4">
            <label class="form-label fw-bold">Nome do Evento</label>
            <input type="text" name="nome" class="form-control form-control-lg border border-secondary bg-white" required>
          </div>
          <div class="mb-4">
            <label class="form-label fw-bold">Descrição</label>
            <textarea name="descricao" class="form-control form-control-lg border border-secondary bg-white" rows="3" placeholder="Descreva os detalhes do seu evento"></textarea>
          </div>
          
          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-primary next-step px-4" data-next="2">
              Próximo <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Etapa 2: Data e Horário -->
        <div class="step" id="step-2" style="display: none;">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-calendar me-2"></i>Data e Horário
            </h5>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-4">
              <label class="form-label fw-bold">Data de Início</label>
              <input type="date" class="form-control border border-secondary bg-white" name="data_inicio">
            </div>
            
            <div class="col-md-6 mb-4">
              <label class="form-label fw-bold">Data de Término</label>
              <input type="date" class="form-control border border-secondary bg-white" name="data_fim">
            </div>
            
            <div class="col-md-6 mb-4">
              <label class="form-label fw-bold">Hora de Início</label>
              <input type="time" class="form-control border border-secondary bg-white" name="hora_inicio">
            </div>
            
            <div class="col-md-6 mb-4">
              <label class="form-label fw-bold">Hora de Término</label>
              <input type="time" class="form-control border border-secondary bg-white" name="hora_fim">
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="1">
              <i class="bi bi-arrow-left me-2"></i> Anterior
            </button>
            <button type="button" class="btn btn-primary next-step px-4" data-next="3">
              Próximo <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Etapa 3: Localização -->
        <div class="step" id="step-3" style="display: none;">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-geo-alt me-2"></i>Localização
            </h5>
          </div>
          
          <div class="mb-4">
            <label class="form-label fw-bold">Endereço do Evento</label>
            <div class="input-group">
              <input type="text" id="localizacao-input" name="localizacao" class="form-control border border-secondary bg-white" placeholder="Ex: Av. Paulista, 1000 - São Paulo, SP" autocomplete="off">
              <button type="button" class="btn btn-primary" id="btn-mostrar-mapa" data-bs-toggle="modal" data-bs-target="#mapaModal">
                <i class="bi bi-geo-alt"></i> Buscar no Mapa
              </button>
            </div>
            <div class="suggestions-container position-relative">
              <div id="suggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="border-bottom border-primary pb-2 mb-3">
              <h5 class="text-primary d-flex align-items-center">
                <i class="bi bi-image me-2"></i>Mídia
              </h5>
            </div>
            <label class="form-label fw-bold">Banner do Evento</label>
            <input type="file" name="banner" class="form-control border border-secondary bg-white" accept="image/*">
            <div class="form-text">Recomendado: Imagem no formato 1200 x 600px</div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="2">
              <i class="bi bi-arrow-left me-2"></i> Anterior
            </button>
            <button type="button" class="btn btn-primary next-step px-4" data-next="4">
              Próximo <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Etapa 4: Configuração de Inscrição -->
        <div class="step" id="step-4" style="display: none;">
          <div class="border-bottom border-primary pb-2 mb-4">
            <h5 class="text-primary d-flex align-items-center">
              <i class="bi bi-cash-coin me-2"></i>Configuração de Inscrição
            </h5>
          </div>
          

          
          <!-- Opções de Tipo de Inscrição -->
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <div class="card h-100 hover-shadow cursor-pointer inscription-type-card" 
                   onclick="document.getElementById('inscricaoGratuita').click()">
                <div class="card-body p-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="inscricao_gratuita" 
                           id="inscricaoGratuita" value="1" checked>
                    <label class="form-check-label w-100" for="inscricaoGratuita">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-ticket-fill fs-3 text-success me-2"></i>
                        <h6 class="mb-0">Inscrição Gratuita</h6>
                      </div>
                      <p class="text-muted small mb-0">Evento sem cobrança de taxa de inscrição</p>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100 hover-shadow cursor-pointer inscription-type-card"
                   onclick="document.getElementById('inscricaoPaga').click()">
                <div class="card-body p-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="inscricao_gratuita"
                           id="inscricaoPaga" value="0">
                    <label class="form-check-label w-100" for="inscricaoPaga">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-credit-card-fill fs-3 text-primary me-2"></i>
                        <h6 class="mb-0">Inscrição Paga</h6>
                      </div>
                      <p class="text-muted small mb-0">Evento com cobrança de taxa de inscrição</p>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-white shadow-sm border-0 mb-4" id="tipos-inscricao-section" style="display: none;">
            <div class="card-body">
              <h6 class="card-title fw-bold mb-3">Tipos de Inscrição</h6>
              <p class="text-muted small mb-3">Configure os tipos de inscrição e seus respectivos valores:</p>
              <div id="tipos-inscricao-list">
                <div class="row mb-3 align-items-center tipo-inscricao-item">
                  <div class="col-md-5 col-sm-12 mb-2 mb-md-0">
                    <label class="form-label">Tipo de Inscrição:</label>
                    <input type="text" class="form-control border border-secondary bg-white" name="nome_tipo[]" placeholder="Nome do Tipo de Inscrição">
                    <input type="hidden" name="id_tipo[]" value="">
                  </div>
                  <div class="col-md-3 col-sm-6 mb-2 mb-md-0 preco-container">
                    <label class="form-label">Preço:</label>
                    <input type="number" step="0.01" class="form-control border border-secondary bg-white" name="preco_tipo[]" placeholder="Preço">
                  </div>
                  <div class="col-md-2 col-sm-6 mb-2 mb-md-0">
                    <label class="form-label">Somente Submissão</label>
                    <input type="checkbox" class="form-check-input" name="submission_only[]">
                  </div>
                  <div class="col-md-2 col-sm-6">
                    <button type="button" class="btn btn-danger w-100 remover-tipo-inscricao" data-inscricoes="0">
                      <i class="bi bi-trash"></i> Remover
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" id="adicionar-tipo-inscricao" class="btn btn-outline-primary mt-2">
                <i class="bi bi-plus-circle me-1"></i> Adicionar Tipo de Inscrição
              </button>
            </div>
          </div>
          
          <div class="form-check form-switch mb-3" id="habilitar-lotes-container" style="display: none;">
            <input type="checkbox" class="form-check-input" id="habilitar_lotes" name="habilitar_lotes">
            <label class="form-check-label" for="habilitar_lotes">
              Habilitar inscrição em lotes
            </label>
            <small class="form-text text-muted d-block mt-1">
              Quando marcado, você poderá configurar diferentes lotes de inscrição com preços e períodos específicos.
            </small>
          </div>
          
          <div id="lotes-section" class="mb-4" style="display:none;">
            <div class="border-bottom border-primary pb-2 mb-4">
              <h5 class="text-primary d-flex align-items-center">
                <i class="bi bi-layers me-2"></i>Lotes de Inscrição
              </h5>
            </div>
            
            <p class="text-muted small mb-3">Configure os lotes de inscrição para definir preços por período ou quantidade:</p>
            
            <div id="lotes-container">
              <!-- Lote padrão para novos eventos -->
              <div class="lote-item card mb-4 shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">Lote 1</h6>
                  <button type="button" class="btn btn-sm btn-outline-danger remover-lote">
                    <i class="bi bi-trash"></i> Remover
                  </button>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
                      <label class="form-label">Nome do Lote</label>
                      <input type="text" class="form-control border border-secondary bg-white" name="lote_nome[]" placeholder="Ex: Lote Promocional">
                      <input type="hidden" name="lote_id[]" value="">
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2 mb-md-0">
                      <label class="form-label">Ordem</label>
                      <input type="number" class="form-control border border-secondary bg-white" name="lote_ordem[]" value="1" min="1">
                    </div>
                    <div class="col-md-3 col-sm-6">
                      <label class="form-label">Status</label>
                      <select class="form-select border border-secondary bg-white" name="lote_ativo[]">
                        <option value="1" selected>Ativo</option>
                        <option value="0">Inativo</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6 col-sm-12 mb-3 mb-md-0">
                      <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_data[]" checked>
                        <label class="form-check-label">Definir por período</label>
                      </div>
                      <div class="row lote-datas">
                        <div class="col-md-6 col-sm-6 mb-2 mb-md-0">
                          <label class="form-label">Data Início</label>
                          <input type="date" class="form-control border border-secondary bg-white" name="lote_data_inicio[]">
                        </div>
                        <div class="col-md-6 col-sm-6">
                          <label class="form-label">Data Fim</label>
                          <input type="date" class="form-control border border-secondary bg-white" name="lote_data_fim[]">
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 col-sm-12">
                      <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_qtd[]">
                        <label class="form-check-label">Definir por quantidade</label>
                      </div>
                      <div class="lote-quantidade" style="display: none;">
                        <label class="form-label">Quantidade máxima</label>
                        <input type="number" class="form-control border border-secondary bg-white" name="lote_qtd_maxima[]" min="1" placeholder="Limite de inscritos">
                      </div>
                    </div>
                  </div>
                  
                  <hr>
                  <h6 class="mb-3">Preços por tipo de inscrição:</h6>
                  <div class="lote-precos">
                    <!-- Os campos de preços serão gerados dinamicamente com base nos tipos de inscrição -->
                  </div>
                </div>
              </div>
            </div>
            
            <button type="button" id="adicionar-lote" class="btn btn-outline-primary mt-2">
              <i class="bi bi-plus-circle me-1"></i> Adicionar Lote
            </button>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary prev-step px-4" data-prev="3">
              <i class="bi bi-arrow-left me-2"></i> Anterior
            </button>
            <button type="submit" class="btn btn-success px-4">
              <i class="bi bi-save me-2"></i>Salvar Evento
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para o Mapa -->
<div class="modal fade" id="mapaModal" tabindex="-1" aria-labelledby="mapaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mapaModalLabel">Localizar Endereço</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3 position-relative">
          <input type="text" id="modal-search-input" class="form-control" placeholder="Digite um lugar para pesquisar..." autocomplete="off">
          <button id="modal-search-btn" class="btn btn-primary" type="button">Buscar</button>
          <div id="modal-suggestions" class="list-group position-absolute w-100 bg-white shadow-sm" style="top: 100%; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;"></div>
        </div>
        <div id="mapa-container" style="height: 400px;"></div>
        <div id="endereco-detalhes" class="mt-3 p-3 bg-light rounded d-none">
          <h6 class="fw-bold">Detalhes do Local:</h6>
          <p id="endereco-completo" class="mb-1"></p>
          <p class="mb-1">Latitude: <span id="info-latitude"></span></p>
          <p class="mb-1">Longitude: <span id="info-longitude"></span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-selecionar-local" data-bs-dismiss="modal">Selecionar Este Local</button>
      </div>
    </div>
  </div>
</div>

<!-- CSS para Estilos -->
<style>
.suggestion-item {
  padding: 8px 15px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}
.suggestion-item:hover {
  background-color: #f0f7ff;
}

/* Barra de progresso moderna */
.progress-container {
  margin: 30px 0;
}

.progress-steps-container {
  position: relative;
}

.step-indicator-container {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
}

.step-indicator {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  flex: 1;
  max-width: 20%;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #e9ecef;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  color: #6c757d;
  margin-bottom: 8px;
  transition: all 0.3s ease;
  border: 2px solid #dee2e6;
}

.step-label {
  font-size: 0.8rem;
  text-align: center;
  color: #6c757d;
  transition: color 0.3s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%;
}

.step-indicator.active .step-number {
  background-color: var(--bs-primary);
  color: white;
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
}

.step-indicator.active .step-label {
  color: var(--bs-primary);
  font-weight: bold;
}

.step-indicator.completed .step-number {
  background-color: #198754;
  color: white;
  border-color: #198754;
}

.progress-bar-modern {
  height: 8px;
  position: absolute;
  top: 20px;
  left: 0;
  right: 0;
  z-index: 0;
  margin: 0 20px;
}

/* Melhorias para dispositivos móveis */
@media (max-width: 768px) {
  .step-label {
    font-size: 0.7rem;
  }
  
  .step-number {
    width: 30px;
    height: 30px;
    font-size: 0.8rem;
  }
  
  .progress-bar-modern {
    top: 15px;
  }
  
  .container {
    padding-left: 10px;
    padding-right: 10px;
  }
  
  h5.text-primary {
    font-size: 1.1rem;
  }
  
  .card-body {
    padding: 1rem;
  }
  
  .next-step, .prev-step {
    width: 45%;
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
    font-size: 0.9rem;
  }
  
  .remover-tipo-inscricao, .remover-lote {
    margin-top: 10px;
  }
}

/* Para telas muito pequenas */
@media (max-width: 576px) {
  .step-label {
    display: none;
  }
  
  .progress-bar-modern {
    margin: 0 15px;
  }
}

/* Animações e estilos visuais */
.step:not([style*="display: none"]) {
  animation: fadeIn 0.5s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Cards de inscrição */
.inscription-type-card {
  transition: all 0.3s ease;
  cursor: pointer;
  border-radius: 0.5rem;
}

.inscription-type-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
}

.inscription-type-card .form-check-input:checked + .form-check-label {
  color: var(--bs-primary);
}

/* Melhorias visuais para formulários */
.form-label {
  margin-bottom: 0.3rem;
}

.card {
  border-radius: 0.5rem;
  transition: box-shadow 0.3s ease;
}

.card:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.btn {
  border-radius: 0.35rem;
  transition: all 0.2s;
}

/* Melhorias para lotes */
.lote-item {
  border-radius: 0.5rem;
  overflow: hidden;
}

.lote-item .card-header {
  background-color: rgba(0, 123, 255, 0.1);
}
</style>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Controle de etapas
  const progressBar = document.getElementById('progress-bar');
  const steps = document.querySelectorAll('.step');
  let currentStep = 1;

  // Atualizar barra de progresso e indicadores
  function updateProgressBar(step) {
    const totalSteps = steps.length;
    const percent = (step / totalSteps) * 100;
    
    // Atualizar a barra de progresso
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
    
    // Atualizar os indicadores de etapa
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
      if (index + 1 < step) {
        indicator.classList.add('completed');
        indicator.classList.remove('active');
      } else if (index + 1 === step) {
        indicator.classList.add('active');
        indicator.classList.remove('completed');
      } else {
        indicator.classList.remove('active', 'completed');
      }
    });
  }

  // Navegar para próxima etapa
  document.querySelectorAll('.next-step').forEach(button => {
    button.addEventListener('click', function() {
      const nextStep = parseInt(this.getAttribute('data-next'));
      
      // Esconder etapa atual
      document.getElementById(`step-${currentStep}`).style.display = 'none';
      
      // Mostrar próxima etapa
      document.getElementById(`step-${nextStep}`).style.display = 'block';
      
      // Atualizar etapa atual
      currentStep = nextStep;
      
      // Atualizar barra de progresso
      updateProgressBar(currentStep);
      
      // Rolar para o topo do formulário
      window.scrollTo({top: 0, behavior: 'smooth'});
    });
  });

  // Navegar para etapa anterior
  document.querySelectorAll('.prev-step').forEach(button => {
    button.addEventListener('click', function() {
      const prevStep = parseInt(this.getAttribute('data-prev'));
      
      // Esconder etapa atual
      document.getElementById(`step-${currentStep}`).style.display = 'none';
      
      // Mostrar etapa anterior
      document.getElementById(`step-${prevStep}`).style.display = 'block';
      
      // Atualizar etapa atual
      currentStep = prevStep;
      
      // Atualizar barra de progresso
      updateProgressBar(currentStep);
      
      // Rolar para o topo do formulário
      window.scrollTo({top: 0, behavior: 'smooth'});
    });
  });

  // Toggle para configurações de inscrição
  const inscricaoGratuita = document.getElementById('inscricaoGratuita');
  const inscricaoPaga = document.getElementById('inscricaoPaga');
  const tiposInscricaoSection = document.getElementById('tipos-inscricao-section');
  const habilitarLotesContainer = document.getElementById('habilitar-lotes-container');
  const habilitarLotes = document.getElementById('habilitar_lotes');
  const lotesSection = document.getElementById('lotes-section');
  
  // Inicialização dos tipos de inscrição
  function toggleInscricaoOptions() {
    const isPaga = inscricaoPaga.checked;
    
    // Mostrar ou ocultar seção de tipos de inscrição
    tiposInscricaoSection.style.display = isPaga ? 'block' : 'none';
    habilitarLotesContainer.style.display = isPaga ? 'block' : 'none';
    
    // Se for gratuita, esconder lotes também
    if (!isPaga) {
      lotesSection.style.display = 'none';
      habilitarLotes.checked = false;
    }
  }
  
  // Adicionar event listeners para os radio buttons
  inscricaoGratuita.addEventListener('change', toggleInscricaoOptions);
  inscricaoPaga.addEventListener('change', toggleInscricaoOptions);
  
  // Inicializar estado
  toggleInscricaoOptions();
  
  // Toggle para lotes
  habilitarLotes.addEventListener('change', function() {
    lotesSection.style.display = this.checked ? 'block' : 'none';
  });
  
  // Gerenciamento de tipos de inscrição
  const tiposList = document.getElementById('tipos-inscricao-list');
  const btnAdicionarTipo = document.getElementById('adicionar-tipo-inscricao');
  
  btnAdicionarTipo.addEventListener('click', function() {
    addTipoInscricao('', '');
  });
  
  function addTipoInscricao(nome = '', preco = '') {
    const newItem = document.createElement('div');
    newItem.className = 'row mb-3 align-items-center tipo-inscricao-item';
    newItem.innerHTML = `
      <div class="col-md-5 col-sm-12 mb-2 mb-md-0">
        <label class="form-label">Tipo de Inscrição:</label>
        <input type="text" class="form-control border border-secondary bg-white" name="nome_tipo[]" placeholder="Nome do Tipo de Inscrição" value="${nome}">
        <input type="hidden" name="id_tipo[]" value="">
      </div>
      <div class="col-md-3 col-sm-6 mb-2 mb-md-0 preco-container">
        <label class="form-label">Preço:</label>
        <input type="number" step="0.01" class="form-control border border-secondary bg-white" name="preco_tipo[]"
              placeholder="Preço" value="${preco}">
      </div>
      <div class="col-md-2 col-sm-6 mb-2 mb-md-0">
        <label class="form-label">Somente Submissão</label>
        <input type="checkbox" class="form-check-input" name="submission_only[]">
      </div>
      <div class="col-md-2 col-sm-6">
        <button type="button" class="btn btn-danger w-100 remover-tipo-inscricao" data-inscricoes="0">
          <i class="bi bi-trash"></i> Remover
        </button>
      </div>
    `;
    tiposList.appendChild(newItem);
    
    // Atualizar os campos de preço nos lotes
    updateLotePriceFields();
  }
  
  // Remover tipo de inscrição
  tiposList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remover-tipo-inscricao') || 
        e.target.closest('.remover-tipo-inscricao')) {
      const button = e.target.classList.contains('remover-tipo-inscricao') ? 
                     e.target : e.target.closest('.remover-tipo-inscricao');
      const row = button.closest('.tipo-inscricao-item');
      
      // Verificar se não é o último tipo de inscrição
      if (tiposList.querySelectorAll('.tipo-inscricao-item').length > 1) {
        row.remove();
        // Atualizar os preços nos lotes quando um tipo for removido
        updateLotePriceFields();
      } else {
        // Se for o último, apenas exibir um alerta
        alert('Pelo menos um tipo de inscrição é necessário.');
      }
    }
  });
  
  // Gerenciamento de lotes
  const lotesContainer = document.getElementById('lotes-container');
  const btnAdicionarLote = document.getElementById('adicionar-lote');
  
  // Adicionar evento para alternar entre data e quantidade
  lotesContainer.addEventListener('change', function(e) {
    if (e.target.name && e.target.name.includes('lote_usar_data')) {
      const loteItem = e.target.closest('.lote-item');
      const datasDiv = loteItem.querySelector('.lote-datas');
      const qtdCheckbox = loteItem.querySelector('input[name^="lote_usar_qtd"]');
      
      if (e.target.checked) {
        datasDiv.style.display = 'flex';
        qtdCheckbox.checked = false;
        loteItem.querySelector('.lote-quantidade').style.display = 'none';
      } else {
        datasDiv.style.display = 'none';
      }
    }
    
    if (e.target.name && e.target.name.includes('lote_usar_qtd')) {
      const loteItem = e.target.closest('.lote-item');
      const qtdDiv = loteItem.querySelector('.lote-quantidade');
      const dataCheckbox = loteItem.querySelector('input[name^="lote_usar_data"]');
      
      if (e.target.checked) {
        qtdDiv.style.display = 'block';
        dataCheckbox.checked = false;
        loteItem.querySelector('.lote-datas').style.display = 'none';
      } else {
        qtdDiv.style.display = 'none';
      }
    }
  });
  
  // Adicionar novo lote
  btnAdicionarLote.addEventListener('click', function() {
    const lotesCount = document.querySelectorAll('.lote-item').length;
    const newLoteItem = document.createElement('div');
    newLoteItem.className = 'lote-item card mb-4 shadow-sm';
    
    newLoteItem.innerHTML = `
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Lote ${lotesCount + 1}</h6>
        <button type="button" class="btn btn-sm btn-outline-danger remover-lote">
          <i class="bi bi-trash"></i> Remover
        </button>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
            <label class="form-label">Nome do Lote</label>
            <input type="text" class="form-control border border-secondary bg-white" name="lote_nome[]" placeholder="Ex: Lote ${lotesCount + 1}">
            <input type="hidden" name="lote_id[]" value="">
          </div>
          <div class="col-md-3 col-sm-6 mb-2 mb-md-0">
            <label class="form-label">Ordem</label>
            <input type="number" class="form-control border border-secondary bg-white" name="lote_ordem[]" value="${lotesCount + 1}" min="1">
          </div>
          <div class="col-md-3 col-sm-6">
            <label class="form-label">Status</label>
            <select class="form-select border border-secondary bg-white" name="lote_ativo[]">
              <option value="1" selected>Ativo</option>
              <option value="0">Inativo</option>
            </select>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6 col-sm-12 mb-3 mb-md-0">
            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_data[]" checked>
              <label class="form-check-label">Definir por período</label>
            </div>
            <div class="row lote-datas">
              <div class="col-md-6 col-sm-6 mb-2 mb-md-0">
                <label class="form-label">Data Início</label>
                <input type="date" class="form-control border border-secondary bg-white" name="lote_data_inicio[]">
              </div>
              <div class="col-md-6 col-sm-6">
                <label class="form-label">Data Fim</label>
                <input type="date" class="form-control border border-secondary bg-white" name="lote_data_fim[]">
              </div>
            </div>
          </div>
          <div class="col-md-6 col-sm-12">
            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input border border-secondary" name="lote_usar_qtd[]">
              <label class="form-check-label">Definir por quantidade</label>
            </div>
            <div class="lote-quantidade" style="display: none;">
              <label class="form-label">Quantidade máxima</label>
              <input type="number" class="form-control border border-secondary bg-white" name="lote_qtd_maxima[]" min="1" placeholder="Limite de inscritos">
            </div>
          </div>
        </div>
        
        <hr>
        <h6 class="mb-3">Preços por tipo de inscrição:</h6>
        <div class="lote-precos">
          <!-- Será preenchido pela função updateLotePriceFields -->
        </div>
      </div>
    `;
    
    lotesContainer.appendChild(newLoteItem);
    updateLoteHeaders();
    updateLotePriceFields();
  });
  
  // Remover lote
  lotesContainer.addEventListener('click', function(e) {
    if (e.target.classList.contains('remover-lote') || 
        e.target.closest('.remover-lote')) {
      const button = e.target.classList.contains('remover-lote') ? 
                    e.target : e.target.closest('.remover-lote');
      
      const loteItem = button.closest('.lote-item');
      
      if (document.querySelectorAll('.lote-item').length > 1) {
        loteItem.remove();
        updateLoteHeaders();
      } else {
        alert('É necessário manter pelo menos um lote.');
      }
    }
  });
  
  // Atualizar cabeçalhos dos lotes
  function updateLoteHeaders() {
    const lotes = document.querySelectorAll('.lote-item');
    lotes.forEach((lote, index) => {
      // Só atualizar o cabeçalho se não tiver um nome personalizado
      const nomeInput = lote.querySelector('input[name="lote_nome[]"]');
      const header = lote.querySelector('h6');
      if (!nomeInput.value) {
        header.textContent = `Lote ${index + 1}`;
      }
    });
  }
  
  // Gerar campos de preço para tipos de inscrição nos lotes
  function updateLotePriceFields() {
    const lotePrecosDivs = document.querySelectorAll('.lote-precos');
    
    lotePrecosDivs.forEach((lotePrecos, loteIndex) => {
      let html = '';
      const tiposInscricao = document.querySelectorAll('input[name="nome_tipo[]"]');
      const tiposPreco = document.querySelectorAll('input[name="preco_tipo[]"]');
      const tiposIds = document.querySelectorAll('input[name="id_tipo[]"]');
      
      if (tiposInscricao.length === 0) {
        html = '<p class="text-warning">Defina os tipos de inscrição primeiro.</p>';
      } else {
        tiposInscricao.forEach((tipo, index) => {
          const tipoNome = tipo.value || `Tipo ${index + 1}`;
          const tipoId = tiposIds[index].value || `new_${index}`;
          const precoDefault = tiposPreco[index].value || '';
          
          const loteItem = lotePrecos.closest('.lote-item');
          const loteIdInput = loteItem.querySelector('input[name="lote_id[]"]');
          const loteId = loteIdInput.value || `new_${loteIndex}`;
          
          html += `
            <div class="row mb-2 align-items-center">
              <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
                <label class="form-label">${tipoNome}</label>
                <input type="hidden" name="lote_tipo_id_${loteId}_${tipoId}" value="${tipoId}">
              </div>
              <div class="col-md-6 col-sm-12 preco-container">
                <label class="form-label">Preço (R$)</label>
                <input type="number" step="0.01" class="form-control border border-secondary bg-white" 
                      name="lote_tipo_preco_${loteId}_${tipoId}" 
                      placeholder="0.00" value="${precoDefault}">
              </div>
            </div>
          `;
        });
      }
      
      lotePrecos.innerHTML = html;
    });
  }
  
  // Se não houver nenhum tipo de inscrição, adicionar um automaticamente
  if (tiposList.querySelectorAll('.tipo-inscricao-item').length === 0) {
    addTipoInscricao('Inscrição Padrão', '');
  }
  
  // Inicializar os preços dos lotes
  updateLotePriceFields();

  // Variáveis globais para mapa
  let map;
  let marker;
  let currentLocation = {
    lat: -15.77972,
    lng: -47.92972
  };
  let suggestionTimeout;
  let currentFocus = -1;

  // Configuração de sugestões para o campo de localização
  const localizacaoInput = document.getElementById('localizacao-input');
  const suggestionsContainer = document.getElementById('suggestions');
  
  // Configuração de sugestões para o campo do modal
  const modalSearchInput = document.getElementById('modal-search-input');
  const modalSuggestionsContainer = document.getElementById('modal-suggestions');
  
  // Configurar o mapa quando o modal for aberto
  document.getElementById('mapaModal').addEventListener('shown.bs.modal', function () {
    if (!map) {
      initMap();
    }
    
    // Forçar recálculo do tamanho do mapa
    setTimeout(function() {
      map.invalidateSize();
    }, 10);
    
    // Centralize no local salvo, se existir
    if (document.getElementById('latitude').value && document.getElementById('longitude').value) {
      const lat = parseFloat(document.getElementById('latitude').value);
      const lng = parseFloat(document.getElementById('longitude').value);
      map.setView([lat, lng], 15);
      
      if (marker) {
        marker.setLatLng([lat, lng]);
      } else {
        marker = L.marker([lat, lng]).addTo(map);
      }
      
      // Mostrar detalhes do local
      showLocationDetails(lat, lng);
    }
  });
  
  // Inicializar o mapa
  function initMap() {
    map = L.map('mapa-container').setView([currentLocation.lat, currentLocation.lng], 13);

      const stay22Layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/stay22/{z}/{x}/{y}{r}.png?api_key=5b05060b-8e26-4d1c-bcaa-306d76157824', {
        maxZoom: 20,
        attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a> &copy; OpenStreetMap contributors'
      }).addTo(map);

      stay22Layer.on('tileerror', function() {
        map.removeLayer(stay22Layer);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      });
    
    // Adicionar marker no mapa se já existir localização
    if (document.getElementById('latitude').value && document.getElementById('longitude').value) {
      const lat = parseFloat(document.getElementById('latitude').value);
      const lng = parseFloat(document.getElementById('longitude').value);
      marker = L.marker([lat, lng]).addTo(map);
    }
    
    // Permitir clicar no mapa para selecionar local
    map.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      
      // Atualizar ou criar marcador
      if (marker) {
        marker.setLatLng([lat, lng]);
      } else {
        marker = L.marker([lat, lng]).addTo(map);
      }
      
      showLocationDetails(lat, lng);
    });
  }
  
  // Mostrar detalhes do local selecionado
  function showLocationDetails(lat, lng, address = null) {
    document.getElementById('endereco-detalhes').classList.remove('d-none');
    document.getElementById('info-latitude').textContent = lat.toFixed(6);
    document.getElementById('info-longitude').textContent = lng.toFixed(6);
    
    if (address) {
        document.getElementById('endereco-completo').textContent = address;
        currentLocation = {
          lat: lat,
          lng: lng,
          address: address
        };
        return;
    }
    
    // Fazer geocoding reverso para obter o endereço
      fetch(`https://api.stadiamaps.com/geocoding/v1/reverse?point.lat=${lat}&point.lon=${lng}&apikey=5b05060b-8e26-4d1c-bcaa-306d76157824`)
        .then(response => response.json())
        .then(data => {
          if (data && data.features && data.features.length > 0) {
            const label = data.features[0].properties.label;
            document.getElementById('endereco-completo').textContent = label;
            currentLocation = {
              lat: lat,
              lng: lng,
              address: label
            };
          }
        })
      .catch(error => {
        console.error('Erro ao obter endereço:', error);
        document.getElementById('endereco-completo').textContent = 'Endereço não disponível';
      });
  }
  
  // Função auxiliar para renderizar sugestões
  function renderSuggestions(features, container, inputElement, isModal) {
    container.innerHTML = '';
    
    if (!features || features.length === 0) {
        const item = document.createElement('div');
        item.className = 'list-group-item text-muted';
        item.textContent = 'Nenhum local encontrado';
        container.appendChild(item);
        container.style.display = 'block';
        return;
    }

    features.forEach(feature => {
        const coords = feature.geometry.coordinates;
        const label = feature.properties.label;

        // Criar elemento de sugestão
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action suggestion-item';
        item.textContent = label;
        
        item.addEventListener('click', function(e) {
            e.preventDefault();
            inputElement.value = label;
            container.style.display = 'none';

            if (isModal) {
                const lat = coords[1];
                const lng = coords[0];
                
                map.setView([lat, lng], 15);
                
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng]).addTo(map);
                }
                
                showLocationDetails(lat, lng, label);
            } else {
                document.getElementById('latitude').value = coords[1];
                document.getElementById('longitude').value = coords[0];
                document.getElementById('link_mapa').value = `https://www.google.com/maps?q=${coords[1]},${coords[0]}`;
            }
        });
        
        // Hover effect visual feedback
        item.addEventListener('mouseenter', function() {
            this.classList.add('active');
        });
        item.addEventListener('mouseleave', function() {
            this.classList.remove('active');
        });

        container.appendChild(item);
    });

    container.style.display = 'block';
  }

  // Buscar locais com base no texto digitado
  function searchPlaces(query, modalSearch = false) {
    const searchInput = modalSearch ? modalSearchInput : localizacaoInput;
    const container = modalSearch ? modalSuggestionsContainer : suggestionsContainer;
    
    if (query.length < 3) {
        container.style.display = 'none';
        return;
    }
    
    fetch(`https://api.stadiamaps.com/geocoding/v1/search?text=${encodeURIComponent(query)}&apikey=5b05060b-8e26-4d1c-bcaa-306d76157824`)
      .then(response => response.json())
      .then(data => {
        if (data.features) {
            renderSuggestions(data.features, container, searchInput, modalSearch);
        } else {
            renderSuggestions([], container, searchInput, modalSearch);
        }
      })
      .catch(error => {
        console.error('Erro na busca:', error);
        renderSuggestions([], container, searchInput, modalSearch);
      });
  }
  
  // Debounce function
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  const debouncedSearchLocalizacao = debounce((query) => searchPlaces(query, false), 300);
  const debouncedSearchModal = debounce((query) => searchPlaces(query, true), 300);
  
  // Event listener para o campo de localização principal
  localizacaoInput.addEventListener('input', function() {
    const query = this.value.trim();
    debouncedSearchLocalizacao(query);
  });
  
  // Event listener para o campo do modal
  modalSearchInput.addEventListener('input', function() {
    const query = this.value.trim();
    currentFocus = -1; // Reset focus on input change
    debouncedSearchModal(query);
  });

  // Navegação por teclado para o modal
  modalSearchInput.addEventListener('keydown', function(e) {
      const container = modalSuggestionsContainer;
      const items = container.getElementsByClassName('suggestion-item');
      
      if (e.key === 'ArrowDown') {
          currentFocus++;
          addActive(items);
      } else if (e.key === 'ArrowUp') {
          currentFocus--;
          addActive(items);
      } else if (e.key === 'Enter') {
          e.preventDefault();
          if (currentFocus > -1) {
              if (items && items[currentFocus]) {
                  items[currentFocus].click();
              }
          } else {
              // Se nenhuma sugestão selecionada, realiza busca normal (botão buscar)
              document.getElementById('modal-search-btn').click();
          }
      }
  });

  function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    
    x[currentFocus].classList.add("active");
    x[currentFocus].scrollIntoView({block: "nearest"});
  }

  function removeActive(x) {
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("active");
    }
  }

  // Esconder sugestões ao clicar fora
  document.addEventListener('click', function(e) {
    if (e.target !== localizacaoInput && !suggestionsContainer.contains(e.target)) {
      suggestionsContainer.style.display = 'none';
    }
    if (e.target !== modalSearchInput && !modalSuggestionsContainer.contains(e.target)) {
      modalSuggestionsContainer.style.display = 'none';
    }
  });

  // Esconder sugestões ao perder foco (com delay para permitir clique)
  modalSearchInput.addEventListener('blur', function() {
      setTimeout(() => {
          modalSuggestionsContainer.style.display = 'none';
      }, 200);
  });

  // Limpar ao esvaziar
  modalSearchInput.addEventListener('keyup', function() {
      if (this.value === '') {
          modalSuggestionsContainer.style.display = 'none';
      }
  });

  // Buscar no modal (botão)
  document.getElementById('modal-search-btn').addEventListener('click', function() {
    const query = modalSearchInput.value.trim();
    if (query.length >= 3) {
        // Force search explicitly without debounce if button clicked
        searchPlaces(query, true);
    }
  });
  
  // Selecionar local do mapa
  document.getElementById('btn-selecionar-local').addEventListener('click', function() {
    if (currentLocation) {
      // Preencher campos com informações do local selecionado
      document.getElementById('latitude').value = currentLocation.lat;
      document.getElementById('longitude').value = currentLocation.lng;
      document.getElementById('localizacao-input').value = currentLocation.address || '';
      
      // Gerar link do Google Maps
      document.getElementById('link_mapa').value = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}`;
    }
  });
});
</script>
{% endblock %}