{% extends "base.html" %}
{% block title %}Dashboard - Administrador{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- T√≠tulo principal -->
  <h2 class="text-center text-dark mb-4">Painel Administrativo</h2>

  

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Se√ß√£o de Estat√≠sticas Globais -->
<div class="row my-4">
  <div class="col-md-3">
    <div class="card text-center shadow">
      <div class="card-body">
        <h5 class="card-title text-primary">Total de Oficinas</h5>
        <p class="card-text display-6">{{ total_oficinas }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow">
      <div class="card-body">
        <h5 class="card-title text-primary">Vagas Ofertadas</h5>
        <p class="card-text display-6">{{ total_vagas }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow">
      <div class="card-body">
        <h5 class="card-title text-primary">Vagas Preenchidas</h5>
        <p class="card-text display-6">{{ total_inscricoes }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow">
      <div class="card-body">
        <h5 class="card-title text-primary">% de Ades√£o</h5>
        <p class="card-text display-6">
          {{ "%.2f"|format(percentual_adesao) }}%
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Estat√≠sticas por oficina -->
<div class="row my-4">
  <h4>Oficinas - Detalhes</h4>
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>T√≠tulo</th>
          <th>Vagas</th>
          <th>Inscri√ß√µes</th>
          <th>Ocupa√ß√£o (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for ofst in oficinas_estatisticas %}
        <tr>
          <td>{{ ofst.titulo }}</td>
          <td>{{ ofst.vagas }}</td>
          <td>{{ ofst.inscritos }}</td>
          <td>{{ "%.2f"|format(ofst.ocupacao) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<a href="{{ url_for('routes.cadastrar_cliente') }}" class="btn btn-primary mb-3">+ Novo Cliente</a>
<h3>Gerenciamento de Clientes</h3>
{% if clientes %}
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>E-mail</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for cliente in clientes %}
      <tr>
        <td>{{ cliente.id }}</td>
        <td>{{ cliente.nome }}</td>
        <td>{{ cliente.email }}</td>
        <td>{{ "Ativo" if cliente.ativo else "Inativo" }}</td>
        <td>
          <!-- Bot√£o para editar (voc√™ precisar√° criar a rota e template correspondente) -->
          <button type="button" class="btn btn-warning btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#modalEditarCliente"
          data-id="{{ cliente.id }}"
          data-nome="{{ cliente.nome }}"
          data-email="{{ cliente.email }}"
          data-senha="{{ cliente.senha }}">
            Editar
          </button>
          <!-- Bot√£o para alternar status -->
          <a href="{{ url_for('routes.toggle_cliente', cliente_id=cliente.id) }}" class="btn btn-info btn-sm">
            {{ "Restringir" if cliente.ativo else "Habilitar" }}
          </a>
          
          <!-- Bot√£o para excluir -->
          <!-- Bot√£o para acionar modal de exclus√£o -->
          <button type="button" class="btn btn-danger btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#modalExcluirCliente"
          data-id="{{ cliente.id }}">
            Excluir
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}


  

  <!-- Primeira linha: Blocos Importar Dados e Configura√ß√µes lado a lado -->
  <div class="row">
    <!-- Bloco Importar Dados -->
    <div class="col-md-6 mb-4">
      <div class="card shadow">
        <div class="card-header bg-primary text-white fw-bold">
          <i class="bi bi-upload"></i> Importar Dados
        </div>
        <div class="card-body">
          <!-- Formul√°rio para Importar Oficinas -->
          <form action="{{ url_for('routes.importar_oficinas') }}" method="POST" enctype="multipart/form-data" class="mb-3">
            <label class="form-label fw-semibold">Importar Oficinas (Excel .xlsx)</label>
            <div class="input-group">
              <input type="file" name="arquivo" accept=".xlsx" class="form-control" required>
              <button type="submit" class="btn btn-success">
                <i class="bi bi-file-earmark-arrow-up"></i> Importar
              </button>
            </div>
            <small class="text-muted">Use o modelo abaixo para facilitar.</small>
          </form>
          <div class="mb-4">
            <a href="{{ url_for('static', filename='modelo_oficinas.xlsx') }}" class="btn btn-outline-info w-100">
              <i class="bi bi-download"></i> Baixar Modelo de Oficinas
            </a>
          </div>
          <!-- Formul√°rio para Importar Usu√°rios -->
          <form action="{{ url_for('routes.importar_usuarios') }}" method="POST" enctype="multipart/form-data" class="mb-3">
            <label class="form-label fw-semibold">Importar Usu√°rios (Excel .xlsx)</label>
            <div class="input-group">
              <input type="file" name="arquivo" accept=".xlsx" class="form-control" required>
              <button type="submit" class="btn btn-success">
                <i class="bi bi-file-earmark-arrow-up"></i> Importar
              </button>
            </div>
            <small class="text-muted">Use o modelo abaixo para facilitar.</small>
          </form>
          <div>
            <a href="{{ url_for('static', filename='modelo_usuarios.xlsx') }}" class="btn btn-outline-info w-100">
              <i class="bi bi-download"></i> Baixar Modelo de Usu√°rios
            </a>
          </div>
        </div>
      </div>
    </div>
    <!-- Bloco Configura√ß√µes -->
    <div class="col-md-6 mb-4">
      <div class="card shadow">
        <div class="card-header bg-primary text-white fw-bold">
          <i class="bi bi-gear-fill"></i> Configura√ß√µes
        </div>
        <div class="card-body">
          <!-- Altern√¢ncia do Check-in Global -->
          <form action="{{ url_for('routes.toggle_checkin_global') }}" method="post" class="mb-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggleCheckinGlobal" onchange="this.form.submit()"
                {% if permitir_checkin_global %}checked{% endif %}>
              <label class="form-check-label fw-semibold" for="toggleCheckinGlobal">
                Permitir Check-in Global (Todos podem realizar check-in)
              </label>
            </div>
          </form>
          <!-- Altern√¢ncia do Envio de Feedback -->
          <form action="{{ url_for('routes.toggle_feedback') }}" method="post" class="mb-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggleFeedback" onchange="this.form.submit()"
                {% if habilitar_feedback %}checked{% endif %}>
              <label class="form-check-label fw-semibold" for="toggleFeedback">
                Habilitar Envio de Feedback (Participantes podem enviar feedback)
              </label>
            </div>
          </form>
          <!-- Altern√¢ncia do Certificado Individual -->
          <form action="{{ url_for('routes.toggle_certificado_individual') }}" method="post" class="mb-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggleCertificadoIndividual"
                    onchange="this.form.submit()"
                    {% if habilitar_certificado_individual %}checked{% endif %}>
              <label class="form-check-label fw-semibold" for="toggleCertificadoIndividual">
                Habilitar Baixar Certificado (Participante)
              </label>
            </div>
          </form>
          <!-- Bot√µes de a√ß√µes -->
          <div class="mb-4">
            <a href="{{ url_for('routes.criar_oficina') }}" class="btn btn-warning w-100 fw-bold">
              <i class="bi bi-plus-circle"></i> Criar Nova Oficina
            </a>
          </div>
          <div class="mb-4">
            <a href="{{ url_for('routes.admin_scan') }}" class="btn btn-dark w-100 fw-bold">
              <i class="bi bi-qr-code-scan"></i> Escanear QR Code
            </a>
          </div>
          <div class="mb-4">
            <button type="button" class="btn btn-primary w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#modalCheckinsQR">
              <i class="bi bi-qr-code-scan"></i> Ver Check-ins via QR
            </button>
          </div>

          <div class="mb-4">
             <button type="button" class="btn btn-info w-100 fw-bold"
                  data-bs-toggle="modal" data-bs-target="#modalRelatorioMensagem">
            <i class="bi bi-chat-text"></i> Gerar Relat√≥rio (Mensagem)
          </button>
          </div>

          <div class="mb-4">
            <a href="{{ url_for('routes.listar_formularios') }}" class="btn btn-primary w-100 fw-bold">
                <i class="bi bi-ui-checks"></i> Gerenciar Formul√°rios
            </a>
        </div>

        <div class="mb-4">
          <a href="{{ url_for('routes.listar_respostas', formulario_id=1) }}" class="btn btn-primary w-100 fw-bold">
              üìÑ Gerenciar Respostas dos Formul√°rios
          </a>
      </div>

        
      
      

          <div class="mb-4">
            <!-- Bot√£o que abre o modal de gerenciamento de inscri√ß√µes -->
            <button type="button" class="btn btn-success w-100 fw-bold"
            data-bs-toggle="modal" data-bs-target="#modalGerenciarInscricoes">
            Gerenciar Inscri√ß√µes
            </button>
         </div>
          <form action="{{ url_for('routes.excluir_todas_oficinas') }}" method="post"
                onsubmit="return confirm('Tem certeza que deseja excluir todas as oficinas?');">
            <button type="submit" class="btn btn-danger w-100">
              <i class="bi bi-trash-fill"></i> Excluir Todas as Oficinas
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Fim da primeira linha -->

  

  <!-- Modal de confirma√ß√£o de exclus√£o -->
<!-- Modal de confirma√ß√£o de exclus√£o -->
<div class="modal fade" id="modalExcluirCliente" tabindex="-1" aria-labelledby="modalExcluirClienteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('routes.excluir_cliente', cliente_id=0) }}" method="POST" id="formExcluirCliente">
        <div class="modal-header">
          <h5 class="modal-title" id="modalExcluirClienteLabel">Confirmar Exclus√£o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja excluir este cliente?</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Sim, Excluir</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Gerenciar Inscri√ß√µes -->
<div class="modal fade" id="modalGerenciarInscricoes" tabindex="-1" aria-labelledby="modalGerenciarInscricoesLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalGerenciarInscricoesLabel">Gerenciar Inscri√ß√µes</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <!-- Tabela de inscri√ß√µes -->
        <form id="formGerenciarInscricoes" method="POST" action="">
          <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
              <thead class="table-dark">
                <tr>
                  <th></th>  <!-- Coluna dos checkboxes -->
                  <th>ID</th>
                  <th>Participante</th>
                  <th>Oficina</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {% for insc in inscricoes %}
                  <tr>
                    <td>
                      <!-- Checkbox para sele√ß√£o m√∫ltipla -->
                      <input type="checkbox" name="inscricao_ids" value="{{ insc.id }}">
                    </td>
                    <td>{{ insc.id }}</td>
                    <td>{{ insc.usuario.nome }}</td>
                    <td>{{ insc.oficina.titulo }}</td>
                    <td>
                      <!-- A√ß√£o individual (opcional) -->
                      <a href="{{ url_for('routes.cancelar_inscricao', inscricao_id=insc.id) }}" class="btn btn-danger btn-sm">
                        Cancelar
                      </a>
                      <!-- ou mover individual -->
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Seletor de oficina destino (usado ao mover) -->
          <div class="mb-3">
            <label for="oficinaDestino" class="form-label">Mover para Oficina:</label>
            <select id="oficinaDestino" name="oficina_destino" class="form-select">
              <option value="">Selecione</option>
              {% for of in oficinas %}
                <option value="{{ of.id }}">{{ of.titulo }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Bot√µes de A√ß√µes em lote -->
          <button type="submit" formaction="{{ url_for('routes.cancelar_inscricoes_lote') }}" class="btn btn-danger">
            Cancelar Selecionadas
          </button>
          <button type="submit" formaction="{{ url_for('routes.mover_inscricoes_lote') }}" class="btn btn-warning">
            Mover Selecionadas
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- Modal do Relat√≥rio de Mensagem -->
<div class="modal fade" id="modalRelatorioMensagem" tabindex="-1"
     aria-labelledby="modalRelatorioMensagemLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalRelatorioMensagemLabel">
          Relat√≥rio - Mensagem de Texto
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <!-- Campo de texto (textarea) para exibir e editar a mensagem -->
        <textarea id="textoRelatorio" class="form-control" rows="8">{{ msg_relatorio }}</textarea>
      </div>

      <div class="modal-footer">
        <!-- Bot√£o para copiar o texto -->
        <button type="button" class="btn btn-primary fw-bold" onclick="copiarMensagem()">
          <i class="bi bi-clipboard"></i> Copiar Mensagem
        </button>
        <!-- Novo bot√£o para enviar por WhatsApp -->
        <button type="button" class="btn btn-success fw-bold" onclick="enviarWhatsAppRelatorio()">
          <i class="bi bi-whatsapp"></i> Enviar por WhatsApp
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
      </div>

    </div>
  </div>
</div>



  <!-- Modal de Check-ins via QR -->
  <div class="modal fade" id="modalCheckinsQR" tabindex="-1" aria-labelledby="modalCheckinsQRLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalCheckinsQRLabel">Check-ins via QR Code</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          {% if checkins_via_qr and checkins_via_qr|length > 0 %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Oficina</th>
                    <th>Data/Hora</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ck in checkins_via_qr %}
                    <tr>
                      <td>{{ ck.usuario.nome }}</td>
                      <td>{{ ck.oficina.titulo }}</td>
                      <td>
                        {% if ck.data_hora %}
                          {{ ck.data_hora.strftime('%d/%m/%Y %H:%M:%S') }}
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

             <!-- Bot√£o para gerar PDF dos checkins via QR -->
            <div class="d-flex justify-content-end">
              <a href="{{ url_for('routes.gerar_pdf_checkins_qr') }}"
                class="btn btn-outline-primary fw-bold">
                <i class="bi bi-file-earmark-arrow-down"></i> Baixar PDF
              </a>
            </div>


          {% else %}
            <p>Nenhum check-in via QR Code encontrado at√© o momento.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Gerenciamento de Ministrantes -->
  <div class="modal fade" id="modalGerenciarMinistrantes" tabindex="-1" aria-labelledby="modalGerenciarMinistrantesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="modalGerenciarMinistrantesLabel">Gerenciar Ministrantes</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          {% if ministrantes %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Forma√ß√£o</th>
                    <th>√Åreas de Atua√ß√£o</th>
                    <th>CPF</th>
                    <th>Email</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ministrante in ministrantes %}
                    <tr>
                      <td>{{ ministrante.id }}</td>
                      <td>{{ ministrante.nome }}</td>
                      <td>{{ ministrante.formacao }}</td>
                      <td>{{ ministrante.areas_atuacao }}</td>
                      <td>{{ ministrante.cpf }}</td>
                      <td>{{ ministrante.email }}</td>
                      <td>
                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalEditarMinistrante"
                                data-id="{{ ministrante.id }}"
                                data-nome="{{ ministrante.nome }}"
                                data-formacao="{{ ministrante.formacao }}"
                                data-areas="{{ ministrante.areas_atuacao }}"
                                data-cpf="{{ ministrante.cpf }}"
                                data-pix="{{ ministrante.pix }}"
                                data-cidade="{{ ministrante.cidade }}"
                                data-estado="{{ ministrante.estado }}"
                                data-email="{{ ministrante.email }}">
                          Editar
                        </button>
                        <form action="{{ url_for('routes.excluir_ministrante', ministrante_id=ministrante.id) }}"
                              method="POST" style="display:inline-block;"
                              onsubmit="return confirm('Tem certeza que deseja excluir este ministrante?');">
                          <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-center">Nenhum ministrante cadastrado.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Relat√≥rios Formadores -->
<div class="modal fade" id="modalRelatorios" tabindex="-1" aria-labelledby="modalRelatoriosLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="modalRelatoriosLabel">Relat√≥rios Formadores</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        {% if relatorios and relatorios|length > 0 %}
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Oficina</th>
                  <th>Ministrante</th>
                  <th>Metodologia</th>
                  <th>Resultados</th>
                  <th>Enviado Em</th>
                  <th>Anexo</th>
                </tr>
              </thead>
              <tbody>
                {% for rel in relatorios %}
                  <tr>
                    <td>{{ rel.id }}</td>
                    <td>{{ rel.oficina.titulo }}</td>
                    <td>{{ rel.ministrante.nome }}</td>
                    <td>{{ rel.metodologia }}</td>
                    <td>{{ rel.resultados }}</td>
                    <td>{{ rel.enviado_em.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                      {% if rel.fotos_videos_path %}
                      {% set nome_arquivo = rel.fotos_videos_path.split('/')[-1] %}
                          <a href="{{ url_for('routes.get_relatorio_file', filename=nome_arquivo) }}">
                            Visualizar
                          </a>                    
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>Nenhum relat√≥rio encontrado.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal de Gerenciamento de Participantes -->
<div class="modal fade" id="modalGerenciarParticipantes" tabindex="-1" 
     aria-labelledby="modalGerenciarParticipantesLabel" 
     aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="modalGerenciarParticipantesLabel">
          Gerenciar Participantes
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" 
                aria-label="Fechar"></button>
      </div>
      <div class="modal-body">

        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>E-mail</th>
                <th>Forma√ß√£o</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for p in participantes %}
              <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.nome }}</td>
                <td>{{ p.cpf }}</td>
                <td>{{ p.email }}</td>
                <td>{{ p.formacao }}</td>
                <td>
                  <!-- Bot√£o Editar (abre outro modal para edi√ß√£o, ou faz redirect) -->
                  <button type="button" class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditarParticipante"
                          data-id="{{ p.id }}"
                          data-nome="{{ p.nome }}"
                          data-cpf="{{ p.cpf }}"
                          data-email="{{ p.email }}"
                          data-formacao="{{ p.formacao }}">
                    Editar
                  </button>
                  <!-- Bot√£o Excluir (formul√°rio POST, ou AJAX) -->
                  <form action="{{ url_for('routes.excluir_participante', participante_id=p.id) }}"
                        method="POST" style="display:inline-block;"
                        onsubmit="return confirm('Tem certeza que deseja excluir este participante?');">
                    <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o de Participante -->
<div class="modal fade" id="modalEditarParticipante" tabindex="-1" aria-labelledby="modalEditarParticipanteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarParticipante" method="POST" action="">
        <div class="modal-header bg-warning text-white">
          <h5 class="modal-title" id="modalEditarParticipanteLabel">Editar Participante</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <!-- Campos para edi√ß√£o -->
          <div class="mb-3">
            <label for="nome" class="form-label">Nome</label>
            <input type="text" id="nome" name="nome" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="cpf" class="form-label">CPF</label>
            <input type="text" id="cpf" name="cpf" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">E-mail</label>
            <input type="email" id="email" name="email" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="formacao" class="form-label">Forma√ß√£o</label>
            <input type="text" id="formacao" name="formacao" class="form-control">
          </div>
          <div class="mb-3">
            <label for="senha" class="form-label">Nova Senha (deixe vazio para n√£o alterar)</label>
            <input type="password" id="senha" name="senha" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>


  
  <!-- Modal de Edi√ß√£o de Ministrante -->
  <div class="modal fade" id="modalEditarMinistrante" tabindex="-1" aria-labelledby="modalEditarMinistranteLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formEditarMinistrante" method="POST" action="">
          <div class="modal-header bg-warning text-white">
            <h5 class="modal-title" id="modalEditarMinistranteLabel">Editar Ministrante</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="nome" class="form-label">Nome</label>
              <input type="text" id="nome" name="nome" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="formacao" class="form-label">Forma√ß√£o</label>
              <input type="text" id="formacao" name="formacao" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="areas" class="form-label">√Åreas de Atua√ß√£o</label>
              <input type="text" id="areas" name="areas" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="cpf" class="form-label">CPF</label>
              <input type="text" id="cpf" name="cpf" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="pix" class="form-label">PIX</label>
              <input type="text" id="pix" name="pix" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="cidade" class="form-label">Cidade</label>
              <input type="text" id="cidade" name="cidade" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="estado" class="form-label">Estado</label>
              <input type="text" id="estado" name="estado" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" id="email" name="email" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="senha" class="form-label">Nova Senha (deixe em branco para n√£o alterar)</label>
              <input type="password" id="senha" name="senha" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
<!-- Bloco para Cadastro de Ministrante -->
<div class="row mt-4">
  <div class="col-md-6 mb-4">
    <div class="card shadow">
      <div class="card-header bg-info text-white fw-bold">
        <i class="bi bi-person-plus"></i> Gerenciamento de Ministrante
      </div>
      <div class="card-body d-flex flex-column">
        <div class="d-grid mb-4">
          <a href="{{ url_for('routes.cadastro_ministrante') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-person-plus"></i> Cadastrar Ministrante
          </a>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <button type="button" class="btn btn-success w-100 py-2" 
                    data-bs-toggle="modal" 
                    data-bs-target="#modalGerenciarMinistrantes">
              <i class="bi bi-people"></i> Gerenciar Ministrantes
            </button>
          </div>
          <div class="col-12 col-md-6">
            <button type="button" class="btn btn-info w-100 py-2" 
                    data-bs-toggle="modal" 
                    data-bs-target="#modalRelatorios">
              <i class="bi bi-file-earmark-text"></i> Relat√≥rio Formador
            </button>
          </div>
        </div>

        <div class="d-grid">
          <button type="button" class="btn btn-warning w-100 py-2"
                  data-bs-toggle="modal" 
                  data-bs-target="#modalGerenciarParticipantes">
            <i class="bi bi-people"></i> Gerenciar Participantes
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- Gerenciamento de Oficinas -->
  <h3 class="text-center text-dark mt-5">Gerenciamento de Oficinas</h3>
  <br>
  <!-- Filtro de Estado e Cidade -->
  <form method="GET" action="{{ url_for('routes.dashboard') }}">
    <div class="row mb-4">
      <div class="col-md-4">
        <label for="estadoSelect" class="form-label">Filtrar por Estado</label>
        <select id="estadoSelect" name="estado" class="form-select">
          <option value="">Todos os Estados</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="cidadeSelect" class="form-label">Filtrar por Cidade</label>
        <select id="cidadeSelect" name="cidade" class="form-select">
          <option value="">Todas as Cidades</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary">Filtrar</button>
      </div>
    </div>
  </form>
  
  <div class="row mt-4">
    {% for oficina in oficinas %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-lg h-100">
          <div class="card-header bg-primary text-white text-center fw-bold">
            {{ oficina.titulo }}
          </div>
          <div class="card-body text-center d-flex flex-column justify-content-between">
            <div>
              <p class="info m-0"><strong>Ministrante:</strong> {{ oficina.ministrante }}</p>
              <p><strong>Datas e Hor√°rios:</strong></p>
              <ul class="list-unstyled">
                {% for dia in oficina.dias %}
                  <li>üìÖ {{ dia.data.strftime('%d/%m/%Y') }} - üïí {{ dia.horario_inicio }} √†s {{ dia.horario_fim }}</li>
                {% endfor %}
              </ul>
              
              <p class="info m-0"><strong>Vagas dispon√≠veis:</strong> {{ oficina.vagas }}</p>
              <p class="info"><strong>Total de inscritos:</strong> {{ oficina.inscritos | length }}</p>
            </div>
            <div class="mt-3 d-flex justify-content-center gap-2 flex-wrap">
              <a href="{{ url_for('routes.editar_oficina', oficina_id=oficina.id) }}" class="btn btn-warning btn-sm fw-bold">
                <i class="bi bi-pencil-square"></i> Editar
              </a>
              <form action="{{ url_for('routes.excluir_oficina', oficina_id=oficina.id) }}" method="post"
                    onsubmit="return confirm('Tem certeza que deseja excluir esta oficina?');">
                <button type="submit" class="btn btn-danger btn-sm fw-bold">
                  <i class="bi bi-trash-fill"></i> Excluir
                </button>
              </form>
              <a href="{{ url_for('routes.lista_checkins', oficina_id=oficina.id) }}" class="btn btn-primary btn-sm fw-bold">
                <i class="bi bi-card-checklist"></i> Check-ins
              </a>
            </div>

            <button type="button" class="btn btn-info btn-sm fw-bold mt-3" data-bs-toggle="modal"
                    data-bs-target="#modalOficina{{ oficina.id }}">
              <i class="bi bi-eye-fill"></i> Ver Inscritos
            </button>
          </div>
        </div>
      </div>

      <!-- Modal para gerar certificado individual para uma oficina -->
      <div class="modal fade" id="modalCertificadoIndividual{{ oficina.id }}"
      tabindex="-1" aria-labelledby="modalCertificadoIndividualLabel{{ oficina.id }}"
      aria-hidden="true">
      <div class="modal-dialog">
      <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title fw-bold" id="modalCertificadoIndividualLabel{{ oficina.id }}">
          Certificado Individual - {{ oficina.titulo }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('routes.gerar_certificado_individual_admin') }}" method="POST">
          <!-- Envia o ID da oficina -->
          <input type="hidden" name="oficina_id" value="{{ oficina.id }}">
          <div class="mb-3">
            <label for="usuarioSelect{{ oficina.id }}" class="form-label">Selecione o participante</label>
            <select name="usuario_id" id="usuarioSelect{{ oficina.id }}" class="form-select" required>
              <option value="">-- Selecione --</option>
              {% for inscricao in oficina.inscritos %}
                <!-- Aqui assumimos que cada inscri√ß√£o possui os dados do usu√°rio, ex: inscricao.usuario -->
                <option value="{{ inscricao.id }}">{{ inscricao.nome }} - {{ inscricao.email }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary fw-bold">
              <i class="bi bi-award-fill"></i> Gerar Certificado
            </button>
          </div>
        </form>
      </div>
      </div>
      </div>
      </div>


      <!-- Modal para mostrar inscritos da oficina -->
      <div class="modal fade" id="modalOficina{{ oficina.id }}" tabindex="-1" aria-labelledby="modalLabel{{ oficina.id }}"
           aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title fw-bold" id="modalLabel{{ oficina.id }}">
                <i class="bi bi-people"></i> Inscritos - {{ oficina.titulo }}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
              {% if oficina.inscritos | length > 0 %}
                <div class="table-responsive">
                  <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                      <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>E-mail</th>
                        <th>Forma√ß√£o</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for inscricao in oficina.inscritos %}
                        <tr>
                          <td>{{ inscricao.nome }}</td>
                          <td>{{ inscricao.cpf }}</td>
                          <td>{{ inscricao.email }}</td>
                          <td>{{ inscricao.formacao }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-center text-danger fs-5">Nenhum inscrito ainda.</p>
              {% endif %}
            </div>
            <div class="modal-footer d-flex justify-content-center gap-2 flex-wrap">
              <a href="{{ url_for('routes.gerar_pdf_inscritos_pdf', oficina_id=oficina.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-text"></i> Baixar Lista de Inscritos
              </a>
              <a href="{{ url_for('routes.gerar_lista_frequencia', oficina_id=oficina.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Lista de Frequ√™ncia
              </a>
              <a href="{{ url_for('routes.gerar_certificados', oficina_id=oficina.id) }}" class="btn btn-outline-success">
                <i class="bi bi-award-fill"></i> Gerar Certificados
              </a>
              <!-- Bot√£o para abrir a modal de certificado individual -->
              <a href="#" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalCertificadoIndividual{{ oficina.id }}">
                <i class="bi bi-award-fill"></i> Certificado Individual
              </a>
              <a href="{{ url_for('routes.feedback_oficina', oficina_id=oficina.id) }}" class="btn btn-outline-info">
                <i class="bi bi-alphabet"></i> Gerar Feedback
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Modal de edi√ß√£o de cliente -->
<!-- Modal de edi√ß√£o de cliente -->
<div class="modal fade" id="modalEditarCliente" tabindex="-1" aria-labelledby="modalEditarClienteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('routes.editar_cliente', cliente_id=0) }}" method="POST" id="formEditarCliente">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarClienteLabel">Editar Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="clienteNome" class="form-label">Nome</label>
            <input type="text" class="form-control" name="nome" id="clienteNome" required>
          </div>
          <div class="mb-3">
            <label for="clienteEmail" class="form-label">E-mail</label>
            <input type="email" class="form-control" name="email" id="clienteEmail" required>
          </div>
          <div class="mb-3">
            <label for="clienteSenha" class="form-label">Nova Senha (opcional)</label>
            <input type="password" class="form-control" name="senha" id="clienteSenha" placeholder="Deixe em branco para manter a senha atual">
            <small class="form-text text-muted">A senha s√≥ ser√° alterada se voc√™ preencher este campo.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('[id^="modalCertificadoIndividual"]').forEach(function(modalElement) {
    modalElement.addEventListener("hidden.bs.modal", function () {
      var backdrop = document.querySelector(".modal-backdrop");
      if (backdrop) {
        backdrop.parentNode.removeChild(backdrop);
      }
      document.body.classList.remove("modal-open");
    });
  });
</script>
<script>
  // Define a URL base em uma vari√°vel JavaScript
  var editarClienteBaseUrl = "{{ url_for('routes.editar_cliente', cliente_id=0) }}".replace('/0', '');

  var modalEditarCliente = document.getElementById('modalEditarCliente');
modalEditarCliente.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var clienteId = button.getAttribute('data-id');
    var nome = button.getAttribute('data-nome');
    var email = button.getAttribute('data-email');
    
    var form = modalEditarCliente.querySelector('#formEditarCliente');
    form.querySelector('#clienteNome').value = nome;
    form.querySelector('#clienteEmail').value = email;
    form.querySelector('#clienteSenha').value = ''; // Mant√©m em branco
    
    form.action = editarClienteBaseUrl + '/' + clienteId;
});
</script>


<!-- Script para buscar estados e cidades via API do IBGE -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const estadoSelect = document.getElementById('estadoSelect');
    const cidadeSelect = document.getElementById('cidadeSelect');
    const estadoFilter = "{{ estado_filter|default('') }}";
    const cidadeFilter = "{{ cidade_filter|default('') }}";

    fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados')
      .then(response => response.json())
      .then(data => {
        data.sort((a, b) => a.nome.localeCompare(b.nome));
        data.forEach(estado => {
          const option = document.createElement('option');
          option.value = estado.sigla;
          option.text = estado.nome;
          if (estado.sigla === estadoFilter) {
            option.selected = true;
          }
          estadoSelect.add(option);
        });
        if (estadoSelect.value) {
          estadoSelect.dispatchEvent(new Event('change'));
        }
      })
      .catch(error => console.error('Erro ao buscar estados:', error));

    estadoSelect.addEventListener('change', function() {
      const uf = this.value;
      cidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>';
      if (uf) {
        fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados/' + uf + '/municipios')
          .then(response => response.json())
          .then(data => {
            data.sort((a, b) => a.nome.localeCompare(b.nome));
            data.forEach(cidade => {
              const option = document.createElement('option');
              option.value = cidade.nome;
              option.text = cidade.nome;
              if (cidade.nome === cidadeFilter) {
                option.selected = true;
              }
              cidadeSelect.add(option);
            });
          })
          .catch(error => console.error('Erro ao buscar cidades:', error));
      }
    });
  });
</script>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Aguarda o carregamento da p√°gina
  document.addEventListener("DOMContentLoaded", function () {
    // Seleciona todos os alertas flash
    let alerts = document.querySelectorAll(".alert");

    alerts.forEach(function (alert) {
      // Define um tempo (5000ms = 5 segundos) para remover o alerta
      setTimeout(function () {
        alert.classList.add("fade");
        setTimeout(() => alert.remove(), 500); // Remove o alerta ap√≥s a transi√ß√£o
      }, 5000);
    });
  });
</script>
<script>
  // Seleciona o modal pelo ID
  var modalEditar = document.getElementById('modalEditarMinistrante');

  // Evento do Bootstrap disparado quando o modal vai ser exibido
  modalEditar.addEventListener('show.bs.modal', function (event) {
    // O "relatedTarget" √© o bot√£o que acionou o modal
    var button = event.relatedTarget;

    // Extrai cada data-* do bot√£o
    var id = button.getAttribute('data-id');
    var nome = button.getAttribute('data-nome');
    var formacao = button.getAttribute('data-formacao');
    var areas = button.getAttribute('data-areas');
    var cpf = button.getAttribute('data-cpf');
    var pix = button.getAttribute('data-pix');
    var cidade = button.getAttribute('data-cidade');
    var estado = button.getAttribute('data-estado');
    var email = button.getAttribute('data-email');

    // Preenche os campos no modal
    modalEditar.querySelector('#nome').value = nome;
    modalEditar.querySelector('#formacao').value = formacao;
    modalEditar.querySelector('#areas').value = areas;
    modalEditar.querySelector('#cpf').value = cpf;
    modalEditar.querySelector('#pix').value = pix;
    modalEditar.querySelector('#cidade').value = cidade;
    modalEditar.querySelector('#estado').value = estado;
    modalEditar.querySelector('#email').value = email;

    // Ajusta o action do formul√°rio para incluir o ministrante_id
    var form = modalEditar.querySelector('#formEditarMinistrante');
    var baseUrl = "{{ url_for('routes.editar_ministrante', ministrante_id=0) }}";
    form.action = baseUrl.replace('0', id);
  });
</script>

<script>
  var modalEditarParticipante = document.getElementById('modalEditarParticipante');
  modalEditarParticipante.addEventListener('show.bs.modal', function (event) {
    // Bot√£o que acionou
    var button = event.relatedTarget;

    // Extrai dados do data-*
    var id = button.getAttribute('data-id');
    var nome = button.getAttribute('data-nome');
    var cpf = button.getAttribute('data-cpf');
    var email = button.getAttribute('data-email');
    var formacao = button.getAttribute('data-formacao');

    // Preenche os campos
    modalEditarParticipante.querySelector('#nome').value = nome;
    modalEditarParticipante.querySelector('#cpf').value = cpf;
    modalEditarParticipante.querySelector('#email').value = email;
    modalEditarParticipante.querySelector('#formacao').value = formacao;
    // Senha √© opcional, deixamos em branco

    // Ajusta action do form
    var form = modalEditarParticipante.querySelector('#formEditarParticipante');
    var baseUrl = "{{ url_for('routes.editar_participante_admin', participante_id=0) }}";
    form.action = baseUrl.replace('0', id);
  });

  var modalExcluirCliente = document.getElementById('modalExcluirCliente');
  modalExcluirCliente.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var clienteId = button.getAttribute('data-id');
    
    // Atualiza o action do formul√°rio com o cliente_id correto
    var form = document.getElementById('formExcluirCliente');
    var baseUrl = "{{ url_for('routes.excluir_cliente', cliente_id=0) }}";
    form.action = baseUrl.replace('0', clienteId);
    
    // Preenche o campo hidden (opcional, mas mantemos para consist√™ncia)
    modalExcluirCliente.querySelector('#excluirClienteId').value = clienteId;
  });
</script>


<script>
  function copiarMensagem() {
    let texto = document.getElementById("textoRelatorio").value;
    navigator.clipboard.writeText(texto).then(() => {
      alert("Mensagem copiada com sucesso!");
    }).catch(err => {
      alert("Falha ao copiar: " + err);
    });
  }
  
</script>

{% block scripts_extra %}
<script>
  function enviarWhatsAppRelatorio() {
    // Obt√©m o texto do relat√≥rio
    let mensagem = document.getElementById("textoRelatorio").value;
    // Cria a URL do WhatsApp com o texto codificado
    let url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(mensagem);
    // Abre a URL em uma nova aba
    window.open(url, "_blank");
  }
</script>
{% endblock %}




{% endblock %}
