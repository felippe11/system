{% extends "base.html" %}
{% block title %}{% if evento %}{{ evento.nome }} - {% endif %}Cadastro de Participante{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/cadastro_participante.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/terms-checkbox.css') }}">

<div class="event-page-container">
    <!-- Seção do Banner do Evento -->
    {% if evento %}
    <section class="event-hero">
        {% if evento.banner_url %}
        <div class="event-banner">
            <img src="{{ evento.banner_url | media_url }}" alt="Banner do evento {{ evento.nome }}" loading="lazy">
        </div>
        {% endif %}

        <div class="event-header">
            <h1 class="event-title">{{ evento.nome }}</h1>
            <button class="cta-button" onclick="abrirModal()">
                <i class="fas fa-user-plus"></i> Inscreva-se agora
            </button>
        </div>
    </section>

    <!-- DEBUG: Seção temporária para verificar dados
    <div class="debug-section" style="background: #f0f0f0; padding: 10px; margin: 10px 0;">
        <h3>DEBUG - Dados Recebidos</h3>
        <p>Evento: {{ evento.nome if evento else 'Nenhum' }}</p>
        <p>Habilitar Lotes: {{ evento.habilitar_lotes if evento else 'Nenhum' }}</p>
        <p>Inscrição Gratuita: {{ evento.inscricao_gratuita if evento else 'Nenhum' }}</p>
        
        <h4>Tipos de Inscrição ({{ tipos_inscricao|length }})</h4>
        <ul>
            {% for lt in tipos_inscricao %}
            {% if evento and evento.habilitar_lotes %}
            <li>{{ lt.tipo_inscricao.nome }} - R$ {{ lt.preco }} (ID: {{ lt.id }})</li>
            {% else %}
            <li>{{ lt.nome }} - R$ {{ lt.preco }} (ID: {{ lt.id }})</li>
            {% endif %}
            {% else %}
            <li>Nenhum tipo de inscrição disponível</li>
            {% endfor %}
        </ul>
        
        {% if lote_vigente %}
        <h4>Lote Vigente</h4>
        <p>{{ lote_vigente.nome }} (ID: {{ lote_vigente.id }})</p>
        <p>Tipos associados: {{ lote_vigente.tipos_inscricao|length }}</p>
        {% endif %}
    </div> -->

    <!-- Seção de Informações do Evento -->
    <section class="event-details">
        {% if evento.descricao %}
        <div class="detail-card">
            <div class="detail-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="detail-content">
                <h3>Sobre o Evento</h3>
                <p>{{ evento.descricao }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Seção de Programação -->
        <div class="program-section">
            <h2 class="section-title">
                <i class="fas fa-calendar-alt"></i> Programação
                <a href="{{ url_for('routes.gerar_folder_evento', evento_id=evento.id) }}" class="download-link">
                    <i class="fas fa-file-pdf"></i> Baixar programação
                </a>
            </h2>

            <div class="schedule-container">
                {% if not sorted_keys %}
                <div class="empty-message">
                    <i class="fas fa-info-circle"></i>
                    <p>Nenhuma atividade cadastrada.</p>
                </div>
                {% else %}
                {% for data_str in sorted_keys %}
                <div class="day-schedule">
                    <h3 class="day-title">{{ data_str }}</h3>

                    <div class="activities-list">
                        {% for item in grouped_oficinas[data_str] %}
                        <div class="activity-card">
                            <div class="activity-time">
                                <span class="time">{{ item.horario_inicio }} - {{ item.horario_fim }}</span>
                                {% if item.oficina %}
                                <span class="activity-type">
                                    {{ item.oficina.tipo_oficina if item.oficina.tipo_oficina != 'outros' else
                                    item.oficina.tipo_oficina_outro }}
                                </span>
                                {% endif %}
                            </div>

                            <div class="activity-content">
                                <h4 class="activity-title">{{ item.titulo }}</h4>
                                <p class="activity-description">{{ item.descricao }}</p>

                                {% if item.ministrante or (item.oficina and item.oficina.ministrantes_associados) %}
                                <div class="speakers-container">
                                    {% if item.ministrante %}
                                    <div class="speaker-card"
                                        onclick="openSpeakerModal('{{ item.ministrante.nome }}', '{{ item.ministrante.formacao }}', '{{ (item.ministrante.foto or 'default-profile.png') | media_url }}')">
                                        <img src="{{ (item.ministrante.foto or 'default-profile.png') | media_url }}"
                                            alt="{{ item.ministrante.nome }}" class="speaker-photo"
                                            onerror="this.onerror=null;this.src='{{ 'default-profile.png' | media_url }}';">
                                        <span class="speaker-name">{{ item.ministrante.nome }}</span>
                                    </div>
                                    {% endif %}

                                    {% if item.oficina and item.oficina.ministrantes_associados %}
                                    {% for m in item.oficina.ministrantes_associados %}
                                    <div class="speaker-card"
                                        onclick="openSpeakerModal('{{ m.nome }}', '{{ m.formacao }}', '{{ (m.foto or 'default-profile.png') | media_url }}')">
                                        <img src="{{ (m.foto or 'default-profile.png') | media_url }}"
                                            alt="{{ m.nome }}" class="speaker-photo"
                                            onerror="this.onerror=null;this.src='{{ 'default-profile.png' | media_url }}';">
                                        <span class="speaker-name">{{ m.nome }}</span>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Seção de Ministrantes -->
        <div class="speakers-section">
            <h2 class="section-title">
                <i class="fas fa-chalkboard-teacher"></i> Ministrantes
            </h2>

            {% if ministrantes %}
            <div class="speakers-grid">
                {% for ministrante in ministrantes %}
                <div class="speaker-card"
                    onclick="openSpeakerModal('{{ ministrante.nome }}', '{{ ministrante.formacao }}', '{{ (ministrante.foto or 'default-profile.png') | media_url }}')">
                    <img src="{{ (ministrante.foto or 'default-profile.png') | media_url }}"
                        alt="{{ ministrante.nome }}" class="speaker-photo"
                        onerror="this.onerror=null;this.src='{{ 'default-profile.png' | media_url }}';">
                    <div class="speaker-info">
                        <h3 class="speaker-name">{{ ministrante.nome }}</h3>
                        <p class="speaker-bio">{{ ministrante.formacao }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-message">
                <i class="fas fa-info-circle"></i>
                <p>Nenhum ministrante cadastrado para este evento.</p>
            </div>
            {% endif %}
        </div>

        <!-- Seção de Localização -->
        {% if evento.localizacao %}
        <div class="location-section">
            <div class="detail-card">
                <div class="detail-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="detail-content">
                    <h3>Localização</h3>
                    <p>{{ evento.localizacao }}</p>
                    <div id="map-container" class="map-container"></div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Seção de Patrocinadores -->
        {% if evento.patrocinadores %}
        <div class="sponsors-section">
            {% set categorias = ['Realização', 'Patrocínio', 'Organização', 'Apoio'] %}

            {% for categoria in categorias %}
            {% set patrocinadores_categoria = evento.patrocinadores|selectattr("categoria", "equalto", categoria)|list
            %}
            {% if patrocinadores_categoria %}
            <div class="sponsor-category">
                <h3>{{ categoria }}</h3>
                <div class="sponsor-grid">
                    {% for pat in patrocinadores_categoria %}
                    <div class="sponsor-logo">
                        <img src="{{ pat.logo_path | media_url }}"
                            alt="Logo {{ categoria }} {{ pat.nome if pat.nome else '' }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </section>
    {% else %}
    <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <h2>Nenhum evento associado a este link</h2>
        <p>Verifique se o link está correto ou entre em contato com os organizadores.</p>
    </div>
    {% endif %}

    <!-- Modal de Cadastro -->
    <div id="cadastroModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-user-plus"></i> Complete seu cadastro
                </h2>
                <button class="close-modal" onclick="fecharModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">

                {% if evento and evento.habilitar_lotes and not lote_vigente %}
                <div class="alert-message warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Nenhum lote disponível para inscrição no momento.</span>
                </div>
                {% else %}
                <form method="POST" action="{{ url_for('inscricao_routes.cadastro_participante', identifier=token) }}"
                    id="registrationForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" id="evento_id" name="evento_id" value="{{ evento.id if evento else '' }}">

                    <div class="form-grid">
                        <!-- Dados Pessoais -->
                        <div class="form-group">
                            <label for="nome">Nome Completo</label>
                            <input type="text" id="nome" name="nome" value="{{ request.form.get('nome', '') }}"
                                placeholder="Seu nome completo" {% if obrigatorio_nome %}required{% endif %}>
                        </div>

                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00"
                                value="{{ request.form.get('cpf', '') }}" {% if obrigatorio_cpf %}required{% endif %}>
                        </div>

                        <div class="form-group">
                            <label for="email">E-mail</label>
                            <input type="email" id="email" name="email" value="{{ request.form.get('email', '') }}"
                                placeholder="seu@email.com" {% if obrigatorio_email %}required{% endif %}>
                        </div>

                        <div class="form-group">
                            <label for="senha">Senha</label>
                            <input type="password" id="senha" name="senha" placeholder="Crie uma senha segura" {% if
                                obrigatorio_senha %}required{% endif %}>
                            <small class="password-hint">Mínimo de 8 caracteres</small>
                        </div>


                        <div class="form-group full-width">
                            <label for="formacao">Formação Acadêmica</label>
                            <input type="text" id="formacao" name="formacao"
                                value="{{ request.form.get('formacao', '') }}" placeholder="Ex: Bacharel em Engenharia"
                                {% if obrigatorio_formacao %}required{% endif %}>
                        </div>

                        <!-- Campos Personalizados -->
                        {% if campos_personalizados %}
                        {% for campo in campos_personalizados %}
                        <div class="form-group{% if campo.full_width %} full-width{% endif %}">
                            <label>{{ campo.nome }}</label>
                            {% if campo.tipo == 'textarea' %}
                            <textarea name="campo_{{ campo.id }}" placeholder="Digite aqui" {% if campo.obrigatorio
                                %}required{% endif %}></textarea>
                            {% else %}
                            <input type="{{ campo.tipo }}" name="campo_{{ campo.id }}" placeholder="Digite aqui" {% if
                                campo.obrigatorio %}required{% endif %}>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}

                        <!-- Tipo de Inscrição -->
                        <div class="form-group full-width">
                            <label>Tipo de Inscrição</label>

                            {% if evento and evento.habilitar_lotes and lote_vigente %}
                            <div class="lote-info">
                                <h3>Lote Atual: {{ lote_vigente.nome }}</h3>
                                <p>Vagas: {{ lote_stats.vagas_usadas }}/{{ lote_stats.vagas_totais if
                                    lote_stats.vagas_totais !=
                                    "ilimitado" else "Ilimitadas" }}</p>
                                <p>Período: {{ lote_stats.data_inicio }} a {{ lote_stats.data_fim }}</p>
                            </div>
                            <div class="current-lote"></div>

                            <div class="ticket-options">
                                {% for lote_tipo in lote_vigente.tipos_inscricao %}
                                {% set final = preco_com_taxa(lote_tipo.preco, cliente_id) %}
                                <div class="ticket-option">
                                    <input type="radio" id="lote_tipo_{{ lote_tipo.id }}" name="lote_tipo_inscricao_id"
                                        value="{{ lote_tipo.id }}" data-lote-id="{{ lote_vigente.id }}"
                                        data-tipo-id="{{ lote_tipo.tipo_inscricao_id }}"
                                        data-preco="{{ lote_tipo.preco }}" data-preco-final="{{ final }}" required>
                                    <label for="lote_tipo_{{ lote_tipo.id }}">
                                        <span class="ticket-name">{{ lote_tipo.tipo_inscricao.nome }}{% if
                                            lote_tipo.tipo_inscricao.submission_only %} <small
                                                class="badge bg-info">Somente
                                                Submissão</small>{% endif %}</span>
                                        {% if not evento.inscricao_gratuita %}
                                        <span class="ticket-price">
                                            {% if mostrar_taxa %}
                                            R$ {{ "%.2f"|format(final) }}
                                            <small class="text-muted">(inclui R$ {{ "%.2f"|format((final|float) -
                                                (lote_tipo.preco|float)) }} de taxa)</small>
                                            {% else %}
                                            R$ {{ "%.2f"|format(final) }}
                                            {% endif %}
                                        </span>
                                        {% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" id="lote_id" name="lote_id" value="{{ lote_vigente.id }}">

                            {% elif evento and not evento.habilitar_lotes and tipos_inscricao %}
                            <div class="ticket-options">
                                {% for tipo in tipos_inscricao %}
                                {% set final = preco_com_taxa(tipo.preco, cliente_id) %}
                                <div class="ticket-option">
                                    <input type="radio" id="tipo_{{ tipo.id }}" name="tipo_inscricao_id"
                                        value="{{ tipo.id }}" data-preco="{{ tipo.preco }}"
                                        data-preco-final="{{ final }}" required>
                                    <label for="tipo_{{ tipo.id }}">
                                        <span class="ticket-name">{{ tipo.nome }}{% if tipo.submission_only %} <small
                                                class="badge bg-info">Somente Submissão</small>{% endif %}</span>
                                        {% if not evento.inscricao_gratuita %}
                                        <span class="ticket-price">
                                            {% if mostrar_taxa %}
                                            R$ {{ "%.2f"|format(final) }}
                                            <small class="text-muted">(inclui R$ {{ "%.2f"|format((final|float) -
                                                (tipo.preco|float)) }} de taxa)</small>
                                            {% else %}
                                            R$ {{ "%.2f"|format(final) }}
                                            {% endif %}
                                        </span>
                                        {% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>

                            {% elif evento and evento.inscricao_gratuita %}
                            <div class="free-registration">
                                <i class="fas fa-check-circle"></i>
                                <span>Inscrição gratuita</span>
                            </div>

                            {% if tipos_inscricao and tipos_inscricao|length > 0 %}
                            <div class="ticket-options">
                                {% for tipo in tipos_inscricao %} <div class="ticket-option">
                                    <input type="radio" id="tipo_{{ tipo.id }}" name="tipo_inscricao_id"
                                        value="{{ tipo.id }}" data-preco="0" data-preco-final="0" required>
                                    <label for="tipo_{{ tipo.id }}">
                                        <span class="ticket-name">{{ tipo.nome }}{% if tipo.submission_only %} <small
                                                class="badge bg-info">Somente Submissão</small>{% endif %}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endif %}

                            <div class="selected-ticket-display">
                                <span id="selectedTicketText">Nenhum tipo selecionado</span>
                            </div>
                        </div>

                        <!-- Endereço -->
                        <div class="form-group full-width address-group">
                            <label>Endereço</label>
                            <div id="address-fields-container">
                                <!-- Campos de endereço serão adicionados aqui via JavaScript -->
                            </div>
                            <button type="button" id="add-address-btn" class="add-button">
                                <i class="fas fa-plus"></i> Adicionar outro endereço
                            </button>
                        </div> <!-- Termos e Submissão -->
                        <div class="form-group full-width terms-group">
                            <div class="terms-checkbox" tabindex="0">
                                <input type="checkbox" id="accept-terms" name="accept_terms" required>
                                <label for="accept-terms">
                                    <div class="checkmark"></div>
                                    <div class="terms-text">Concordo com os <a
                                            href="{{ url_for('static_page_routes.show_page', slug='termos-de-uso') }}"
                                            target="_blank">Termos de Uso</a> e <a
                                            href="{{ url_for('static_page_routes.show_page', slug='privacidade') }}"
                                            target="_blank">Política de Privacidade</a></div>
                                </label>
                            </div>

                            <button type="submit" class="submit-btn">
                                <i class="fas fa-check-circle"></i> Finalizar Inscrição
                            </button>

                            <div class="login-prompt">
                                Já possui uma conta? <a href="{{ url_for('auth_routes.login') }}">Faça login aqui</a>
                            </div>
                        </div>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal de Ministrante -->
    <div id="speakerModal" class="modal">
        <div class="modal-content speaker-modal">
            <button class="close-modal" onclick="closeSpeakerModal()">
                <i class="fas fa-times"></i>
            </button>

            <div class="speaker-modal-content">
                <img id="speakerModalPhoto" src="" alt="Foto do ministrante" class="speaker-modal-photo">

                <div class="speaker-modal-info">
                    <h3 id="speakerModalName"></h3>
                    <p id="speakerModalBio"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    // Variáveis globais
    const eventoId = {% if evento %}{{ evento.id }}{% else %}null{% endif %};
    let currentLoteId = {% if lote_vigente %}{{ lote_vigente.id }}{% else %}null{% endif %};
    let loteCheckInterval = null;
    let estadosBrasil = [];
    let statesFailed = false;
    // Controle de Modais
    function abrirModal() {
        const modal = document.getElementById('cadastroModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-open');

        // Garante que o modal esteja acima da navbar
        setTimeout(() => {
            window.scrollTo(0, 0);
        }, 100);

        if (eventoId && {% if evento and evento.habilitar_lotes %} true{% else %} false{% endif %}) {
        checkCurrentLote(true);
        loteCheckInterval = setInterval(() => checkCurrentLote(false), 30000);
    }

        // Campos de endereço agora são inicializados em loadBrazilianStates()
        // if (document.getElementById('address-fields-container').children.length === 0) {
        //     addAddressField(statesFailed);
        // }
    }
    function fecharModal() {
        document.getElementById('cadastroModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.body.classList.remove('modal-open');

        if (loteCheckInterval) {
            clearInterval(loteCheckInterval);
            loteCheckInterval = null;
        }
    }

    const defaultSpeakerPhoto = "{{ 'default-profile.png' | media_url }}";

    function openSpeakerModal(name, bio, photo) {
        document.getElementById('speakerModalName').textContent = name;
        document.getElementById('speakerModalBio').textContent = bio;
        const photoEl = document.getElementById('speakerModalPhoto');
        photoEl.onerror = () => {
            photoEl.onerror = null;
            photoEl.src = defaultSpeakerPhoto;
        };
        photoEl.src = photo || defaultSpeakerPhoto;
        document.getElementById('speakerModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-open');
    }

    function closeSpeakerModal() {
        document.getElementById('speakerModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.body.classList.remove('modal-open');
    }

    // Gerenciamento de Lotes
    async function checkCurrentLote(isInitialCheck) {
        if (!eventoId) return;

        try {
            const response = await fetch(`/api/lote_vigente/${eventoId}`);
            const data = await response.json();

            if (!data.lote_id) {
                showAlert('Não há lotes disponíveis no momento.', 'warning');
                return;
            }

            if (!isInitialCheck && currentLoteId !== data.lote_id) {
                showAlert(`O lote foi atualizado para "${data.nome}". Atualizando...`, 'info');
                setTimeout(() => window.location.reload(), 3000);
            } else {
                currentLoteId = data.lote_id;
                updateLoteInfo(data);
            }
        } catch (error) {
            console.error('Erro ao verificar lote:', error);
        }
    }

    function updateLoteInfo(loteData) {
        const loteBadge = document.querySelector('.current-lote');
        if (!loteBadge) return;

        const vagasText = typeof loteData.vagas_disponiveis === 'number'
            ? `(${loteData.vagas_disponiveis} vagas restantes)`
            : '(Vagas ilimitadas)';

        const vagasElement = loteBadge.querySelector('.lote-vagas') || document.createElement('span');
        vagasElement.className = 'lote-vagas';
        vagasElement.textContent = vagasText;

        if (!loteBadge.querySelector('.lote-vagas')) {
            loteBadge.appendChild(vagasElement);
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert-message ${type}`;
        alertDiv.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' :
                type === 'danger' ? 'fa-exclamation-circle' :
                    type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        `;

        const container = document.getElementById('lote-status-container') || document.querySelector('.modal-body');
        container.prepend(alertDiv);

        setTimeout(() => {
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 500);
        }, 5000);
    }

    // Gerenciamento de Endereço
    async function loadBrazilianStates() {
        try {
            const response = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados');
            estadosBrasil = await response.json();
            estadosBrasil.sort((a, b) => a.nome.localeCompare(b.nome));

            // Adiciona o primeiro campo de endereço após carregar os estados
            addAddressField();
        } catch (error) {
            console.error('Erro ao carregar estados:', error);
            statesFailed = true;
            addAddressField(true);
            showAlert('Não foi possível carregar os estados. Informe o endereço manualmente.', 'warning');
        }
    }

    function addAddressField(useTextFields = false) {
        const container = document.getElementById('address-fields-container');
        const addressId = Date.now();

        const addressField = document.createElement('div');
        addressField.className = 'address-field';
        addressField.innerHTML = `
            <div class="address-header">
                <h4>Endereço ${container.children.length + 1}</h4>
                ${container.children.length > 0 ?
                '<button type="button" class="remove-address" onclick="removeAddressField(this)">' +
                '<i class="fas fa-times"></i></button>' : ''}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="estado_${addressId}">Estado</label>
                    ${useTextFields ?
                `<input type="text" id="estado_${addressId}" name="estados[]" placeholder="Estado">` :
                `<select id="estado_${addressId}" name="estados[]" class="state-select" required onchange="loadCities(this, 'cidade_${addressId}')">
                            <option value="">Selecione...</option>
                            ${estadosBrasil.map(estado => `<option value="${estado.sigla}">${estado.nome}</option>`).join('')}
                        </select>`}
                </div>

                <div class="form-group">
                    <label for="cidade_${addressId}">Cidade</label>
                    ${useTextFields ?
                `<input type="text" id="cidade_${addressId}" name="cidades[]" placeholder="Cidade">` :
                `<select id="cidade_${addressId}" name="cidades[]" class="city-select" disabled required>
                            <option value="">Selecione o estado primeiro</option>
                        </select>`}
                </div>
            </div>
        `;

        container.appendChild(addressField);
    }

    function removeAddressField(button) {
        button.closest('.address-field').remove();
        // Renumerar os endereços restantes
        document.querySelectorAll('.address-field h4').forEach((header, index) => {
            header.textContent = `Endereço ${index + 1}`;
        });
    }

    async function loadCities(stateSelect, citySelectId) {
        const citySelect = document.getElementById(citySelectId);
        const state = stateSelect.value;

        if (!state) {
            citySelect.innerHTML = '<option value="">Selecione o estado primeiro</option>';
            citySelect.disabled = true;
            return;
        }

        try {
            citySelect.disabled = true;
            citySelect.innerHTML = '<option value="">Carregando cidades...</option>';

            const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${state}/municipios`);
            const cidades = await response.json();

            citySelect.innerHTML = '<option value="">Selecione a cidade</option>';
            cidades.sort((a, b) => a.nome.localeCompare(b.nome))
                .forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade.nome;
                    option.textContent = cidade.nome;
                    citySelect.appendChild(option);
                });

            citySelect.disabled = false;
        } catch (error) {
            console.error('Erro ao carregar cidades:', error);
            citySelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
        }
    }

    // Mapa
    function initMap() {
        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) return;

        {% if evento and evento.latitude and evento.longitude %}
        const latitude = {{ evento.latitude }};
        const longitude = {{ evento.longitude }};
        setupMap(latitude, longitude);
    {% elif evento and evento.link_mapa %}
    try {
        const mapLink = "{{ evento.link_mapa }}";
        let coords = extractCoordsFromUrl(mapLink);

        if (coords) {
            setupMap(coords.latitude, coords.longitude);
        } else {
            geocodeAddress("{{ evento.localizacao|e if evento.localizacao else '' }}");
        }
    } catch (error) {
        console.error("Erro ao processar link do mapa:", error);
        geocodeAddress("{{ evento.localizacao|e if evento.localizacao else '' }}");
    }
    {% else %}
    geocodeAddress("{{ evento.localizacao|e if evento.localizacao else '' }}");
    {% endif %}
    }

    function extractCoordsFromUrl(url) {
        // Extrai coordenadas de URLs do Google Maps
        let match;
        if (url.includes("q=")) {
            match = url.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
        } else if (url.includes("/@")) {
            match = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
        }

        return match ? { latitude: parseFloat(match[1]), longitude: parseFloat(match[2]) } : null;
    }

    function setupMap(latitude, longitude) {
        const map = L.map('map-container').setView([latitude, longitude], 15);

        const stay22Layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/stay22/{z}/{x}/{y}{r}.png?api_key=5b05060b-8e26-4d1c-bcaa-306d76157824', {
            maxZoom: 20,
            attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a> &copy; OpenStreetMap contributors'
        }).addTo(map);

        stay22Layer.on('tileerror', function () {
            map.removeLayer(stay22Layer);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        });

        // Adiciona marcador no mapa
        const marker = L.marker([latitude, longitude]).addTo(map)
            .bindPopup(`<b>{{ evento.nome|e if evento else '' }}</b><br>{{ evento.localizacao|e if evento and evento.localizacao else '' }}`)
            .openPopup();
    }


    async function geocodeAddress(address) {
        if (!address) {
            showDefaultMap();
            return;
        }

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const data = await response.json();

            if (data && data.length > 0) {
                setupMap(parseFloat(data[0].lat), parseFloat(data[0].lon));
            } else {
                showDefaultMap();
            }
        } catch (error) {
            console.error("Erro na geocodificação:", error);
            showDefaultMap();
        }
    }

    function showDefaultMap() {
        const map = L.map('map-container').setView([-15.77972, -47.92972], 4);

        const stay22Layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/stay22/{z}/{x}/{y}{r}.png?api_key=5b05060b-8e26-4d1c-bcaa-306d76157824', {
            maxZoom: 20,
            attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a> &copy; OpenStreetMap contributors'
        }).addTo(map);

        stay22Layer.on('tileerror', function () {
            map.removeLayer(stay22Layer);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        });
    }


    // Formulário
    document.addEventListener('DOMContentLoaded', function () {
        const MOSTRAR_TAXA = {{ 'true' if mostrar_taxa else 'false' }};
        // O checkbox personalizado agora funciona nativamente com CSS

    // Máscara de CPF
    const cpfField = document.getElementById('cpf');
    if (cpfField) {
        cpfField.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3')
                .replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
            e.target.value = value.slice(0, 14);
        });
    }

    // Seleção de tipo de ingresso
    const ticketRadios = document.querySelectorAll('input[type="radio"][name^="lote_tipo"], input[type="radio"][name^="tipo_inscricao"]');
    const inscricaoGratuita = {{ 'true' if evento and evento.inscricao_gratuita else 'false' }};
    if (ticketRadios.length === 1) {
        ticketRadios[0].checked = true;
        ticketRadios[0].dispatchEvent(new Event('change'));
    } else if (ticketRadios.length === 0 && inscricaoGratuita) {
        const display = document.getElementById('selectedTicketText');
        if (display) {
            display.textContent = 'Inscrição gratuita';
        }
        updateHiddenFields({ getAttribute: () => null, value: '' });
    }
    ticketRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            if (this.checked) {
                const preco = this.getAttribute('data-preco');
                const precoFinal = this.getAttribute('data-preco-final');
                const display = document.getElementById('selectedTicketText');

                if (inscricaoGratuita) {
                    display.textContent = 'Inscrição gratuita';
                } else if (preco === "0" || precoFinal === "0") {
                    display.textContent = 'Inscrição gratuita';
                } else if (precoFinal) {
                    let txt = `Valor: R$ ${precoFinal}`;
                    if (MOSTRAR_TAXA) {
                        const diff = (parseFloat(precoFinal) - parseFloat(preco)).toFixed(2);
                        txt += ` (inclui R$ ${diff} de taxa)`;
                    }
                    display.textContent = txt;
                } else {
                    display.textContent = 'Inscrição selecionada';
                }

                // Atualizar campos ocultos
                updateHiddenFields(this);
            }
        });
    });

    // Validação do formulário
    const form = document.getElementById('registrationForm');
    if (form) {
        form.addEventListener('submit', function (e) {
            let selectedTicket = document.querySelector('input[type="radio"][name^="lote_tipo"]:checked, input[type="radio"][name^="tipo_inscricao"]:checked');
            if (!selectedTicket) {
                if (inscricaoGratuita && ticketRadios.length === 0) {
                    updateHiddenFields({ getAttribute: () => null, value: '' });
                    selectedTicket = { name: '' };
                } else {
                    e.preventDefault();
                    showAlert('Por favor, selecione um tipo de inscrição.', 'warning');
                    return false;
                }
            } const acceptTermsCheckbox = document.getElementById('accept-terms');
            if (!acceptTermsCheckbox || !acceptTermsCheckbox.checked) {
                e.preventDefault();
                showAlert('Você precisa concordar com os termos para continuar.', 'warning');
                // Destaca visualmente o checkbox
                const termsContainer = document.querySelector('.terms-checkbox');
                termsContainer.classList.add('highlight-required');
                // Foca no elemento para melhor acessibilidade
                acceptTermsCheckbox.focus();
                setTimeout(() => {
                    termsContainer.classList.remove('highlight-required');
                }, 2000);
                return false;
            }

            // Verificação adicional para lotes
            if (selectedTicket.name.startsWith('lote_tipo')) {
                const loteId = selectedTicket.getAttribute('data-lote-id');
                if (currentLoteId && currentLoteId.toString() !== loteId) {
                    e.preventDefault();
                    showAlert('O lote selecionado não está mais disponível. Atualizando informações...', 'warning');
                    setTimeout(() => window.location.reload(), 2000);
                    return false;
                }
            }
        });
    }        // Garantir que o checkbox de termos funcione corretamente
    function setupTermsCheckbox() {
        const termsBox = document.querySelector('.terms-checkbox');
        const checkbox = document.getElementById('accept-terms');
        const label = document.querySelector('.terms-checkbox label');

        if (termsBox && checkbox) {
            // Garantir que o clique no container marque o checkbox (exceto links)
            termsBox.addEventListener('click', function (e) {
                // Não mudar estado se clicou nos links
                if (e.target.tagName.toLowerCase() === 'a') {
                    return;
                }

                // Não ativar se o clique foi diretamente no checkbox ou label
                if (e.target === checkbox || e.target === label || label.contains(e.target)) {
                    return;
                }

                // Alternar o checkbox
                checkbox.checked = !checkbox.checked;

                // Disparar evento de mudança para validações
                checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            });

            // Garantir acessibilidade via teclado
            termsBox.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }
    }

    // Inicializar o checkbox
    setupTermsCheckbox();

    // Carregar estados e inicializar mapa
    loadBrazilianStates();
    if (typeof L !== 'undefined') {
        initMap();
    } else {
        console.warn('Leaflet not loaded, skipping map initialization');
    }
    });

    function updateHiddenFields(selectedOption) {
        const loteId = selectedOption.getAttribute('data-lote-id');
        const tipoId = selectedOption.getAttribute('data-tipo-id') || selectedOption.value;

        // Atualizar ou criar campo lote_id
        let loteInput = document.getElementById('lote_id');
        if (loteId) {
            if (!loteInput) {
                loteInput = document.createElement('input');
                loteInput.type = 'hidden';
                loteInput.id = 'lote_id';
                loteInput.name = 'lote_id';
                document.getElementById('registrationForm').appendChild(loteInput);
            }
            loteInput.value = loteId;
        } else if (loteInput) {
            loteInput.remove();
        }

        // Atualizar ou criar campo tipo_inscricao_id
        let tipoInput = document.getElementById('tipo_inscricao_id');
        if (!tipoInput) {
            tipoInput = document.createElement('input');
            tipoInput.type = 'hidden';
            tipoInput.id = 'tipo_inscricao_id';
            tipoInput.name = 'tipo_inscricao_id';
            document.getElementById('registrationForm').appendChild(tipoInput);
        }
        tipoInput.value = tipoId;
    }

    // Fechar o modal quando clicar fora do conteúdo
    window.addEventListener('load', function () {
        var modal = document.getElementById('cadastroModal');
        var speakerModal = document.getElementById('speakerModal');

        window.addEventListener('click', function (event) {
            if (event.target === modal) {
                fecharModal();
            } else if (event.target === speakerModal) {
                closeSpeakerModal();
            }
        });
    });
</script>
{% endblock %}
