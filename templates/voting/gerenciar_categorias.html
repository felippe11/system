{% extends "base.html" %}

{% block title %}Gerenciar Categorias - {{ voting_event.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tags"></i>
                        Gerenciar Categorias - {{ voting_event.nome }}
                    </h3>
                    <div class="card-tools">
                        <button class="btn btn-primary btn-sm" onclick="abrirModalCategoria()">
                            <i class="fas fa-plus"></i> Nova Categoria
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if categorias %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Ordem</th>
                                        <th>Nome</th>
                                        <th>Descrição</th>
                                        <th>Pontuação</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for categoria in categorias %}
                                    <tr>
                                        <td>{{ categoria.ordem }}</td>
                                        <td>{{ categoria.nome }}</td>
                                        <td>{{ categoria.descricao[:50] }}{% if categoria.descricao|length > 50 %}...{% endif %}</td>
                                        <td>{{ categoria.pontuacao_minima }} - {{ categoria.pontuacao_maxima }}</td>
                                        <td>{{ categoria.tipo_pontuacao|title }}</td>
                                        <td>
                                            {% if categoria.ativa %}
                                                <span class="badge badge-success">Ativa</span>
                                            {% else %}
                                                <span class="badge badge-secondary">Inativa</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-info" onclick="editarCategoria({{ categoria.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <a href="{{ url_for('voting_routes.gerenciar_perguntas', categoria_id=categoria.id) }}" 
                                                   class="btn btn-sm btn-primary">
                                                    <i class="fas fa-question-circle"></i> Perguntas
                                                </a>
                                                <button class="btn btn-sm btn-danger" onclick="deletarCategoria({{ categoria.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> Nenhuma categoria criada</h5>
                            <p>Clique em "Nova Categoria" para criar a primeira categoria de votação.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para criar/editar categoria -->
<div class="modal fade" id="modalCategoria" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCategoriaTitle">Nova Categoria</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formCategoria">
                    <input type="hidden" id="categoriaId" name="id">
                    <input type="hidden" id="acao" name="action" value="criar">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="nome">Nome da Categoria</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="ordem">Ordem</label>
                                <input type="number" class="form-control" id="ordem" name="ordem" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao">Descrição</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="pontuacao_minima">Pontuação Mínima</label>
                                <input type="number" class="form-control" id="pontuacao_minima" name="pontuacao_minima" 
                                       value="0" step="0.1" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="pontuacao_maxima">Pontuação Máxima</label>
                                <input type="number" class="form-control" id="pontuacao_maxima" name="pontuacao_maxima" 
                                       value="10" step="0.1" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="tipo_pontuacao">Tipo de Pontuação</label>
                                <select class="form-control" id="tipo_pontuacao" name="tipo_pontuacao">
                                    <option value="numerica">Numérica</option>
                                    <option value="escala">Escala</option>
                                    <option value="escolha_unica">Escolha Única</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarCategoria()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
function abrirModalCategoria() {
    document.getElementById('modalCategoriaTitle').textContent = 'Nova Categoria';
    document.getElementById('acao').value = 'criar';
    document.getElementById('formCategoria').reset();
    document.getElementById('categoriaId').value = '';
    $('#modalCategoria').modal('show');
}

function editarCategoria(id) {
    // Buscar dados da categoria
    fetch(`/voting/categoria/{{ voting_event.id }}`, {
        method: 'GET'
    })
    .then(response => response.text())
    .then(html => {
        // Parse HTML para extrair dados da categoria
        // Implementar busca específica da categoria
        document.getElementById('modalCategoriaTitle').textContent = 'Editar Categoria';
        document.getElementById('acao').value = 'editar';
        document.getElementById('categoriaId').value = id;
        $('#modalCategoria').modal('show');
    });
}

function salvarCategoria() {
    const formData = new FormData(document.getElementById('formCategoria'));
    const data = {
        action: formData.get('action'),
        id: formData.get('id'),
        nome: formData.get('nome'),
        descricao: formData.get('descricao'),
        ordem: parseInt(formData.get('ordem')),
        pontuacao_minima: parseFloat(formData.get('pontuacao_minima')),
        pontuacao_maxima: parseFloat(formData.get('pontuacao_maxima')),
        tipo_pontuacao: formData.get('tipo_pontuacao')
    };
    
    // Obter token CSRF
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/voting/categoria/{{ voting_event.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro interno do servidor');
    });
}

function deletarCategoria(id) {
    if (confirm('Tem certeza que deseja deletar esta categoria? Esta ação não pode ser desfeita.')) {
        const data = {
            action: 'deletar',
            id: id
        };
        
        // Obter token CSRF
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/voting/categoria/{{ voting_event.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro interno do servidor');
        });
    }
}
</script>
{% endblock %}
