{% extends "base.html" %}

{% block title %}Resultados - {{ voting_event.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-trophy"></i>
                        Resultados da Votação: {{ voting_event.nome }}
                    </h3>
                    <div class="card-tools">
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" onclick="exportarResultados('xlsx')">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="exportarResultados('pdf')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Informações do evento -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Informações do Evento</h5>
                            <p><strong>Evento:</strong> {{ voting_event.evento.nome }}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge badge-{% if voting_event.status == 'ativo' %}success{% elif voting_event.status == 'finalizado' %}secondary{% else %}warning{% endif %}">
                                    {{ voting_event.status|title }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h5>Estatísticas</h5>
                            <p><strong>Total de Votos:</strong> {{ voting_event.votes|length }}</p>
                            <p><strong>Total de Trabalhos:</strong> {{ voting_event.trabalhos|length }}</p>
                            <p><strong>Categorias:</strong> {{ voting_event.categorias|length }}</p>
                        </div>
                    </div>
                    
                    <!-- Resultados por categoria -->
                    {% for categoria_id, dados in resultados_por_categoria.items() %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-medal"></i>
                                {{ dados.categoria.nome }}
                            </h5>
                            {% if dados.categoria.descricao %}
                                <p class="card-text">{{ dados.categoria.descricao }}</p>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if dados.resultados %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Posição</th>
                                                <th>Trabalho</th>
                                                <th>Pontuação Total</th>
                                                <th>Pontuação Média</th>
                                                <th>Número de Votos</th>
                                                <th>Medalha</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for resultado in dados.resultados %}
                                            <tr class="{% if resultado.posicao_ranking == 1 %}table-warning{% elif resultado.posicao_ranking == 2 %}table-light{% elif resultado.posicao_ranking == 3 %}table-info{% endif %}">
                                                <td>
                                                    <strong>{{ resultado.posicao_ranking }}</strong>
                                                </td>
                                                <td>
                                                    <strong>{{ resultado.work.titulo }}</strong>
                                                    {% if resultado.work.autores %}
                                                        <br><small class="text-muted">{{ resultado.work.autores }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge badge-primary">{{ "%.2f"|format(resultado.pontuacao_total) }}</span>
                                                </td>
                                                <td>{{ "%.2f"|format(resultado.pontuacao_media) }}</td>
                                                <td>{{ resultado.numero_votos }}</td>
                                                <td>
                                                    {% if resultado.posicao_ranking == 1 %}
                                                        <i class="fas fa-medal text-warning" title="1º Lugar"></i>
                                                    {% elif resultado.posicao_ranking == 2 %}
                                                        <i class="fas fa-medal text-secondary" title="2º Lugar"></i>
                                                    {% elif resultado.posicao_ranking == 3 %}
                                                        <i class="fas fa-medal text-warning" style="color: #cd7f32 !important;" title="3º Lugar"></i>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pódio visual -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6>Pódio</h6>
                                        <div class="podium">
                                            {% set top3 = dados.resultados[:3] %}
                                            <div class="podium-container">
                                                {% if top3|length >= 2 %}
                                                <div class="podium-item second">
                                                    <div class="podium-number">2</div>
                                                    <div class="podium-name">{{ top3[1].work.titulo[:30] }}{% if top3[1].work.titulo|length > 30 %}...{% endif %}</div>
                                                    <div class="podium-score">{{ "%.1f"|format(top3[1].pontuacao_media) }}</div>
                                                </div>
                                                {% endif %}
                                                
                                                {% if top3|length >= 1 %}
                                                <div class="podium-item first">
                                                    <div class="podium-number">1</div>
                                                    <div class="podium-name">{{ top3[0].work.titulo[:30] }}{% if top3[0].work.titulo|length > 30 %}...{% endif %}</div>
                                                    <div class="podium-score">{{ "%.1f"|format(top3[0].pontuacao_media) }}</div>
                                                </div>
                                                {% endif %}
                                                
                                                {% if top3|length >= 3 %}
                                                <div class="podium-item third">
                                                    <div class="podium-number">3</div>
                                                    <div class="podium-name">{{ top3[2].work.titulo[:30] }}{% if top3[2].work.titulo|length > 30 %}...{% endif %}</div>
                                                    <div class="podium-score">{{ "%.1f"|format(top3[2].pontuacao_media) }}</div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Nenhum resultado disponível</h6>
                                    <p>Esta categoria ainda não possui votos registrados.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not resultados_por_categoria %}
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> Nenhum resultado disponível</h5>
                            <p>A votação ainda não possui resultados calculados.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.podium-container {
    display: flex;
    justify-content: center;
    align-items: end;
    gap: 20px;
    margin: 20px 0;
}

.podium-item {
    text-align: center;
    position: relative;
}

.podium-item.first {
    order: 2;
}

.podium-item.second {
    order: 1;
}

.podium-item.third {
    order: 3;
}

.podium-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.podium-item.first .podium-number {
    color: #ffd700;
}

.podium-item.second .podium-number {
    color: #c0c0c0;
}

.podium-item.third .podium-number {
    color: #cd7f32;
}

.podium-name {
    font-size: 0.9rem;
    font-weight: bold;
    margin-bottom: 5px;
    max-width: 150px;
    word-wrap: break-word;
}

.podium-score {
    font-size: 1.2rem;
    font-weight: bold;
    color: #007bff;
}

.table-warning {
    background-color: #fff3cd !important;
}

.table-light {
    background-color: #f8f9fa !important;
}

.table-info {
    background-color: #d1ecf1 !important;
}
</style>

<script>
function exportarResultados(formato) {
    const url = `{{ url_for('voting_routes.exportar_resultados', voting_event_id=voting_event.id, formato='FORMATO') }}`.replace('FORMATO', formato);
    window.open(url, '_blank');
}

// Atualizar resultados em tempo real se habilitado
{% if voting_event.exibir_resultados_tempo_real %}
setInterval(function() {
    fetch('{{ url_for("voting_routes.resultados_tempo_real", voting_event_id=voting_event.id) }}')
    .then(response => response.json())
    .then(data => {
        // Atualizar dados na página
        console.log('Resultados atualizados:', data);
    })
    .catch(error => {
        console.error('Erro ao atualizar resultados:', error);
    });
}, 30000); // Atualizar a cada 30 segundos
{% endif %}
</script>
{% endblock %}
