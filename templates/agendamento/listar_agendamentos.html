{% extends "base.html" %}
{% block title %}Agendamentos{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- BREADCRUMB -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard_routes.dashboard') }}"><i class="bi bi-house"></i> Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard_routes.dashboard_agendamentos') }}">Agendamentos</a></li>
      <li class="breadcrumb-item active" aria-current="page">Lista</li>
    </ol>
  </nav>

  <!-- CABEÇALHO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-calendar-check me-2"></i>
        Lista de Agendamentos
      </h2>
      <p class="text-muted mb-0">Visualize e gerencie todos os agendamentos</p>
    </div>
    <div class="d-flex gap-2">
      {% if current_user.tipo in ['admin', 'cliente', 'ministrante'] %}
      <a href="{{ url_for('agendamento_routes.criar_agendamento') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i> Novo Agendamento
      </a>
      {% endif %}
      <a href="{{ url_for('dashboard_routes.dashboard_agendamentos') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Filtros</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('agendamento_routes.listar_agendamentos') }}">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="data_inicio" class="form-label">Data Inicial</label>
            <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                  value="{{ request.args.get('data_inicio', '') }}">
          </div>
          <div class="col-md-4">
            <label for="data_fim" class="form-label">Data Final</label>
            <input type="date" class="form-control" id="data_fim" name="data_fim"
                  value="{{ request.args.get('data_fim', '') }}">
          </div>
          <div class="col-md-4">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="">Todos</option>
              <option value="pendente" {% if request.args.get('status') == 'pendente' %}selected{% endif %}>Pendente</option>
              <option value="confirmado" {% if request.args.get('status') == 'confirmado' %}selected{% endif %}>Confirmado</option>
              <option value="cancelado" {% if request.args.get('status') == 'cancelado' %}selected{% endif %}>Cancelado</option>
              <option value="realizado" {% if request.args.get('status') == 'realizado' %}selected{% endif %}>Realizado</option>
            </select>
          </div>
          {% if current_user.tipo == 'admin' or current_user.tipo == 'cliente' %}
          <div class="col-md-4">
            <label for="participante" class="form-label">Participante</label>
            <select class="form-select" id="participante" name="participante_id">
              <option value="">Todos os Participantes</option>
              {% for participante in participantes %}
                <option value="{{ participante.id }}" {% if request.args.get('participante_id')|string == participante.id|string %}selected{% endif %}>
                  {{ participante.nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          {% if current_user.tipo == 'admin' %}
          <div class="col-md-4">
            <label for="cliente" class="form-label">Cliente</label>
            <select class="form-select" id="cliente" name="cliente_id">
              <option value="">Todos os Clientes</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}" {% if request.args.get('cliente_id')|string == cliente.id|string %}selected{% endif %}>
                  {{ cliente.nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <div class="col-md-4">
            <label for="oficina" class="form-label">Oficina</label>
            <select class="form-select" id="oficina" name="oficina_id">
              <option value="">Todas as Oficinas</option>
              {% for oficina in oficinas %}
                <option value="{{ oficina.id }}" {% if request.args.get('oficina_id')|string == oficina.id|string %}selected{% endif %}>
                  {{ oficina.titulo }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="evento" class="form-label">Evento</label>
            <select class="form-select" id="evento" name="evento_id">
              <option value="">Todos os Eventos</option>
              {% for evento in eventos %}
                <option value="{{ evento.id }}" {% if request.args.get('evento_id')|string == evento.id|string %}selected{% endif %}>
                  {{ evento.nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-funnel-fill me-1"></i>Filtrar
            </button>
            <a href="{{ url_for('agendamento_routes.listar_agendamentos') }}" class="btn btn-outline-secondary">Limpar</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Ações em Lote -->
  {% if current_user.tipo in ['admin', 'cliente'] %}
  <div class="card shadow-sm mb-3" id="acoes-lote" style="display: none;">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-bold">Ações em Lote:</span>
          <span id="contador-selecionados" class="badge bg-primary ms-2">0 selecionados</span>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-success btn-sm" onclick="confirmarLote()">
            <i class="bi bi-check-circle me-1"></i> Confirmar Selecionados
          </button>
          <button type="button" class="btn btn-danger btn-sm" onclick="cancelarLote()">
            <i class="bi bi-x-circle me-1"></i> Cancelar Selecionados
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparSelecao()">
            <i class="bi bi-arrow-clockwise me-1"></i> Limpar Seleção
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Tabela de Agendamentos -->
  <div class="card shadow">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-table me-2"></i>Resultados</h5>
      <div class="btn-group">
        <a href="{{ url_for('agendamento_routes.exportar_agendamentos_pdf') }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-file-pdf me-1"></i> PDF
        </a>
        <a href="{{ url_for('agendamento_routes.exportar_agendamentos_csv') }}" class="btn btn-sm btn-outline-success">
          <i class="bi bi-file-excel me-1"></i> CSV
        </a>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              {% if current_user.tipo in ['admin', 'cliente'] %}
              <th width="50">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                  <label class="form-check-label" for="selectAll"></label>
                </div>
              </th>
              {% endif %}
              <th>ID</th>
              <th>Data</th>
              <th>Horário</th>
              <th>Oficina</th>
              <th>Professor</th>
              <th>Status</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% if agendamentos %}
              {% for agendamento in agendamentos %}
                <tr>
                  {% if current_user.tipo in ['admin', 'cliente'] %}
                  <td>
                    {% if agendamento.status in ['pendente', 'confirmado'] %}
                    <div class="form-check">
                      <input class="form-check-input agendamento-checkbox" type="checkbox" 
                             value="{{ agendamento.id }}" 
                             id="agendamento_{{ agendamento.id }}"
                             onchange="updateSelectionCounter()">
                      <label class="form-check-label" for="agendamento_{{ agendamento.id }}"></label>
                    </div>
                    {% endif %}
                  </td>
                  {% endif %}
                  <td>{{ agendamento.id }}</td>
                  <td>{{ agendamento.horario.data.strftime('%d/%m/%Y') }}</td>
                  <td>{{ agendamento.horario.horario_inicio }} - {{ agendamento.horario.horario_fim }}</td>
                  <td>{{ agendamento.horario.evento.titulo }}</td>
                  <td>{{ agendamento.professor.nome if agendamento.professor else '-' }}</td>
                  <td>
                    {% set status_badges = {
                      'pendente': 'warning',
                      'confirmado': 'success',
                      'cancelado': 'danger',
                      'realizado': 'primary'
                    } %}
                    {% set status_badge = status_badges.get(agendamento.status, 'secondary') %}
                    <span class="badge bg-{{ status_badge }}">{{ agendamento.status|capitalize }}</span>
                  </td>
                  <td class="text-center">
                      <div class="btn-group btn-group-sm">
                          {% if current_user.tipo == 'admin' or current_user.id == agendamento.professor_id %}
                            <a href="{{ url_for('agendamento_routes.visualizar_agendamento', agendamento_id=agendamento.id) }}"
                               class="btn btn-outline-info" data-bs-toggle="tooltip" title="Visualizar">
                              <i class="bi bi-eye"></i>
                            </a>
                          {% endif %}

                          {% if current_user.is_admin or current_user.id == agendamento.professor_id or
                                (current_user.tipo == 'cliente' and current_user.id == agendamento.horario.evento.cliente_id) %}
                            <a href="{{ url_for('agendamento_routes.qrcode_agendamento', agendamento_id=agendamento.id) }}"
                               class="btn btn-outline-secondary"
                               data-bs-toggle="tooltip" title="Gerar QR Code / Check-in">
                              <i class="bi bi-qr-code"></i>
                            </a>
                          {% endif %}

                        {% if current_user.tipo in ['admin', 'cliente'] or
                              current_user.id == agendamento.professor_id %}
                          <a href="{{ url_for('agendamento_routes.editar_agendamento', agendamento_id=agendamento.id) }}"
                             class="btn btn-outline-warning" data-bs-toggle="tooltip" title="Editar">
                          <i class="bi bi-pencil"></i>
                        </a>
                      {% endif %}
                      
                      {% if current_user.is_admin
                            or current_user.id == agendamento.professor_id
                            or (current_user.tipo == 'cliente'
                                and current_user.id == agendamento.horario.evento.cliente_id) %}
                        <form action="{{ url_for('agendamento_routes.atualizar_status_agendamento', agendamento_id=agendamento.id) }}"
                              method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja cancelar este agendamento?');">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="status" value="cancelado">
                          <button type="submit" class="btn btn-outline-danger" data-bs-toggle="tooltip" title="Cancelar">
                            <i class="bi bi-x-circle"></i>
                          </button>
                        </form>
                      {% endif %}

                      {% if current_user.is_admin or current_user.id == agendamento.professor_id or
                            (current_user.tipo == 'cliente' and current_user.id == agendamento.horario.evento.cliente_id) %}
                        <form action="{{ url_for('agendamento_routes.atualizar_status_agendamento', agendamento_id=agendamento.id) }}"
                              method="post" class="d-inline" onsubmit="return confirm('Deseja confirmar este agendamento?');">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="status" value="confirmado">
                          <button type="submit" class="btn btn-outline-success" data-bs-toggle="tooltip" title="Confirmar">
                            <i class="bi bi-check-circle"></i>
                          </button>
                        </form>
                      {% endif %}


                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{{ '8' if current_user.tipo in ['admin', 'cliente'] else '7' }}" class="text-center py-4">
                  <div class="text-muted">
                    <i class="bi bi-calendar-x fs-4 d-block mb-2"></i>
                    Nenhum agendamento encontrado.
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Paginação, se aplicável -->
    {% if pagination and pagination.pages > 1 %}
    <div class="card-footer">
      {% set args_without_page = request.args.copy() %}
      {% set _ = args_without_page.pop('page', None) %}
      <nav aria-label="Navegação de páginas">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item {{ 'disabled' if pagination.page == 1 else '' }}">
            <a class="page-link" href="{{ url_for('agendamento_routes.listar_agendamentos', page=pagination.page-1, **args_without_page) if pagination.page > 1 else '#' }}">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          
          {% for p in range(1, pagination.pages + 1) %}
            {% if p >= pagination.page - 2 and p <= pagination.page + 2 %}
              <li class="page-item {{ 'active' if p == pagination.page else '' }}">
                <a class="page-link" href="{{ url_for('agendamento_routes.listar_agendamentos', page=p, **args_without_page) }}">
                  {{ p }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
          
          <li class="page-item {{ 'disabled' if pagination.page == pagination.pages else '' }}">
            <a class="page-link" href="{{ url_for('agendamento_routes.listar_agendamentos', page=pagination.page+1, **args_without_page) if pagination.page < pagination.pages else '#' }}">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<script>
  // Inicializar tooltips do Bootstrap
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(el) {
      return new bootstrap.Tooltip(el);
    });
  });

  // Funções para seleção múltipla
  function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.agendamento-checkbox');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectionCounter();
  }

  function updateSelectionCounter() {
    const checkboxes = document.querySelectorAll('.agendamento-checkbox:checked');
    const counter = document.getElementById('contador-selecionados');
    const acoesLote = document.getElementById('acoes-lote');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    const count = checkboxes.length;
    counter.textContent = count + ' selecionados';
    
    // Mostrar/ocultar painel de ações em lote
    if (count > 0) {
      acoesLote.style.display = 'block';
    } else {
      acoesLote.style.display = 'none';
    }
    
    // Atualizar estado do checkbox "Selecionar Todos"
    const totalCheckboxes = document.querySelectorAll('.agendamento-checkbox').length;
    if (count === 0) {
      selectAllCheckbox.indeterminate = false;
      selectAllCheckbox.checked = false;
    } else if (count === totalCheckboxes) {
      selectAllCheckbox.indeterminate = false;
      selectAllCheckbox.checked = true;
    } else {
      selectAllCheckbox.indeterminate = true;
    }
  }

  function limparSelecao() {
    const checkboxes = document.querySelectorAll('.agendamento-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
    
    updateSelectionCounter();
  }

  function confirmarLote() {
    const checkboxes = document.querySelectorAll('.agendamento-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) {
      alert('Nenhum agendamento selecionado.');
      return;
    }
    
    if (confirm(`Deseja confirmar ${ids.length} agendamento(s) selecionado(s)?`)) {
      processarLote(ids, 'confirmado');
    }
  }

  function cancelarLote() {
    const checkboxes = document.querySelectorAll('.agendamento-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) {
      alert('Nenhum agendamento selecionado.');
      return;
    }
    
    if (confirm(`Deseja cancelar ${ids.length} agendamento(s) selecionado(s)?`)) {
      processarLote(ids, 'cancelado');
    }
  }

  function processarLote(ids, status) {
    // Criar formulário dinâmico para envio
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("agendamento_routes.processar_lote_agendamentos") }}';
    
    // CSRF Token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    form.appendChild(csrfInput);
    
    // Status
    const statusInput = document.createElement('input');
    statusInput.type = 'hidden';
    statusInput.name = 'status';
    statusInput.value = status;
    form.appendChild(statusInput);
    
    // IDs dos agendamentos
    ids.forEach(id => {
      const idInput = document.createElement('input');
      idInput.type = 'hidden';
      idInput.name = 'agendamento_ids';
      idInput.value = id;
      form.appendChild(idInput);
    });
    
    // Adicionar ao DOM e submeter
    document.body.appendChild(form);
    form.submit();
  }
</script>
{% endblock %}
