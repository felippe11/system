{% extends "base.html" %}
{% block title %}Dashboard de Agendamentos{% endblock %}

{% block content %}
<div class="container-fluid px-0 mt-0">

  <!-- BREADCRUMB -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard_routes.dashboard') }}"><i class="bi bi-house"></i> Dashboard</a></li>
      <li class="breadcrumb-item active" aria-current="page">Agendamentos</li>
    </ol>
  </nav>

  <!-- TÍTULO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 fw-bold text-primary mb-1">
        <i class="bi bi-calendar2-week me-2"></i>Dashboard de Agendamentos
      </h1>
      <p class="text-muted mb-0">Gerencie todos os aspectos dos seus agendamentos de visitas</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('dashboard_routes.dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Voltar
      </a>
    </div>
  </div>

  <!-- Card Principal que contém as abas -->
  <div class="card shadow">
    <div class="card-body p-0">
      <!-- Abas (Nav Tabs) -->
      <ul class="nav nav-tabs nav-justified" id="agendamentoTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="resumo-tab" data-bs-toggle="tab"
                  data-bs-target="#resumo" type="button">
            <i class="bi bi-bar-chart-fill me-1"></i> Resumo
          </button>
        </li>

        <!-- <li class="nav-item" role="presentation">
          <button class="nav-link" id="criar-tab" data-bs-toggle="tab"
                  data-bs-target="#criar" type="button">
            <i class="bi bi-plus-circle me-1"></i> Criar
          </button>
        </li> -->
        <!-- <li class="nav-item" role="presentation">
          <button class="nav-link" id="configuracoes-tab" data-bs-toggle="tab"
                  data-bs-target="#configuracoes" type="button">
            <i class="bi bi-gear-fill me-1"></i> Configurações
          </button>
        </li> -->
      </ul>

      <!-- Conteúdo das Abas -->
      <div class="tab-content p-4">

        <!-- ABA 1: RESUMO -->
        <div class="tab-pane fade show active" id="resumo" role="tabpanel">
          <!-- Painel de estatísticas em cards -->
          <div class="row g-4 mb-4">
            <div class="col-12 col-md-6 col-lg-3">
              <div class="card stat-card bg-primary-gradient text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-subtitle mb-2">Total de Eventos</h5>
                      <h2 class="card-title mb-0">{{ total_eventos_com_agendamentos if total_eventos_com_agendamentos is defined else (eventos_cliente|length if eventos_cliente else 0) }}</h2>
                    </div>
                    <i class="bi bi-calendar-event fs-1 opacity-25"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <div class="card stat-card bg-info-gradient text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-subtitle mb-2">Agendamentos</h5>
                      <h2 class="card-title mb-0">{{ agendamentos_totais or 0 }}</h2>
                    </div>
                    <i class="bi bi-calendar-check fs-1 opacity-25"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <div class="card stat-card bg-warning-gradient text-dark">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-subtitle mb-2">Visitantes</h5>
                      <h2 class="card-title mb-0">{{ total_visitantes or 0 }}</h2>
                    </div>
                    <i class="bi bi-people fs-1 opacity-25"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <div class="card stat-card bg-success-gradient text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-subtitle mb-2">Ocupação Média</h5>
                      <h2 class="card-title mb-0">{{ (ocupacao_media or 0)|round(1) }}%</h2>
                    </div>
                    <i class="bi bi-graph-up fs-1 opacity-25"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cards de Gerenciamento -->
          <div class="row g-4 mb-4">
            <div class="col-md-3">
              <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                  <i class="bi bi-calendar-event"></i> Seus Eventos
                </div>
                <div class="card-body text-center">
                  <h3 class="text-primary">{{ eventos_cliente|length if eventos_cliente else 0 }}</h3>
                  <p class="text-muted mb-3">Total de eventos</p>
                  <a href="{{ url_for('agendamento_routes.eventos_agendamento') }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-eye me-1"></i> Ver Todos
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                  <i class="bi bi-play-circle"></i> Ativos
                </div>
                <div class="card-body text-center">
                  <h3 class="text-success">{{ eventos_ativos|length if eventos_ativos else 0 }}</h3>
                  <p class="text-muted mb-3">Eventos ativos</p>
                  <a href="{{ url_for('agendamento_routes.eventos_agendamento') }}?status=ativo" class="btn btn-success btn-sm">
                    <i class="bi bi-eye me-1"></i> Ver Ativos
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card shadow h-100">
                <div class="card-header bg-info text-white">
                  <i class="bi bi-calendar-plus"></i> Futuros
                </div>
                <div class="card-body text-center">
                  <h3 class="text-info">{{ eventos_futuros|length if eventos_futuros else 0 }}</h3>
                  <p class="text-muted mb-3">Eventos futuros</p>
                  <a href="{{ url_for('agendamento_routes.eventos_agendamento') }}?status=futuro" class="btn btn-info btn-sm">
                    <i class="bi bi-eye me-1"></i> Ver Futuros
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card shadow h-100">
                <div class="card-header bg-secondary text-white">
                  <i class="bi bi-stop-circle"></i> Encerrados
                </div>
                <div class="card-body text-center">
                  <h3 class="text-secondary">{{ eventos_encerrados|length if eventos_encerrados else 0 }}</h3>
                  <p class="text-muted mb-3">Eventos encerrados</p>
                  <a href="{{ url_for('agendamento_routes.eventos_agendamento') }}?status=encerrado" class="btn btn-secondary btn-sm">
                    <i class="bi bi-eye me-1"></i> Ver Encerrados
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Material de Apoio -->
          <div class="row g-4 mb-4">
            <div class="col-12">
              <div class="card shadow border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);">
                  <h5 class="m-0 fw-bold"><i class="bi bi-heart-pulse me-2"></i>Material de Apoio</h5>
                </div>
                <div class="card-body p-4">
                  <p class="text-muted mb-4">Gerencie os materiais de apoio disponíveis para alunos PCD/Neurodivergentes.</p>
                  
                  <div class="table-responsive mb-4">
                    <table class="table table-hover align-middle" id="materiaisTable">
                      <thead class="table-light">
                        <tr>
                          <th>Nome</th>
                          <th>Descrição</th>
                          <th>Status</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tbody id="materiaisTableBody">
                        <!-- Conteúdo carregado via JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  
                  <button type="button" class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#modalMaterialApoio">
                    <i class="bi bi-plus-circle me-2"></i> Adicionar Material de Apoio
                  </button>
                  
                  <div class="card bg-light">
                    <div class="card-body small">
                      <p class="mb-1"><i class="bi bi-info-circle me-2"></i><strong>Dica:</strong></p>
                      <p class="mb-0 text-muted">Configure materiais de apoio que podem ser solicitados durante o cadastro de alunos com necessidades especiais.</p>
                    </div>
                  </div>
                </div>
                <div class="card-footer bg-light text-center border-0">
                  <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Materiais para inclusão e acessibilidade</small>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-8">
              <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                  <i class="bi bi-calendar2-week"></i> Visão Geral de Agendamentos
                </div>
                <div class="card-body">
                  <div class="row">
                    <!-- Agendamentos Hoje -->
                    <div class="col-md-6 mb-3">
                      <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                          <i class="bi bi-calendar-day"></i> Agendamentos Hoje
                        </div>
                        <div class="card-body">
                          {% if todos_agendamentos_hoje %}
                            <div class="list-group">
                              {% for agendamento in todos_agendamentos_hoje %}
                                <a href="{{ url_for('agendamento_routes.detalhes_agendamento', agendamento_id=agendamento.id) }}" class="list-group-item list-group-item-action">
                                  <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ agendamento.escola_nome }}</h5>
                                    <small>{{ agendamento.horario.horario_inicio.strftime('%H:%M') }}</small>
                                  </div>
                                  <p class="mb-1">{{ agendamento.turma }} - {{ agendamento.quantidade_alunos }} alunos</p>
                                  <small>
                                    <span class="badge bg-info">{{ agendamento.horario.evento.nome }}</span>
                                    {% if agendamento.checkin_realizado %}
                                      <span class="badge bg-success">Check-in realizado</span>
                                    {% else %}
                                      <span class="badge bg-warning text-dark">Aguardando check-in</span>
                                    {% endif %}
                                    <!-- Mostrar contato e email para status específicos -->
                                    {% if agendamento.status in ['pendente', 'cancelado', 'confirmado'] %}
                                      <br><small class="text-muted">{{ agendamento.contato_responsavel }} - {{ agendamento.email_responsavel }}</small>
                                    {% endif %}
                                  </small>
                                </a>
                              {% endfor %}
                            </div>
                          {% else %}
                            <div class="alert alert-info">
                              <i class="bi bi-info-circle"></i> Não há agendamentos para hoje.
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <!-- Próximos Agendamentos -->
                    <div class="col-md-6 mb-3">
                      <div class="card h-100">
                        <div class="card-header bg-success text-white">
                          <i class="bi bi-calendar-week"></i> Próximos Agendamentos
                        </div>
                        <div class="card-body">
                          {% if agendamentos_futuros %}
                            <div class="list-group">
                              {% for agendamento in agendamentos_futuros %}
                                <a href="{{ url_for('agendamento_routes.detalhes_agendamento', agendamento_id=agendamento.id) }}" class="list-group-item list-group-item-action">
                                  <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ agendamento.escola_nome }}</h5>
                                    <small>{{ agendamento.horario.data.strftime('%d/%m/%Y') }}</small>
                                  </div>
                                  <p class="mb-1">{{ agendamento.turma }} - {{ agendamento.quantidade_alunos }} alunos</p>
                                  <small>
                                    <span class="badge bg-info">{{ agendamento.horario.evento.nome }}</span>
                                    <span class="badge bg-secondary">{{ agendamento.horario.horario_inicio.strftime('%H:%M') }}</span>
                                    <!-- Mostrar contato e email para status específicos -->
                                    {% if agendamento.status in ['pendente', 'cancelado', 'confirmado'] %}
                                      <br><small class="text-muted">{{ agendamento.contato_responsavel }} - {{ agendamento.email_responsavel }}</small>
                                    {% endif %}
                                  </small>
                                </a>
                              {% endfor %}
                            </div>
                          {% else %}
                            <div class="alert alert-info">
                              <i class="bi bi-info-circle"></i> Não há agendamentos futuros configurados.
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <!-- Sistema de Agendamentos -->
              <div class="card shadow mb-4 border-0">
                <div class="card-header bg-primary text-white">
                  <h5 class="m-0 fw-bold"><i class="bi bi-calendar-event me-2"></i>Sistema de Agendamentos</h5>
                </div>
                <div class="card-body p-4">
                  <div class="d-grid gap-3">
                    <a href="{{ url_for('agendamento_routes.checkin_qr_agendamento') }}" class="btn btn-outline-primary">
                      <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                          <i class="bi bi-qr-code-scan text-primary"></i>
                        </div>
                        <div class="text-start">
                          <h6 class="mb-1 fw-semibold">Check-in QR Code</h6>
                          <small class="text-muted">Realize check-in rápido via QR Code</small>
                        </div>
                      </div>
                    </a>
                    
                    <a href="{{ url_for('agendamento_routes.relatorio_geral_agendamentos') }}" class="btn btn-outline-success">
                      <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                          <i class="bi bi-file-earmark-bar-graph text-success"></i>
                        </div>
                        <div class="text-start">
                          <h6 class="mb-1 fw-semibold">Relatório Geral</h6>
                          <small class="text-muted">Estatísticas e relatórios completos</small>
                        </div>
                      </div>
                    </a>
                  </div>
                  
                  <div class="card bg-light mt-3">
                    <div class="card-body small">
                      <p class="mb-1"><i class="bi bi-info-circle me-2"></i><strong>Dica:</strong></p>
                      <p class="mb-0 text-muted">Use o QR Code para check-ins rápidos e gere relatórios para análise detalhada.</p>
                    </div>
                  </div>
                </div>
                <div class="card-footer bg-light text-center border-0">
                  <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Ferramentas essenciais do sistema</small>
                </div>
              </div>
              
              <!-- Estatísticas Rápidas -->
              <div class="card shadow mb-4 border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">
                  <h5 class="mb-0 fw-bold"><i class="bi bi-graph-up me-2"></i>Estatísticas Rápidas</h5>
                </div>
                <div class="card-body p-4">
                  <div class="mb-4">
                    <div class="d-flex align-items-center mb-3">
                      <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                        <i class="bi bi-pie-chart text-primary"></i>
                      </div>
                      <h6 class="mb-0 fw-semibold">Agendamentos por Status</h6>
                    </div>
                    <div class="progress rounded-pill" style="height: 25px;">
                      {% if agendamentos_totais and agendamentos_totais > 0 %}
                        {% set porcentagem_confirmados = (agendamentos_confirmados / agendamentos_totais) * 100 %}
                        {% set porcentagem_realizados = (agendamentos_realizados / agendamentos_totais) * 100 %}
                        {% set porcentagem_cancelados = (agendamentos_cancelados / agendamentos_totais) * 100 %}
                        
                        <div class="progress-bar bg-primary rounded-pill" role="progressbar" style="width: {{ porcentagem_confirmados }}%;" title="Confirmados: {{ agendamentos_confirmados }}">
                          {{ agendamentos_confirmados }}
                        </div>
                        <div class="progress-bar bg-success rounded-pill" role="progressbar" style="width: {{ porcentagem_realizados }}%;" title="Realizados: {{ agendamentos_realizados }}">
                          {{ agendamentos_realizados }}
                        </div>
                        <div class="progress-bar bg-danger rounded-pill" role="progressbar" style="width: {{ porcentagem_cancelados }}%;" title="Cancelados: {{ agendamentos_cancelados }}">
                          {{ agendamentos_cancelados }}
                        </div>
                      {% else %}
                        <div class="progress-bar rounded-pill" role="progressbar" style="width: 0%;">
                          Sem dados
                        </div>
                      {% endif %}
                    </div>
                    <div class="d-flex justify-content-between mt-2 small">
                      <span class="text-primary fw-medium"><i class="bi bi-circle-fill me-1"></i>Confirmados</span>
                      <span class="text-success fw-medium"><i class="bi bi-circle-fill me-1"></i>Realizados</span>
                      <span class="text-danger fw-medium"><i class="bi bi-circle-fill me-1"></i>Cancelados</span>
                    </div>
                  </div>
                  
                  {% if ocupacao_media is defined %}
                    <div class="mb-4">
                      <div class="d-flex align-items-center mb-3">
                        <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                          <i class="bi bi-speedometer2 text-info"></i>
                        </div>
                        <h6 class="mb-0 fw-semibold">Ocupação Média</h6>
                      </div>
                      <div class="text-center mb-3">
                        <div class="h3 fw-bold text-info mb-2">{{ ocupacao_media|round(1) }}%</div>
                        <div class="progress rounded-pill" style="height: 8px;">
                          <div class="progress-bar {% if ocupacao_media < 50 %}bg-warning{% elif ocupacao_media < 80 %}bg-success{% else %}bg-danger{% endif %} rounded-pill" 
                               role="progressbar" style="width: {{ ocupacao_media }}%;">
                          </div>
                        </div>
                      </div>
                      <div class="text-center">
                        <small class="text-muted"><i class="bi bi-calendar-range me-1"></i>Baseado nos últimos 30 dias</small>
                      </div>
                    </div>
                  {% endif %}
                  
                  <a href="{{ url_for('agendamento_routes.relatorio_geral_agendamentos') }}" class="btn btn-outline-primary w-100">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Relatório
                  </a>
                </div>
                <div class="card-footer bg-light text-center border-0">
                  <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Dados atualizados em tempo real</small>
                </div>
              </div>
            </div>
          </div>
        </div><!-- /ABA 1: RESUMO -->



        <!-- ABA 3: CRIAR -->
        <!-- <div class="tab-pane fade" id="criar" role="tabpanel">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="card shadow">
                <div class="card-header bg-success text-white">
                  <h5 class="m-0 fw-bold"><i class="bi bi-plus-circle me-2"></i>Criar Novo</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-3">
                    <a href="{{ url_for('agendamento_routes.criar_agendamento') }}" class="btn btn-primary btn-lg">
                      <i class="bi bi-calendar-plus me-2"></i> Criar Novo Agendamento
                    </a>
                    
                    <a href="{{ url_for('agendamento_routes.configurar_horarios_agendamento') }}" class="btn btn-info btn-lg">
                      <i class="bi bi-clock me-2"></i> Configurar Horários
                    </a>
                    
                    <a href="{{ url_for('agendamento_routes.criar_evento_agendamento') }}" class="btn btn-success btn-lg">
                      <i class="bi bi-calendar-event me-2"></i> Criar Evento para Agendamento
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card shadow">
                <div class="card-header bg-info text-white">
                  <h5 class="m-0 fw-bold"><i class="bi bi-tools me-2"></i>Ferramentas</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-3">
                    <a href="{{ url_for('agendamento_routes.checkin_qr_agendamento') }}" class="btn btn-dark btn-lg">
                      <i class="bi bi-qr-code-scan me-2"></i> Check-in com QR Code
                    </a>
                    
                    <a href="{{ url_for('agendamento_routes.importar_agendamentos') }}" class="btn btn-primary btn-lg">
                      <i class="bi bi-upload me-2"></i> Importar Agendamentos
                    </a>

                    <a href="{{ url_for('agendamento_routes.professor_eventos_disponiveis') }}" class="btn btn-primary">
                      <i class="bi bi-calendar-event me-2"></i> Ver Eventos Disponíveis
                  </a>
                    
                    <div class="card bg-light">
                      <div class="card-body small">
                        <p class="mb-1"><i class="bi bi-info-circle me-2"></i><strong>Dica:</strong></p>
                        <p class="mb-0 text-muted">Configure horários antes de criar novos agendamentos para facilitar o processo.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> --> <!-- /ABA 3: CRIAR -->

        <!-- Materiais de Apoio -->
        <div class="tab-pane fade" id="configuracoes" role="tabpanel">
          <div class="row g-4">
            <div class="col-md-8 mx-auto">
              <div class="card shadow">
                <div class="card-header bg-info text-white">
                  <h5 class="m-0 fw-bold"><i class="bi bi-heart-pulse me-2"></i>Materiais de Apoio</h5>
                </div>
                <div class="card-body">
                  <p class="text-muted mb-3">Gerencie os materiais de apoio disponíveis para alunos PCD/Neurodivergentes.</p>
                  
                  <div class="table-responsive mb-3">
                    <table class="table table-hover align-middle" id="materiaisTable">
                      <thead class="table-light">
                        <tr>
                          <th>Nome</th>
                          <th>Descrição</th>
                          <th>Status</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tbody id="materiaisTableBody">
                        <!-- Conteúdo carregado via JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  
                  <button type="button" class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#modalMaterialApoio">
                    <i class="bi bi-plus-circle me-2"></i> Adicionar Material de Apoio
                  </button>
                  
                  <div class="card bg-light">
                    <div class="card-body small">
                      <p class="mb-1"><i class="bi bi-info-circle me-2"></i><strong>Dica:</strong></p>
                      <p class="mb-0 text-muted">Configure materiais de apoio que podem ser solicitados durante o cadastro de alunos com necessidades especiais.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- /Materiais de Apoio -->
      </div><!-- /tab-content -->
    </div><!-- /card-body -->
  </div><!-- /card shadow -->
</div> <!-- /container-fluid -->

<!-- Modal para Materiais de Apoio -->
<div class="modal fade" id="modalMaterialApoio" tabindex="-1" aria-labelledby="modalMaterialApoioLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalMaterialApoioLabel">Adicionar Material de Apoio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formMaterialApoio">
        <div class="modal-body">
          <input type="hidden" id="materialId" name="id">
          <div class="mb-3">
            <label for="materialNome" class="form-label">Nome do Material</label>
            <input type="text" class="form-control" id="materialNome" name="nome" required>
          </div>
          <div class="mb-3">
            <label for="materialDescricao" class="form-label">Descrição</label>
            <textarea class="form-control" id="materialDescricao" name="descricao" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="materialAtivo" name="ativo" checked>
              <label class="form-check-label" for="materialAtivo">
                Material ativo
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Estilos CSS -->
<style>
.stat-card {
  border: none;
  border-radius: 1rem;
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.bg-primary-gradient {
  background: linear-gradient(135deg, #0094c3 0%, #4cd175 100%);
}

.bg-info-gradient {
  background: linear-gradient(135deg, #00b4d8 0%, #48cae4 100%);
}

.bg-warning-gradient {
  background: linear-gradient(135deg, #ffd60a 0%, #ffc300 100%);
}

.bg-danger-gradient {
  background: linear-gradient(135deg, #d00000 0%, #dc2f02 100%);
}

.bg-success-gradient {
  background: linear-gradient(135deg, #38b000 0%, #70e000 100%);
}

.nav-tabs .nav-link {
  font-weight: 500;
  border: none;
  color: #6c757d;
  padding: 1rem 2rem;
}

.nav-tabs .nav-link.active {
  color: #0094c3;
  border-bottom: 3px solid #0094c3;
  background: transparent;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 148, 195, 0.05);
}
</style>

<!-- Scripts -->
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
// Inicializar as tabs programaticamente
document.addEventListener("DOMContentLoaded", function() {
  // Verificar se há um hash na URL
  if (window.location.hash) {
    // Se houver, ativar a tab correspondente
    const hash = window.location.hash;
    const tabId = hash.substring(1); // Remover o caractere '#'
    const tab = document.querySelector(`#agendamentoTabs button[data-bs-target="#${tabId}"]`);
    if (tab) {
      new bootstrap.Tab(tab).show();
    }
  }
  
  // Adicionar evento para atualizar URL quando tab é alterada
  const tabs = document.querySelectorAll('#agendamentoTabs button');
  tabs.forEach(tab => {
    tab.addEventListener('shown.bs.tab', function(event) {
      const targetId = event.target.getAttribute('data-bs-target').substring(1);
      history.replaceState(null, null, `#${targetId}`);
    });
  });

  // Configurar botões de toggle
  const toggleButtons = [
    document.getElementById('btnToggleAgendamentoPublico'),
    document.getElementById('btnToggleAprovacaoManual'),
    document.getElementById('btnToggleLimiteCapacidade')
  ];

  toggleButtons.forEach(button => {
    if (!button) return;
    const toggleUrl = button.dataset.toggleUrl;

    button.addEventListener('click', function() {
      fetch(toggleUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          atualizarBotao(button, data.value);
        } else {
          alert("Falha ao atualizar: " + data.message);
        }
      })
      .catch(err => {
        alert("Erro na requisição: " + err);
      });
    });
  });

  // Carregar materiais de apoio quando a aba de configurações for ativada
  const configTab = document.getElementById('configuracoes-tab');
  if (configTab) {
    configTab.addEventListener('shown.bs.tab', function() {
      carregarMateriaisApoio();
    });
  }

  // Configurar formulário de material de apoio
  const formMaterialApoio = document.getElementById('formMaterialApoio');
  if (formMaterialApoio) {
    formMaterialApoio.addEventListener('submit', function(e) {
      e.preventDefault();
      salvarMaterialApoio();
    });
  }

});

// Funções para gerenciar materiais de apoio
function carregarMateriaisApoio() {
  fetch('/api/materiais-apoio-admin')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        renderizarMateriaisApoio(data.materiais);
      } else {
        console.error('Erro ao carregar materiais:', data.error);
      }
    })
    .catch(error => {
      console.error('Erro na requisição:', error);
    });
}

function renderizarMateriaisApoio(materiais) {
  const tbody = document.getElementById('materiaisTableBody');
  if (!tbody) return;
  
  if (materiais.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum material de apoio cadastrado.</td></tr>';
    return;
  }
  
  tbody.innerHTML = materiais.map(material => `
    <tr>
      <td>${material.nome}</td>
      <td>${material.descricao}</td>
      <td>
        <span class="badge bg-${material.ativo ? 'success' : 'danger'}">
          ${material.ativo ? 'Ativo' : 'Inativo'}
        </span>
      </td>
      <td>
        <div class="btn-group btn-group-sm">
          <button type="button" class="btn btn-warning" onclick="editarMaterial(${material.id})">
            <i class="bi bi-pencil"></i>
          </button>
          <button type="button" class="btn btn-${material.ativo ? 'danger' : 'success'}" onclick="toggleMaterialStatus(${material.id})">
            <i class="bi bi-${material.ativo ? 'x-circle' : 'check-circle'}"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

function salvarMaterialApoio() {
  const form = document.getElementById('formMaterialApoio');
  const formData = new FormData(form);
  
  const data = {
    id: formData.get('id') || null,
    nome: formData.get('nome'),
    descricao: formData.get('descricao'),
    ativo: formData.get('ativo') === 'on'
  };
  
  const url = data.id ? `/api/materiais-apoio-admin/${data.id}` : '/api/materiais-apoio-admin';
  const method = data.id ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('modalMaterialApoio')).hide();
      carregarMateriaisApoio();
      form.reset();
      document.getElementById('materialId').value = '';
      document.getElementById('modalMaterialApoioLabel').textContent = 'Adicionar Material de Apoio';
    } else {
      alert('Erro ao salvar material: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erro na requisição:', error);
    alert('Erro na requisição. Tente novamente.');
  });
}

function editarMaterial(id) {
  fetch(`/api/materiais-apoio-admin/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const material = data.material;
        document.getElementById('materialId').value = material.id;
        document.getElementById('materialNome').value = material.nome;
        document.getElementById('materialDescricao').value = material.descricao;
        document.getElementById('materialAtivo').checked = material.ativo;
        document.getElementById('modalMaterialApoioLabel').textContent = 'Editar Material de Apoio';
        
        new bootstrap.Modal(document.getElementById('modalMaterialApoio')).show();
      } else {
        alert('Erro ao carregar material: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro na requisição:', error);
      alert('Erro na requisição. Tente novamente.');
    });
}

function toggleMaterialStatus(id) {
  fetch(`/api/materiais-apoio-admin/${id}/toggle`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      carregarMateriaisApoio();
    } else {
      alert('Erro ao alterar status: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erro na requisição:', error);
    alert('Erro na requisição. Tente novamente.');
  });
}

// Funções auxiliares
function atualizarBotao(btn, valorAtivo) {
  if (!btn) return;
  if (valorAtivo) {
    btn.classList.remove("btn-danger");
    btn.classList.add("btn-success");
    btn.textContent = "Ativo";
  } else {
    btn.classList.remove("btn-success");
    btn.classList.add("btn-danger");
    btn.textContent = "Desativado";
  }
}

// Função para alternar o status do período de agendamento
function togglePeriodoStatus(periodoId) {
  fetch(`/api/periodos/${periodoId}/toggle`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Requested-With": "XMLHttpRequest",
      "X-CSRFToken": csrfToken
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert("Falha ao atualizar o status: " + data.message);
    }
  })
  .catch(error => {
    console.error("Erro ao alternar status:", error);
    alert("Erro na requisição. Tente novamente.");
  });
}
</script>
{% endblock %}
