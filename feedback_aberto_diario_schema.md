# Estrutura SQL - Feedback Aberto Diario

SQL (PostgreSQL) para criar a estrutura necessaria do Feedback Aberto Diario.

```sql
-- Enum para tipos de perguntas do feedback aberto
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'tipoperguntafeedbackaberto') THEN
        CREATE TYPE tipoperguntafeedbackaberto AS ENUM (
            'TEXTO_LIVRE',
            'MULTIPLA_ESCOLHA',
            'MULTIPLA_ESCOLHA_MULTIPLA',
            'ESCALA_NUMERICA',
            'SIM_NAO',
            'EMAIL',
            'TELEFONE',
            'DATA',
            'NUMERO'
        );
    END IF;
END
$$;

CREATE TABLE IF NOT EXISTS public.feedback_aberto_dias (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    cliente_id INTEGER NOT NULL,
    data DATE NOT NULL,
    titulo VARCHAR(255),
    token VARCHAR(64) NOT NULL,
    ativa BOOLEAN,
    exigir_nome BOOLEAN,
    exigir_email BOOLEAN,
    exigir_telefone BOOLEAN,
    exigir_identificador BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    CONSTRAINT fk_feedback_aberto_dias_cliente_id_cliente
        FOREIGN KEY (cliente_id) REFERENCES public.cliente (id),
    CONSTRAINT uq_feedback_aberto_cliente_data
        UNIQUE (cliente_id, data),
    CONSTRAINT uq_feedback_aberto_dias_token
        UNIQUE (token)
);

CREATE TABLE IF NOT EXISTS public.feedback_aberto_perguntas (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    cliente_id INTEGER NOT NULL,
    titulo VARCHAR(255) NOT NULL,
    descricao TEXT,
    tipo tipoperguntafeedbackaberto NOT NULL,
    opcoes TEXT,
    obrigatoria BOOLEAN,
    ordem INTEGER,
    ativa BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    CONSTRAINT fk_feedback_aberto_perguntas_cliente_id_cliente
        FOREIGN KEY (cliente_id) REFERENCES public.cliente (id)
);

CREATE TABLE IF NOT EXISTS public.feedback_aberto_dia_perguntas (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dia_id INTEGER NOT NULL,
    pergunta_id INTEGER NOT NULL,
    ordem INTEGER,
    CONSTRAINT fk_feedback_aberto_dia_perguntas_dia_id_feedback_aberto_dias
        FOREIGN KEY (dia_id) REFERENCES public.feedback_aberto_dias (id),
    CONSTRAINT fk_feedback_aberto_dia_perguntas_pergunta_id_feedback_aberto_perguntas
        FOREIGN KEY (pergunta_id) REFERENCES public.feedback_aberto_perguntas (id),
    CONSTRAINT uq_feedback_aberto_dia_pergunta
        UNIQUE (dia_id, pergunta_id)
);

CREATE TABLE IF NOT EXISTS public.feedback_aberto_envios (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dia_id INTEGER NOT NULL,
    nome VARCHAR(255),
    email VARCHAR(255),
    telefone VARCHAR(64),
    identificador VARCHAR(120),
    ip_origem VARCHAR(64),
    user_agent VARCHAR(255),
    created_at TIMESTAMP,
    CONSTRAINT fk_feedback_aberto_envios_dia_id_feedback_aberto_dias
        FOREIGN KEY (dia_id) REFERENCES public.feedback_aberto_dias (id)
);

CREATE TABLE IF NOT EXISTS public.feedback_aberto_respostas (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    envio_id INTEGER NOT NULL,
    pergunta_id INTEGER NOT NULL,
    resposta_texto TEXT,
    resposta_numerica INTEGER,
    resposta_escolha VARCHAR(255),
    created_at TIMESTAMP,
    CONSTRAINT fk_feedback_aberto_respostas_envio_id_feedback_aberto_envios
        FOREIGN KEY (envio_id) REFERENCES public.feedback_aberto_envios (id),
    CONSTRAINT fk_feedback_aberto_respostas_pergunta_id_feedback_aberto_perguntas
        FOREIGN KEY (pergunta_id) REFERENCES public.feedback_aberto_perguntas (id)
);
```
